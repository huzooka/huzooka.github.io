<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
<title>Link-triggered Content Update by Ajax with Fallback Route and Access Check | HuZooka</title>
<meta name="generator" content="Jekyll v4.2.2">
<meta property="og:title" content="Link-triggered Content Update by Ajax with Fallback Route and Access Check">
<meta name="author" content="Zoltán Horváth">
<meta property="og:locale" content="en_US">
<meta name="description" content="Load Disqus comments only after user clicks on a link.">
<meta property="og:description" content="Load Disqus comments only after user clicks on a link.">
<link rel="canonical" href="https://huzooka.github.io/development/2019/02/28/update-page-with-ajax.html">
<meta property="og:url" content="https://huzooka.github.io/development/2019/02/28/update-page-with-ajax.html">
<meta property="og:site_name" content="HuZooka">
<meta property="og:image" content="https://huzooka.github.io/simple.png">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2019-02-28T07:17:11+00:00">
<meta name="twitter:card" content="summary_large_image">
<meta property="twitter:image" content="https://huzooka.github.io/simple.png">
<meta property="twitter:title" content="Link-triggered Content Update by Ajax with Fallback Route and Access Check">
<meta name="twitter:site" content="@huzooka">
<meta name="twitter:creator" content="@huzooka">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Zoltán Horváth"},"dateModified":"2019-02-28T07:17:11+00:00","datePublished":"2019-02-28T07:17:11+00:00","description":"Load Disqus comments only after user clicks on a link.","headline":"Link-triggered Content Update by Ajax with Fallback Route and Access Check","image":"https://huzooka.github.io/simple.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://huzooka.github.io/development/2019/02/28/update-page-with-ajax.html"},"url":"https://huzooka.github.io/development/2019/02/28/update-page-with-ajax.html"}</script>

<link rel="stylesheet" href="/assets/main.css?f3f2fc8c">
<link type="application/atom+xml" rel="alternate" href="https://huzooka.github.io/feed.xml" title="HuZooka">
<link rel="icon" href="/favicon.ico?b6c405af" type="image/vnd.microsoft.icon">
    <link rel="preload" href="/assets/texb-875-125.woff2" as="font" type="font/woff2" crossorigin="anonymous">
    <link rel="preload" href="/assets/charissilr.woff2" as="font" type="font/woff2" crossorigin="anonymous">
    <link rel="preload" href="/assets/charissilb.woff2" as="font" type="font/woff2" crossorigin="anonymous">
</head>
<body>
<header class="site-header">

    <div class="wrapper">
<a class="site-title h3" rel="author" href="/">
            <span class="logo logo--header"></span>HuZooka
        </a><nav class="site-nav">
            <input type="checkbox" id="nav-trigger" class="nav-trigger">
            <label for="nav-trigger" class="menu-icon">
                <span class="menu-icon__bar"></span>
                <span class="menu-icon__bar"></span>
                <span class="menu-icon__bar"></span>
            </label>

            <div class="trigger">
<a class="nav-link h5" href="/about/">About</a><a class="nav-link h5" href="https://huzooka.github.io/tag/drupal">Drupal</a><a class="nav-link h5" href="https://huzooka.github.io/tag/migration">Migration</a>
</div>
        </nav>
</div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

    <header class="post-header">
        <h1 class="post-title p-name" itemprop="name headline">Link-triggered Content Update by Ajax with Fallback Route and Access Check</h1>

        <p class="postmeta">
            <time class="dt-published" datetime="2019-02-28T07:17:11+00:00" itemprop="datePublished">February 28, 2019
            </time>• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Zoltán Horváth</span></span></p>
    </header>

    <div class="post-content e-content rhythm-onehalf" itemprop="articleBody">
        <p class="lead">Although Drupal provides a built-in comment system, I use Disqus Comments on this site for commenting. Disqus is a good-enough choice if you need a comment system with moderation and spam detection while you don’t want to store personal information; but sadly it has some <a href="https://disqus.com/home/discussion/channel-discussdisqus/bug_reports_feedback_performance_improvements/" target="_blank" rel="noopener noreferrer">performance issues</a>. To keep the site as fast as possible, I decided that I will show the comments only if the user clicks a “Show comments” button.</p>

<p>In this article I will use the example of the Disqus formatter used on this page to show you how to update the page content with <a href="https://www.drupal.org/docs/8/api/ajax-api" target="_blank" rel="noopener noreferrer">Drupal’s Ajax API</a> while the content remains accessible even when the user’s browser doesn’t have (or does not use) JavaScript interpretation.</p>

<h2 id="the-concept">The concept</h2>

<p>We will create a new field formatter for the field provided by the <a href="https://www.drupal.org/project/disqus" target="_blank" rel="noopener noreferrer">Disqus module</a> that renders an Ajax-capable link. If the user clicks on this link, we will update the current page with the Disqus-comments by returning an Ajax response. When the user does not have Javascript or the link is opened in a new browser tab, we will provide a fallback route where the comments are shown without any additional interaction.</p>

<p>We need:</p>

<ul>
  <li>New route for every entity that has Disqus comment fields</li>
  <li>A controller for the new route that returns Ajax response for Ajax requests and a renderable array for non-js requests</li>
  <li>A field formatter that outputs only the ajax-capable link to the new route</li>
  <li>And of course, for these, we need a module as well. I will be using the name <code class="language-plaintext highlighter-rouge">field_tools</code>.</li>
</ul>

<h2 id="the-implementation">The implementation</h2>

<h3 id="route-subscriber">Route subscriber</h3>

<p>For providing the needed route for entities with Disqus comment fields, we will create a route subscriber service. In this route subscriber we will use the <code class="language-plaintext highlighter-rouge">entity_type.manager</code> and the <code class="language-plaintext highlighter-rouge">disqus.manager</code> services for getting the Disqus comment fields of each entity type, so we will have to list them as arguments.</p>

<p>Put this into the <code class="language-plaintext highlighter-rouge">field_tools/field_tools.services.yml</code> file:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td>
<td class="rouge-code"><pre><span class="na">services</span><span class="pi">:</span>
  <span class="na">field_tools.subscriber</span><span class="pi">:</span>
    <span class="na">class</span><span class="pi">:</span> <span class="s">Drupal\field_tools\Routing\RouteSubscriber</span>
    <span class="na">arguments</span><span class="pi">:</span> 
      <span class="pi">-</span> <span class="s1">'</span><span class="s">@entity_type.manager'</span>
      <span class="pi">-</span> <span class="s1">'</span><span class="s">@disqus.manager'</span>
    <span class="na">tags</span><span class="pi">:</span> <span class="pi">[{</span> <span class="nv">name</span><span class="pi">:</span> <span class="nv">event_subscriber</span> <span class="pi">}]</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<p>Try to be generic: we want to cover as many cases as possible, so we will provide routes for any fieldable entity and not just for nodes. Keep in mind that an entity may have an unlimited number of Disqus fields. Because of these, we will use this path pattern: <code class="language-plaintext highlighter-rouge">/[entity_type_id]/[entity_id]/[field_name]/[nojs|ajax]</code>. For example, for node 123, this will be turned into <code class="language-plaintext highlighter-rouge">/node/123/discus_comments/nojs</code> if the Discus field’s machine name of that node type is <code class="language-plaintext highlighter-rouge">discus_comments</code>.</p>

<p>Let’s create the class of the route subscriber in <code class="language-plaintext highlighter-rouge">field_tools/src/Routing/RouteSubscriber.php</code>:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
</pre></td>
<td class="rouge-code"><pre><span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">Drupal\field_tools\Routing</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Drupal\Core\Entity\ContentEntityTypeInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Entity\EntityTypeInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Entity\EntityTypeManagerInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Routing\RouteSubscriberBase</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Routing\RoutingEvents</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\disqus\DisqusCommentManagerInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Symfony\Component\Routing\Route</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Symfony\Component\Routing\RouteCollection</span><span class="p">;</span>

<span class="cd">/**
 * Subscriber for entity routes.
 *
 * Provides route for Disqus comment fields of every fieldable entity.
 */</span>
<span class="kd">class</span> <span class="nc">RouteSubscriber</span> <span class="kd">extends</span> <span class="nc">RouteSubscriberBase</span> <span class="p">{</span>

  <span class="cd">/**
   * The entity type manager.
   *
   * @var \Drupal\Core\Entity\EntityTypeManagerInterface
   */</span>
  <span class="k">protected</span> <span class="nv">$entityTypeManager</span><span class="p">;</span>

  <span class="cd">/**
   * The Disqus comment manager.
   *
   * @var \Drupal\disqus\DisqusCommentManagerInterface
   */</span>
  <span class="k">protected</span> <span class="nv">$disqusCommentManager</span><span class="p">;</span>

  <span class="cd">/**
   * Constructs an SftRouteSubscriber object.
   *
   * @param \Drupal\Core\Entity\EntityTypeManagerInterface $entity_type_manager
   *   The entity type manager.
   * @param \Drupal\disqus\DisqusCommentManagerInterface $disqus_comment_manager
   *   The Disqus comment manager.
   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">EntityTypeManagerInterface</span> <span class="nv">$entity_type_manager</span><span class="p">,</span> <span class="kt">DisqusCommentManagerInterface</span> <span class="nv">$disqus_comment_manager</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">entityTypeManager</span> <span class="o">=</span> <span class="nv">$entity_type_manager</span><span class="p">;</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">disqusCommentManager</span> <span class="o">=</span> <span class="nv">$disqus_comment_manager</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cd">/**
   * {@inheritdoc}
   */</span>
  <span class="k">protected</span> <span class="k">function</span> <span class="n">alterRoutes</span><span class="p">(</span><span class="kt">RouteCollection</span> <span class="nv">$collection</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$entity_type_definitions</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">entityTypeManager</span><span class="o">-&gt;</span><span class="nf">getDefinitions</span><span class="p">();</span>

    <span class="c1">// Collecting content entity types which have canonical link template.</span>
    <span class="nv">$content_entity_type_filter</span> <span class="o">=</span> <span class="k">function</span> <span class="p">(</span><span class="kt">EntityTypeInterface</span> <span class="nv">$entity_type_definition</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span>
        <span class="p">(</span><span class="nv">$entity_type_definition</span> <span class="k">instanceof</span> <span class="nc">ContentEntityTypeInterface</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="nv">$entity_type_definition</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_ui_base_route'</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="nv">$valid_content_entity_types</span> <span class="o">=</span> <span class="nb">array_filter</span><span class="p">(</span><span class="nv">$entity_type_definitions</span><span class="p">,</span> <span class="nv">$content_entity_type_filter</span><span class="p">);</span>

    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$valid_content_entity_types</span> <span class="k">as</span> <span class="nv">$entity_type_id</span> <span class="o">=&gt;</span> <span class="nv">$entity_type</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">foreach</span> <span class="p">(</span><span class="nb">array_keys</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">disqusCommentManager</span><span class="o">-&gt;</span><span class="nf">getFields</span><span class="p">(</span><span class="nv">$entity_type_id</span><span class="p">))</span> <span class="k">as</span> <span class="nv">$field_name</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$route</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Route</span><span class="p">(</span>
          <span class="s2">"/</span><span class="nv">$entity_type_id</span><span class="s2">/</span><span class="si">{</span><span class="nv">entity}/$field_name/{js</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
          <span class="p">[</span>
            <span class="s1">'_controller'</span> <span class="o">=&gt;</span> <span class="s1">'\Drupal\field_tools\Controller\DisqusCommentsController::entityWithComments'</span><span class="p">,</span>
            <span class="s1">'_title'</span> <span class="o">=&gt;</span> <span class="s1">'Comments'</span><span class="p">,</span>
            <span class="s1">'entity_type'</span> <span class="o">=&gt;</span> <span class="nv">$entity_type_id</span><span class="p">,</span>
            <span class="s1">'field_name'</span> <span class="o">=&gt;</span> <span class="nv">$field_name</span><span class="p">,</span>
          <span class="p">],</span>
          <span class="p">[</span>
            <span class="s1">'_permission'</span> <span class="o">=&gt;</span> <span class="s1">'view disqus comments'</span><span class="p">,</span>
            <span class="s1">'_entity_access'</span> <span class="o">=&gt;</span> <span class="s1">'entity.view'</span><span class="p">,</span>
            <span class="s1">'_custom_access'</span> <span class="o">=&gt;</span> <span class="s1">'\Drupal\field_tools\Controller\DisqusCommentsController::commentAccess'</span><span class="p">,</span>
            <span class="s1">'js'</span> <span class="o">=&gt;</span> <span class="s1">'nojs|ajax'</span><span class="p">,</span>
          <span class="p">],</span>
          <span class="p">[</span>
            <span class="s1">'parameters'</span> <span class="o">=&gt;</span> <span class="p">[</span>
              <span class="s1">'entity'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="s1">'entity:'</span> <span class="mf">.</span> <span class="nv">$entity_type_id</span><span class="p">,</span>
              <span class="p">],</span>
            <span class="p">],</span>
          <span class="p">]</span>
        <span class="p">);</span>
        <span class="nv">$route_name</span> <span class="o">=</span> <span class="s2">"entity.</span><span class="nv">$entity_type_id</span><span class="s2">.</span><span class="nv">$field_name</span><span class="s2">"</span><span class="p">;</span>
        <span class="nv">$collection</span><span class="o">-&gt;</span><span class="nf">add</span><span class="p">(</span><span class="nv">$route_name</span><span class="p">,</span> <span class="nv">$route</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="cd">/**
   * {@inheritdoc}
   */</span>
  <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">getSubscribedEvents</span><span class="p">()</span> <span class="p">{</span>
    <span class="nv">$events</span> <span class="o">=</span> <span class="k">parent</span><span class="o">::</span><span class="nf">getSubscribedEvents</span><span class="p">();</span>
    <span class="c1">// Ensure to run after the entity resolver subscriber. Therefore priority -176.</span>
    <span class="c1">// @see \Drupal\Core\EventSubscriber\EntityRouteAlterSubscriber</span>
    <span class="nv">$events</span><span class="p">[</span><span class="nc">RoutingEvents</span><span class="o">::</span><span class="no">ALTER</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'onAlterRoutes'</span><span class="p">,</span> <span class="o">-</span><span class="mi">176</span><span class="p">];</span>
    <span class="k">return</span> <span class="nv">$events</span><span class="p">;</span>
  <span class="p">}</span>

<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<p>Here we add a new route for every entity type that implements <code class="language-plaintext highlighter-rouge">ContentEntityTypeInterface</code> and has a Disqus comment field. Our event subscriber should be called after entity routes are built, so we will need a bit <a href="https://symfony.com/doc/3.4/components/event_dispatcher.html#connecting-listeners" target="_blank" rel="noopener noreferrer">lower priority than <code class="language-plaintext highlighter-rouge">EntityRouteAlterSubscriber</code> has</a>.</p>

<h3 id="controller">Controller</h3>

<p>Now we will create our new route’s controller <code class="language-plaintext highlighter-rouge">field_tools/src/Controller/DisqusCommentsController.php</code>. We will use the <code class="language-plaintext highlighter-rouge">entityDisqusComment</code> method for rendering both the Ajax and the no-JS response.</p>

<p>Because of the previous route definition we will have four parameters on this method:</p>

<ul>
  <li>The <code class="language-plaintext highlighter-rouge">$entity_type</code> (from route defaults) that is the entity type ID (e.g. <code class="language-plaintext highlighter-rouge">node</code>).</li>
  <li>The <code class="language-plaintext highlighter-rouge">$entity</code> (route slug) that will be resolved to a content entity object.</li>
  <li>The <code class="language-plaintext highlighter-rouge">$js</code> (route slug) that will be <code class="language-plaintext highlighter-rouge">'ajax'</code> on Ajax requests or <code class="language-plaintext highlighter-rouge">'nojs'</code> otherwise.</li>
  <li>The <code class="language-plaintext highlighter-rouge">$field_name</code> (from route defaults) that will be the name of a Disqus comment field.</li>
  <li>You can see that the order of these parameters is irrelevant: only the name of the variable and its type hinting has to match.</li>
</ul>

<p>In the controller we will check that the field exists on the entity and has the expected type, then we will return the renderable array of the field (based on the request type):</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
</pre></td>
<td class="rouge-code"><pre><span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">Drupal\field_tools\Controller</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Drupal\Component\Utility\Html</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Access\AccessResult</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Ajax\AjaxResponse</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Ajax\ReplaceCommand</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Controller\ControllerBase</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Entity\EntityInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Symfony\Component\HttpKernel\Exception\NotFoundHttpException</span><span class="p">;</span>

<span class="cd">/**
 * Controller routines for disqus comment routes.
 */</span>
<span class="kd">class</span> <span class="nc">DisqusCommentsController</span> <span class="kd">extends</span> <span class="nc">ControllerBase</span> <span class="p">{</span>

  <span class="cd">/**
   * Provides the disqus comments markup.
   *
   * This controller assumes that it is only invoked for users with the needed
   * permission.
   *
   * @param string $entity_type
   *   The entity type.
   * @param \Drupal\Core\Entity\EntityInterface $entity
   *   The entity object.
   * @param string $js
   *   If this is an Ajax request, it will be the string 'ajax'. Otherwise, it will
   *   be 'nojs'. This determines the response type.
   * @param string $field_name
   *   The name of the disqus comment field.
   *
   * @return array|\Drupal\Core\Ajax\AjaxResponse
   *   The field content as renderable array or as Ajax response.
   *
   * @throws \Symfony\Component\HttpKernel\Exception\NotFoundHttpException
   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="n">entityWithComments</span><span class="p">(</span><span class="nv">$entity_type</span><span class="p">,</span> <span class="kt">EntityInterface</span> <span class="nv">$entity</span><span class="p">,</span> <span class="nv">$js</span> <span class="o">=</span> <span class="s1">'nojs'</span><span class="p">,</span> <span class="nv">$field_name</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$build</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$entity</span><span class="o">-&gt;</span><span class="nf">isNew</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">empty</span><span class="p">(</span><span class="nv">$field_name</span><span class="p">))</span> <span class="p">{</span>
      <span class="nv">$build</span> <span class="o">=</span> <span class="nv">$entity</span><span class="o">-&gt;</span><span class="nv">$field_name</span><span class="o">-&gt;</span><span class="nf">view</span><span class="p">([</span>
        <span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="s1">'disqus_comment'</span><span class="p">,</span>
        <span class="s1">'label'</span> <span class="o">=&gt;</span> <span class="s1">'hidden'</span><span class="p">,</span>
        <span class="s1">'settings'</span> <span class="o">=&gt;</span> <span class="p">[],</span>
      <span class="p">]);</span>
    <span class="p">}</span>

    <span class="k">switch</span> <span class="p">(</span><span class="nv">$js</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="s1">'ajax'</span><span class="o">:</span>
        <span class="nv">$response</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AjaxResponse</span><span class="p">();</span>
        <span class="nv">$unique_id</span> <span class="o">=</span> <span class="nc">Html</span><span class="o">::</span><span class="nf">getClass</span><span class="p">(</span><span class="nb">implode</span><span class="p">(</span><span class="s1">'--'</span><span class="p">,</span> <span class="p">[</span>
          <span class="nv">$entity_type</span><span class="p">,</span>
          <span class="nv">$entity</span><span class="o">-&gt;</span><span class="nf">id</span><span class="p">(),</span>
          <span class="nv">$field_name</span> <span class="o">??</span> <span class="s1">'no-field'</span><span class="p">,</span>
        <span class="p">]));</span>
        <span class="nv">$response</span><span class="o">-&gt;</span><span class="nf">addCommand</span><span class="p">(</span><span class="k">new</span> <span class="nc">ReplaceCommand</span><span class="p">(</span><span class="s1">'[data-field-tools-disqus-id="'</span> <span class="mf">.</span> <span class="nv">$unique_id</span> <span class="mf">.</span> <span class="s1">'"]'</span><span class="p">,</span> <span class="nv">$build</span><span class="p">));</span>
        <span class="k">return</span> <span class="nv">$response</span><span class="p">;</span>

      <span class="k">default</span><span class="o">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">empty</span><span class="p">(</span><span class="nv">$build</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nc">NotFoundHttpException</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="nv">$build</span><span class="p">[</span><span class="s1">'#title'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Comments on %title'</span><span class="p">,</span> <span class="p">[</span>
          <span class="s1">'%title'</span> <span class="o">=&gt;</span> <span class="nv">$entity</span><span class="o">-&gt;</span><span class="nf">label</span><span class="p">(),</span>
        <span class="p">]);</span>
        <span class="k">return</span> <span class="nv">$build</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<p>Note that the Ajax <code class="language-plaintext highlighter-rouge">ReplaceCommand</code> will replace the element that has the <code class="language-plaintext highlighter-rouge">data-field-tools-disqus-id</code> attribute with the matching value. So for node 123 with <code class="language-plaintext highlighter-rouge">discus_comments</code> field, the replaced element should be:</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
</pre></td>
<td class="rouge-code"><pre><span class="nt">&lt;element</span> <span class="na">data-field-tools-disqus-id=</span><span class="s">"node--123--discus-comments"</span> <span class="nt">/&gt;</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<p>Later on, in the field formatter, we will have to add this to the renderable array.</p>

<p>Besides this we will also define a custom access callback for the route also. We won’t be able to rely on the entity’s access results because the Disqus comment field can be disabled while the entity itself can be accessed or the user does not have the <code class="language-plaintext highlighter-rouge">'view disqus comments'</code> permission. So we will have to check the field value (it is a boolean) and deny access if any of the next condition matches:</p>

<ul>
  <li>The entity cannot be viewed by the user.</li>
  <li>The Disqus comment field’s value is boolean <code class="language-plaintext highlighter-rouge">FALSE</code>.</li>
  <li>User does not have the <code class="language-plaintext highlighter-rouge">'view disqus comments'</code> permission.</li>
</ul>

<p>The first one is already verified by the <code class="language-plaintext highlighter-rouge">_entity_access</code> service on the route: we only have to cover the next two cases:</p>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">::commentFieldAccessible</code> will check the field value and return with boolean <code class="language-plaintext highlighter-rouge">TRUE</code> or <code class="language-plaintext highlighter-rouge">FALSE</code>.</li>
  <li>The <code class="language-plaintext highlighter-rouge">::commentAccess</code> method will do the same but return the equivalent <code class="language-plaintext highlighter-rouge">AccessResultInterface</code> object.</li>
</ul>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre></td>
<td class="rouge-code"><pre><span class="cd">/**
 * Determines whether comments are enabled and can be accessed.
 *
 * @param \Drupal\Core\Entity\EntityInterface $entity
 *   The entity object.
 * @param string $field_name
 *   The name of the disqus comment field.
 *
 * @return bool
 *   TRUE if access is allowed, FALSE if not.
 */</span>
<span class="k">protected</span> <span class="k">function</span> <span class="n">commentFieldAccessible</span><span class="p">(</span><span class="kt">EntityInterface</span> <span class="nv">$entity</span><span class="p">,</span> <span class="nv">$field_name</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Access if the field exists on the entity, the field is a disqus_comment</span>
  <span class="c1">// field and it's enabled.</span>
  <span class="k">return</span> <span class="o">!</span><span class="nb">empty</span><span class="p">(</span><span class="nv">$field_name</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
    <span class="nv">$entity</span><span class="o">-&gt;</span><span class="nf">hasField</span><span class="p">(</span><span class="nv">$field_name</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
    <span class="nv">$entity</span><span class="o">-&gt;</span><span class="nv">$field_name</span><span class="o">-&gt;</span><span class="nf">getFieldDefinition</span><span class="p">()</span><span class="o">-&gt;</span><span class="nb">getType</span><span class="p">()</span> <span class="o">===</span> <span class="s1">'disqus_comment'</span> <span class="o">&amp;&amp;</span>
    <span class="o">!</span><span class="nb">empty</span><span class="p">(</span><span class="nv">$entity</span><span class="o">-&gt;</span><span class="nv">$field_name</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="cd">/**
 * Access check.
 *
 *
 * @param string $entity_type
 *   The entity type.
 * @param \Drupal\Core\Entity\EntityInterface $entity
 *   The entity object.
 * @param string $js
 *   If this is an Ajax request, it will be the string 'ajax'. Otherwise, it will
 *   be 'nojs'.
 * @param string $field_name
 *   The name of the Disqus comment field.
 *
 * @return \Drupal\Core\Access\AccessResultInterface
 *   An access result.
 */</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">commentAccess</span><span class="p">(</span><span class="nv">$entity_type</span><span class="p">,</span> <span class="kt">EntityInterface</span> <span class="nv">$entity</span><span class="p">,</span> <span class="nv">$js</span> <span class="o">=</span> <span class="s1">'nojs'</span><span class="p">,</span> <span class="nv">$field_name</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$access</span> <span class="o">=</span> <span class="nc">AccessResult</span><span class="o">::</span><span class="nf">allowedIf</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">commentFieldAccessible</span><span class="p">(</span><span class="nv">$entity</span><span class="p">,</span> <span class="nv">$field_name</span><span class="p">));</span>
  <span class="c1">// Cache decision until entity changes.</span>
  <span class="nv">$access</span><span class="o">-&gt;</span><span class="nf">addCacheableDependency</span><span class="p">(</span><span class="nv">$entity</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">cachePerPermissions</span><span class="p">();</span>

  <span class="k">return</span> <span class="nv">$access</span><span class="p">;</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<p>Now that all logical dependency is available, we can create our field formatter.</p>

<h3 id="field-formatter">Field formatter</h3>

<p>The situation is easy: we only have to create an Ajax-capable link with the data attribute that’s expected by the controller’s Ajax ReplaceCommand. We will also will check the access to the generated route: if it is denied, the formatter will return with an empty array.</p>

<p><code class="language-plaintext highlighter-rouge">field_tools/src/Plugin/Field/FieldFormatter/DisqusAjaxLinkFormatter.php</code>:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
</pre></td>
<td class="rouge-code"><pre><span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">Drupal\field_tools\Plugin\Field\FieldFormatter</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Drupal\Component\Utility\Html</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Field\FieldItemListInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Link</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Url</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\disqus\Plugin\Field\FieldFormatter\DisqusFormatter</span><span class="p">;</span>

<span class="cd">/**
 * Provides an enhanced Disqus comment field formatter.
 *
 * @FieldFormatter(
 *   id = "disqus_comment_link",
 *   label = @Translation("Disqus Ajax link"),
 *   field_types = {
 *     "disqus_comment"
 *   }
 * )
 */</span>
<span class="kd">class</span> <span class="nc">DisqusAjaxLinkFormatter</span> <span class="kd">extends</span> <span class="nc">DisqusFormatter</span> <span class="p">{</span>

  <span class="cd">/**
   * {@inheritdoc}
   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="n">viewElements</span><span class="p">(</span><span class="kt">FieldItemListInterface</span> <span class="nv">$items</span><span class="p">,</span> <span class="nv">$langcode</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$elements</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nv">$entity</span> <span class="o">=</span> <span class="nv">$items</span><span class="o">-&gt;</span><span class="nf">getEntity</span><span class="p">();</span>
    <span class="nv">$field_name</span> <span class="o">=</span> <span class="nv">$items</span><span class="o">-&gt;</span><span class="nf">getName</span><span class="p">();</span>
    <span class="nv">$unique_id</span> <span class="o">=</span> <span class="nc">Html</span><span class="o">::</span><span class="nf">getClass</span><span class="p">(</span><span class="nb">implode</span><span class="p">(</span><span class="s1">'--'</span><span class="p">,</span> <span class="p">[</span>
      <span class="nv">$entity</span><span class="o">-&gt;</span><span class="nf">getEntityTypeId</span><span class="p">(),</span>
      <span class="nv">$entity</span><span class="o">-&gt;</span><span class="nf">id</span><span class="p">(),</span>
      <span class="nv">$field_name</span><span class="p">,</span>
    <span class="p">]));</span>
    <span class="nv">$url</span> <span class="o">=</span> <span class="nc">Url</span><span class="o">::</span><span class="nf">fromRoute</span><span class="p">(</span><span class="s2">"entity.</span><span class="si">{</span><span class="nv">$entity</span><span class="o">-&gt;</span><span class="nf">getEntityTypeId</span><span class="p">()</span><span class="si">}</span><span class="s2">.</span><span class="nv">$field_name</span><span class="s2">"</span><span class="p">,</span> <span class="p">[</span>
      <span class="s1">'entity'</span> <span class="o">=&gt;</span> <span class="nv">$entity</span><span class="o">-&gt;</span><span class="nf">id</span><span class="p">(),</span>
      <span class="s1">'field_name'</span> <span class="o">=&gt;</span> <span class="nv">$field_name</span><span class="p">,</span>
      <span class="s1">'js'</span> <span class="o">=&gt;</span> <span class="s1">'nojs'</span><span class="p">,</span>
    <span class="p">],</span> <span class="p">[</span>
      <span class="s1">'attributes'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'class'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'ajax-disqus-comments'</span><span class="p">,</span> <span class="s1">'use-ajax'</span><span class="p">,</span> <span class="s1">'button'</span><span class="p">]],</span>
    <span class="p">]);</span>

    <span class="c1">// We'll have only one item, but that should be fixed in the Disqus contrib sometime...</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$url</span><span class="o">-&gt;</span><span class="nf">access</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">foreach</span> <span class="p">(</span><span class="nv">$items</span> <span class="k">as</span> <span class="nv">$delta</span> <span class="o">=&gt;</span> <span class="nv">$item</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">empty</span><span class="p">(</span><span class="nv">$item</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
          <span class="nv">$elements</span><span class="p">[</span><span class="nv">$delta</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Link</span><span class="o">::</span><span class="nf">fromTextAndUrl</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'View comments'</span><span class="p">),</span> <span class="nv">$url</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">toRenderable</span><span class="p">();</span>
          <span class="nv">$value</span> <span class="o">=</span> <span class="nv">$items</span><span class="p">[</span><span class="nv">$delta</span><span class="p">]</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">();</span>
          <span class="nv">$value</span><span class="p">[</span><span class="s1">'_attributes'</span><span class="p">][</span><span class="s1">'data-field-tools-disqus-id'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$unique_id</span><span class="p">;</span>
          <span class="nv">$items</span><span class="p">[</span><span class="nv">$delta</span><span class="p">]</span><span class="o">-&gt;</span><span class="nf">setValue</span><span class="p">(</span><span class="nv">$value</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">empty</span><span class="p">(</span><span class="nv">$elements</span><span class="p">))</span> <span class="p">{</span>
        <span class="nv">$elements</span><span class="p">[</span><span class="s1">'#attached'</span><span class="p">][</span><span class="s1">'library'</span><span class="p">][]</span> <span class="o">=</span> <span class="s1">'core/drupal.ajax'</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nv">$elements</span><span class="p">;</span>
  <span class="p">}</span>

<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<p>We are done!</p>

<h3 id="optional-service-parameters">Optional service parameters</h3>

<p>I usually group these kind of formatters in the same module. This way the formatters can be easily reused in other projects without repeating the code.</p>

<p>But in the current case we may have a problem: because we use its <code class="language-plaintext highlighter-rouge">disqus.manager</code> service in our route subscriber, we cannot ignore that our custom module depends on Disqus module. Fortunately, we can make this service optional: we only have to remove the service from our constructor and define a setter instead:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td>
<td class="rouge-code"><pre><span class="na">services</span><span class="pi">:</span>
  <span class="na">field_tools.subscriber</span><span class="pi">:</span>
    <span class="na">class</span><span class="pi">:</span> <span class="s">Drupal\field_tools\Routing\RouteSubscriber</span>
    <span class="na">arguments</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">@entity_type.manager'</span><span class="pi">]</span>
    <span class="na">calls</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="pi">[</span><span class="nv">setDisqusManager</span><span class="pi">,</span> <span class="pi">[</span><span class="s1">'</span><span class="s">@?disqus.manager'</span><span class="pi">]]</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<p>Now implement the setter method in the route subscriber:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td>
<td class="rouge-code"><pre><span class="cd">/**
 * Sets Disqus comment manager.
 *
 * @param \Drupal\disqus\DisqusCommentManagerInterface $disqus_comment_manager
 *   The Disqus comment manager.
 */</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">setDisqusManager</span><span class="p">(</span><span class="kt">DisqusCommentManagerInterface</span> <span class="nv">$disqus_comment_manager</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">disqusCommentManager</span> <span class="o">=</span> <span class="nv">$disqus_comment_manager</span><span class="p">;</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<p>Since we don’t have to create routes for our formatter if the Disqus module is unavailable, we are able to easily handle the case when the optional <code class="language-plaintext highlighter-rouge">disqus.manager</code> service is missing: the route subscriber won’t do anything.</p>

<p>We have to add this to the beginning of the <code class="language-plaintext highlighter-rouge">RouteSubscriber::alterRoutes()</code> method:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td>
<td class="rouge-code"><pre><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">disqusCommentManager</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<hr>

<p class="sources"><em>Sources</em>:</p>

<ul>
  <li><a href="https://www.drupal.org/docs/8/api/ajax-api" target="_blank" rel="noopener noreferrer">Drupal Ajax API</a></li>
  <li>
<a href="https://orkjern.com/services-with-optional-dependencies-drupal-8" target="_blank" rel="noopener noreferrer">Creating services with optional dependencies in Drupal 8</a> by Eirik Morland</li>
</ul>


    </div>
<div class="tags rhythm-onehalf">
        <strong>Tagged with:</strong>
        
        <a class="postmeta__item postmeta__item--tag label" href="https://huzooka.github.io/tag/drupal">Drupal</a>
        
        <a class="postmeta__item postmeta__item--tag label" href="https://huzooka.github.io/tag/ajax-api">Ajax API</a>
        
        <a class="postmeta__item postmeta__item--tag label" href="https://huzooka.github.io/tag/field-api">Field API</a>
        
        <a class="postmeta__item postmeta__item--tag label" href="https://huzooka.github.io/tag/access-control">Access control</a>
        
        <a class="postmeta__item postmeta__item--tag label" href="https://huzooka.github.io/tag/routing">Routing</a>
        
    </div>
<a class="u-url" href="/development/2019/02/28/update-page-with-ajax.html" hidden></a>
</article>

      </div>
    </main><footer class="footer h-card bg-dark">
    <data class="u-url" href="/"></data>

    <div class="wrapper">
        <div class="footer__row">
            <div class="footer__col footer__col--slogan">
                <div class="slogan">
                    <span class="logo slogan__logo"></span>
                    <p class="slogan__slogan">The Github Page where I temporarily publish my professional posts</p>
                </div>
            </div>

            <div class="footer__col">
<ul class="menu-list font-heading">
<li class="menu-list__item h4">
        <a href="/about/">About</a>
    </li>
<li class="menu-list__item h4">
        <a href="https://huzooka.github.io/tag/drupal">Drupal</a>
    </li>
<li class="menu-list__item h4">
        <a href="https://huzooka.github.io/tag/migration">Migration</a>
    </li>
<li class="menu-list__item h4">
        <a href="/feed.xml">RSS</a>
    </li>
</ul>
</div>

            <div class="footer__col">
<ul class="menu-list font-heading">
<li class="menu-list__item h4"><a href="https://drupal.org/u/huzooka" target="_blank" rel="noopener noreferrer">Drupal.org</a></li>
<li class="menu-list__item h4"><a href="https://github.com/zolhorvath" target="_blank" rel="noopener noreferrer">Github</a></li>
<li class="menu-list__item h4"><a href="https://www.linkedin.com/in/zoltan-attila-horvath" target="_blank" rel="noopener noreferrer">Linkedin</a></li>
<li class="menu-list__item h4"><a href="https://www.twitter.com/huzooka" target="_blank" rel="noopener noreferrer">Twitter</a></li>
</ul>
</div>
        </div>
    </div>
</footer>
</body>

</html>
