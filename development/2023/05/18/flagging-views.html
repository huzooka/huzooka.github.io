<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
<title>Views with Flaggings? You Can Make Them Fast! | HuZooka</title>
<meta name="generator" content="Jekyll v4.2.2">
<meta property="og:title" content="Views with Flaggings? You Can Make Them Fast!">
<meta name="author" content="Zolt√°n Horv√°th">
<meta property="og:locale" content="en_US">
<meta name="description" content="How we accelerated our extremely slow Views queries which were using flagging relationship.">
<meta property="og:description" content="How we accelerated our extremely slow Views queries which were using flagging relationship.">
<link rel="canonical" href="https://huzooka.github.io/development/2023/05/18/flagging-views.html">
<meta property="og:url" content="https://huzooka.github.io/development/2023/05/18/flagging-views.html">
<meta property="og:site_name" content="HuZooka">
<meta property="og:image" content="https://huzooka.github.io/files/image/snail.jpg">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2023-05-18T14:24:57+00:00">
<meta name="twitter:card" content="summary_large_image">
<meta property="twitter:image" content="https://huzooka.github.io/files/image/snail.jpg">
<meta property="twitter:title" content="Views with Flaggings? You Can Make Them Fast!">
<meta name="twitter:site" content="@huzooka">
<meta name="twitter:creator" content="@huzooka">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Zolt√°n Horv√°th"},"dateModified":"2023-05-18T14:24:57+00:00","datePublished":"2023-05-18T14:24:57+00:00","description":"How we accelerated our extremely slow Views queries which were using flagging relationship.","headline":"Views with Flaggings? You Can Make Them Fast!","image":"https://huzooka.github.io/files/image/snail.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"https://huzooka.github.io/development/2023/05/18/flagging-views.html"},"url":"https://huzooka.github.io/development/2023/05/18/flagging-views.html"}</script>

<link rel="stylesheet" href="/assets/main.css?f3f2fc8c">
<link type="application/atom+xml" rel="alternate" href="https://huzooka.github.io/feed.xml" title="HuZooka">
<link rel="icon" href="/favicon.ico?b6c405af" type="image/vnd.microsoft.icon">
    <link rel="preload" href="/assets/texb-875-125.woff2" as="font" type="font/woff2" crossorigin="anonymous">
    <link rel="preload" href="/assets/charissilr.woff2" as="font" type="font/woff2" crossorigin="anonymous">
    <link rel="preload" href="/assets/charissilb.woff2" as="font" type="font/woff2" crossorigin="anonymous">
</head>
<body>
<header class="site-header">

    <div class="wrapper">
<a class="site-title h3" rel="author" href="/">
            <span class="logo logo--header"></span>HuZooka
        </a><nav class="site-nav">
            <input type="checkbox" id="nav-trigger" class="nav-trigger">
            <label for="nav-trigger" class="menu-icon">
                <span class="menu-icon__bar"></span>
                <span class="menu-icon__bar"></span>
                <span class="menu-icon__bar"></span>
            </label>

            <div class="trigger">
<a class="nav-link h5" href="/about/">About</a><a class="nav-link h5" href="https://huzooka.github.io/tag/drupal">Drupal</a><a class="nav-link h5" href="https://huzooka.github.io/tag/migration">Migration</a>
</div>
        </nav>
</div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

    <header class="post-header">
        <h1 class="post-title p-name" itemprop="name headline">Views with Flaggings?<br>
You Can Make Them Fast!<br>
</h1>

        <p class="postmeta">
            <time class="dt-published" datetime="2023-05-18T14:24:57+00:00" itemprop="datePublished">May 18, 2023
            </time>‚Ä¢ <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Zolt√°n Horv√°th</span></span></p>
    </header>

    <div class="post-content e-content rhythm-onehalf" itemprop="articleBody">
        <p class="lead">Nowadays, I am working on the migration of a Drupal¬†7 site with millions of nodes and 10¬†millions of comments. We¬†also have some flaggings to import. But¬†after we managed to migrate all the <em>Flagging</em> entities we needed, we found that our views on the main page got extremely slow¬†üò≥. As¬†it turned out, we had an extremely slow Views query which used <em>flagging</em> relationship.</p>

<h2 id="the-problem">The problem</h2>

<p>The extremely slow query is caused by the different data type used in the <em>flagging</em> table. Nodes, comments (basically most the content entities I‚Äôm aware of) are using unsigned integers for their ID column, while <em>flagging</em> uses varchar. And in my opinion, <strong>Flag module is right!</strong> There is no constraint which forces entities to have integer IDs: it is just the default type in case of <em>content</em> entities.</p>

<p>Anyway, the query we need to execute joins <code class="language-plaintext highlighter-rouge">flagging</code> and <code class="language-plaintext highlighter-rouge">node_field_data</code> tables by comparing a <code class="language-plaintext highlighter-rouge">VARCHAR</code> column to an <code class="language-plaintext highlighter-rouge">INT</code> column. This has two disadvantages:</p>
<ol>
  <li>Comparison falls back to floating-point comparison which isn‚Äôt precize at all and this is also much slower than comparing a <code class="language-plaintext highlighter-rouge">VARCHAR</code> to <code class="language-plaintext highlighter-rouge">VARCHAR</code> or <code class="language-plaintext highlighter-rouge">INT</code> to <code class="language-plaintext highlighter-rouge">INT</code>. Size and other configurations also must match ‚Äì in an ideal situation, an <code class="language-plaintext highlighter-rouge">INT(10) UNSIGNED</code> column should be compared to another <code class="language-plaintext highlighter-rouge">INT(10) UNSIGNED</code>).</li>
  <li>
<a href="https://dev.mysql.com/doc/refman/8.0/en/type-conversion.html" target="_blank" rel="noopener noreferrer">MySQL/MariaDB cannot use index</a>, so the query will be much slower:
    <blockquote>
      <p>For comparisons of a string column with a number, MySQL cannot use an index on the column to look up the value quickly.</p>
    </blockquote>

    <p>(By the way, there is no such index on the <code class="language-plaintext highlighter-rouge">flagging</code> table anyway.)</p>
  </li>
</ol>

<p>The simple solution would be to change the data type of the <code class="language-plaintext highlighter-rouge">entity_id</code> in the <code class="language-plaintext highlighter-rouge">flagging</code> table <strong>and</strong> add an index, but I think that would be a very bad idea, because if we did, it would break Flag module‚Äôs current capabilities and would possibly cause issues even if newer Flag releases try to change or update the column.</p>

<h2 id="the-solution-we-applied-for-views">The solution we applied (for Views)</h2>

<p>We decided to add a new integer column to the <code class="language-plaintext highlighter-rouge">flagging</code> table, then in Flag module‚Äôs <a href="https://git.drupalcode.org/project/flag/-/blob/9e12a609b2/src/Plugin/views/relationship/FlagViewsRelationship.php" target="_blank" rel="noopener noreferrer">Views relationship plugin</a>, we could use this column if the base table‚Äôs column‚Äôs type is also integer. So the tasks were:</p>

<ul>
  <li>Add a new column to the base table of flagging entities (so to the <code class="language-plaintext highlighter-rouge">flagging</code> table: <code class="language-plaintext highlighter-rouge">entity_id_int INT(10) UNSIGNED</code> defaulting to <code class="language-plaintext highlighter-rouge">NULL</code>).</li>
  <li>Ask the Flag module to fill this column with the value of flagging‚Äôs <code class="language-plaintext highlighter-rouge">entity_id</code> property if the property value is numeric.</li>
  <li>Change the related query added by the <code class="language-plaintext highlighter-rouge">flag_relationship</code> plugin, so if flagging records are joined and the other table‚Äôs appropriate column has integer type, we change <code class="language-plaintext highlighter-rouge">flagging.entity_id</code> column to <code class="language-plaintext highlighter-rouge">flagging.entity_id_int</code>
</li>
  <li>Add the appropriate index with an enhanced flagging storage schema handler.</li>
  <li>In an update hook, install the new column and the new storage schema handler.</li>
  <li>In a post update function, fill the new column with the values fetched from the preexisting record‚Äôs <code class="language-plaintext highlighter-rouge">entity_id</code> column.</li>
</ul>

<h3 id="new-base-field">New base field</h3>

<p>The easiest (and the Drupal-) way to add a new column to the base table of an entity is adding a new base field. Base fields are available for every entity bundle, which makes them the best fit for our situation too.</p>

<p>To add a new base field to an entity type provided by another module, we can implement <code class="language-plaintext highlighter-rouge">hook_entity_base_field_info()</code> (see the <a href="https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Core%21Entity%21ContentEntityBase.php/function/ContentEntityBase%3A%3AbaseFieldDefinitions" target="_blank" rel="noopener noreferrer">documentation at <code class="language-plaintext highlighter-rouge">ContentEntityBase::baseFieldDefinitions</code></a>):</p>

<div data-file="better_flag.module" class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td>
<td class="rouge-code"><pre><span class="cd">/**
 * Implements hook_entity_base_field_info().
 */</span>
<span class="k">function</span> <span class="n">better_flag_entity_base_field_info</span><span class="p">(</span><span class="kt">EntityTypeInterface</span> <span class="nv">$entity_type</span><span class="p">):</span> <span class="kt">array</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$entity_type</span><span class="o">-&gt;</span><span class="nf">id</span><span class="p">()</span> <span class="o">!==</span> <span class="s1">'flagging'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[];</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="p">[</span>
    <span class="s1">'entity_id_int'</span> <span class="o">=&gt;</span> <span class="nc">BaseFieldDefinition</span><span class="o">::</span><span class="nf">create</span><span class="p">(</span><span class="s1">'integer'</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="nf">setLabel</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Entity ID as integer'</span><span class="p">))</span>
      <span class="o">-&gt;</span><span class="nf">setDescription</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="s1">'The ID of the flagged entity if it is integer.'</span><span class="p">))</span>
      <span class="o">-&gt;</span><span class="nf">setSetting</span><span class="p">(</span><span class="s1">'unsigned'</span><span class="p">,</span> <span class="kc">TRUE</span><span class="p">)</span>
      <span class="c1">// Provider must be set to 'flag'.</span>
      <span class="c1">// - If it's set to 'better_flag' then on uninstall, ModuleInstaller tries</span>
      <span class="c1">//   to remove it even if we delete this field in our uninstall hook. Why?</span>
      <span class="c1">//   Because this hook gets invoked!</span>
      <span class="c1">// - But if we don't do anything on uninstall, the entity schema won't be</span>
      <span class="c1">//   updated and the 'flagging' entity's schema will be outdated - meaning</span>
      <span class="c1">//   that the extra column in DB won't be removed.</span>
      <span class="o">-&gt;</span><span class="nf">setProvider</span><span class="p">(</span><span class="s1">'flag'</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="nf">setInitialValue</span><span class="p">(</span><span class="kc">NULL</span><span class="p">),</span>
  <span class="p">];</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<p>Of course, if the entity was already available before our module was installed, we have to provide an update hook to have its column installed to the database table. This is one of the tasks that <code class="language-plaintext highlighter-rouge">EntityDefinitionUpdateManager</code> was designed for!</p>

<div data-file="better_flag.install" class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td>
<td class="rouge-code"><pre><span class="cd">/**
 * Installs 'entity_id_int' column to Flagging entities' DB table.
 */</span>
<span class="k">function</span> <span class="n">better_flag_update_9001</span><span class="p">():</span> <span class="kt">void</span> <span class="p">{</span>
  <span class="err">\</span><span class="nc">Drupal</span><span class="o">::</span><span class="nf">entityDefinitionUpdateManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">installFieldStorageDefinition</span><span class="p">(</span>
    <span class="s1">'entity_id_int'</span><span class="p">,</span>
    <span class="s1">'flagging'</span><span class="p">,</span>
    <span class="s1">'flag'</span><span class="p">,</span>
    <span class="nc">BaseFieldDefinition</span><span class="o">::</span><span class="nf">create</span><span class="p">(</span><span class="s1">'integer'</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="nf">setLabel</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Entity ID as integer'</span><span class="p">))</span>
      <span class="o">-&gt;</span><span class="nf">setDescription</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="s1">'The ID of the flagged entity if it is integer.'</span><span class="p">))</span>
      <span class="o">-&gt;</span><span class="nf">setSetting</span><span class="p">(</span><span class="s1">'unsigned'</span><span class="p">,</span> <span class="kc">TRUE</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="nf">setInitialValue</span><span class="p">(</span><span class="kc">NULL</span><span class="p">)</span>
  <span class="p">);</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<p>After our new base field was installed in the update hook above, we weren‚Äôt done yet:</p>
<ol>
  <li>We still had to update every pre-existing record, so they will have the right value in the new base field.</li>
  <li>We also had to ensure that new flaggings would have the appropriate value there.</li>
</ol>

<p>Let‚Äôs fill the new column with the right value for the preexisting flagging entities! Ideally, this should be done in a post update function. We only updated those records where the value of the original <code class="language-plaintext highlighter-rouge">entity_id</code> column only contained integer characters:</p>

<div data-file="better_flag.post_update.php" class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td>
<td class="rouge-code"><pre><span class="cd">/**
 * Fill 'entity_id_int' column values.
 */</span>
<span class="k">function</span> <span class="n">better_flag_post_update_fill_entity_id_integer_column</span><span class="p">():</span> <span class="kt">void</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="nv">$flagging_definition</span> <span class="o">=</span> <span class="err">\</span><span class="nc">Drupal</span><span class="o">::</span><span class="nf">entityTypeManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getDefinition</span><span class="p">(</span><span class="s1">'flagging'</span><span class="p">);</span>
    <span class="nv">$connection</span> <span class="o">=</span> <span class="err">\</span><span class="nc">Drupal</span><span class="o">::</span><span class="nf">database</span><span class="p">();</span>
    <span class="nv">$regexp_operator</span> <span class="o">=</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="nf">databaseType</span><span class="p">()</span> <span class="o">===</span> <span class="s1">'pgsql'</span> <span class="o">?</span> <span class="s1">'~'</span> <span class="o">:</span> <span class="s1">'REGEXP'</span><span class="p">;</span>
    
    <span class="nv">$connection</span><span class="o">-&gt;</span><span class="nf">update</span><span class="p">(</span><span class="nv">$flagging_definition</span><span class="o">-&gt;</span><span class="nf">getBaseTable</span><span class="p">())</span>
      <span class="o">-&gt;</span><span class="nb">expression</span><span class="p">(</span><span class="s1">'entity_id_int'</span><span class="p">,</span> <span class="s1">'entity_id'</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'entity_id'</span><span class="p">,</span> <span class="s1">'^[0-9]+$'</span><span class="p">,</span> <span class="nv">$regexp_operator</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="nf">execute</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">catch</span> <span class="p">(</span><span class="err">\</span><span class="nc">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nc">UpdateException</span><span class="p">(</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="nf">getMessage</span><span class="p">());</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<p>After this, in a <code class="language-plaintext highlighter-rouge">hook_ENTITY_TYPE_presave()</code> implementation, we ensured that new flaggings have the right value in the new <code class="language-plaintext highlighter-rouge">entity_id_int</code> field.</p>

<div data-file="better_flag.module" class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td>
<td class="rouge-code"><pre><span class="cd">/**
 * Implements hook_ENTITY_TYPE_presave() for flagging.
 */</span>
<span class="k">function</span> <span class="n">better_flag_flagging_presave</span><span class="p">(</span><span class="kt">EntityInterface</span> <span class="nv">$flagging</span><span class="p">)</span> <span class="p">{</span>
  <span class="nb">assert</span><span class="p">(</span><span class="nv">$flagging</span> <span class="k">instanceof</span> <span class="nc">FlaggingInterface</span><span class="p">);</span>
  <span class="nb">assert</span><span class="p">(</span><span class="nv">$flagging</span> <span class="k">instanceof</span> <span class="nc">ContentEntityBase</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/^\d{1,10}$/'</span><span class="p">,</span> <span class="nv">$flagged_entity_id</span> <span class="o">=</span> <span class="nv">$flagging</span><span class="o">-&gt;</span><span class="nf">getFlaggableId</span><span class="p">()))</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// We know that the entity ID is numeric (and it isn't longer than 10 digits),</span>
  <span class="c1">// so we can store the ID value in our extra integer field too.</span>
  <span class="nv">$flagging</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'entity_id_int'</span><span class="p">,</span> <span class="nv">$flagged_entity_id</span><span class="p">);</span>
  <span class="nv">$flagging</span><span class="o">-&gt;</span><span class="nf">updateOriginalValues</span><span class="p">();</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<h3 id="views-relationship">Views relationship</h3>

<p>The next task was to make the <code class="language-plaintext highlighter-rouge">flag_relationship</code> Views plugin to use the new integer column for joining its table whenever the base table‚Äôs corresponding field also has an integer type.</p>

<p>Luckily, Views utilizes Plugin API for most of the components it is using. It is very easy to alter for example the <code class="language-plaintext highlighter-rouge">flag_relationship</code> plugin. We don‚Äôt have too many options, but all what we need to do is to replace the plugin‚Äôs class in the plugin definition with our enhanced, ‚Äúsmarter‚Äù class:</p>

<div data-file="src/Plugin/views/relationship/BetterFlagViewsRelationship.php" class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td>
<td class="rouge-code"><pre><span class="cd">/**
 * Replacement class for FlagViewsRelationship.
 */</span>
<span class="kd">class</span> <span class="nc">BetterFlagViewsRelationship</span> <span class="kd">extends</span> <span class="nc">FlagViewsRelationship</span> <span class="p">{</span>

  <span class="cd">/**
   * {@inheritdoc}
   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="n">query</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span>
      <span class="c1">// We have a real DB column to join on.</span>
      <span class="k">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">realField</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
      <span class="c1">// The current display has an entity type.</span>
      <span class="o">!</span><span class="nb">empty</span><span class="p">(</span><span class="nv">$entity_type</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getEntityType</span><span class="p">())</span> <span class="o">&amp;&amp;</span>
      <span class="c1">// The column is one of the base fields of the entity type.</span>
      <span class="p">(</span><span class="nv">$base_field_definition</span> <span class="o">=</span> <span class="err">\</span><span class="nc">Drupal</span><span class="o">::</span><span class="nf">service</span><span class="p">(</span><span class="s1">'entity_field.manager'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getBaseFieldDefinitions</span><span class="p">(</span><span class="nv">$entity_type</span><span class="p">)[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">realField</span><span class="p">]</span> <span class="o">??</span> <span class="kc">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
      <span class="c1">// The type of the column is integer.</span>
      <span class="p">(</span><span class="nv">$base_field_definition</span> <span class="k">instanceof</span> <span class="nc">FieldDefinitionInterface</span> <span class="o">&amp;&amp;</span> <span class="nv">$base_field_definition</span><span class="o">-&gt;</span><span class="nb">getType</span><span class="p">()</span> <span class="o">===</span> <span class="s1">'integer'</span><span class="p">)</span>
    <span class="p">)</span> <span class="p">{</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">definition</span><span class="p">[</span><span class="s1">'base field'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'entity_id_int'</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">parent</span><span class="o">::</span><span class="nf">query</span><span class="p">();</span>
  <span class="p">}</span>

<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<p>After this we could go ahead and change the plugin definition by using a <code class="language-plaintext highlighter-rouge">hook_views_plugins_relationship_alter()</code> hook:</p>

<div data-file="better_flag.module" class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td>
<td class="rouge-code"><pre><span class="cd">/**
 * Implements hook_views_plugins_relationship_alter().
 */</span>
<span class="k">function</span> <span class="n">better_flag_views_plugins_relationship_alter</span><span class="p">(</span><span class="kt">array</span> <span class="o">&amp;</span><span class="nv">$plugins</span><span class="p">):</span> <span class="kt">void</span> <span class="p">{</span>
  <span class="c1">// Replaces flag_relationship views plugin with our own, improved version</span>
  <span class="c1">// which then speeds up queries using integer type of entity ID column in case</span>
  <span class="c1">// of joins.</span>
  <span class="k">if</span> <span class="p">(</span>
    <span class="k">isset</span><span class="p">(</span><span class="nv">$plugins</span><span class="p">[</span><span class="s1">'flag_relationship'</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
    <span class="nv">$plugins</span><span class="p">[</span><span class="s1">'flag_relationship'</span><span class="p">][</span><span class="s1">'class'</span><span class="p">]</span> <span class="o">===</span> <span class="nc">FlagViewsRelationship</span><span class="o">::</span><span class="n">class</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="nv">$plugins</span><span class="p">[</span><span class="s1">'flag_relationship'</span><span class="p">][</span><span class="s1">'class'</span><span class="p">]</span> <span class="o">=</span> <span class="nc">BetterFlagViewsRelationship</span><span class="o">::</span><span class="n">class</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<h3 id="extend-the-entity-table-with-new-indexes">Extend the entity table with new indexes</h3>

<p>Finally, we extended the <a href="https://git.drupalcode.org/project/flag/-/blob/9e12a609b2/src/Entity/Storage/FlaggingStorageSchema.php" target="_blank" rel="noopener noreferrer">storage schema</a> of flagging entities. Why? Because without having the matching index in place, the query still took about 1200‚Äî1500ms to finish with about 1 million flaggings.</p>

<p><em>This is a bit of a fragile solution</em>: we cannot decorate these handlers, we can only change them. If another module has to do the same to flaggings, our replacement storage schema handler might be replaced, and we can‚Äôt take advantage of our dedicated index. All we can do is add a PHPUnit test that checks the schema handler of flaggings with all the modules in our project installed.</p>

<p>This is our replacement storage schema handler which adds the new index with <code class="language-plaintext highlighter-rouge">flag_id</code> and <code class="language-plaintext highlighter-rouge">entity_id_int</code>:</p>

<div data-file="src/Entity/Storage/BetterFlaggingStorageSchema.php" class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td>
<td class="rouge-code"><pre><span class="cd">/**
 * Replacement class for Flagging entity storage schema handler.
 */</span>
<span class="kd">class</span> <span class="nc">BetterFlaggingStorageSchema</span> <span class="kd">extends</span> <span class="nc">FlaggingStorageSchema</span> <span class="p">{</span>

  <span class="cd">/**
   * {@inheritdoc}
   */</span>
  <span class="k">protected</span> <span class="k">function</span> <span class="n">getEntitySchema</span><span class="p">(</span><span class="kt">ContentEntityTypeInterface</span> <span class="nv">$entity_type</span><span class="p">,</span> <span class="nv">$reset</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$schema</span> <span class="o">=</span> <span class="k">parent</span><span class="o">::</span><span class="nf">getEntitySchema</span><span class="p">(</span><span class="nv">$entity_type</span><span class="p">,</span> <span class="nv">$reset</span><span class="p">);</span>
    <span class="nv">$schema</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">entityType</span><span class="o">-&gt;</span><span class="nf">getBaseTable</span><span class="p">()][</span><span class="s1">'indexes'</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span>
      <span class="s1">'better__flag_id__entity_id_int'</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">'flag_id'</span><span class="p">,</span>
        <span class="s1">'entity_id_int'</span><span class="p">,</span>
      <span class="p">],</span>
    <span class="p">];</span>

    <span class="k">return</span> <span class="nv">$schema</span><span class="p">;</span>
  <span class="p">}</span>

<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<p>Of course, we also had to replace the original handler with our own. This can be done with a <code class="language-plaintext highlighter-rouge">hook_entity_type_alter()</code> implementation:</p>

<div data-file="better_flag.module" class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td>
<td class="rouge-code"><pre><span class="cd">/**
 * Implements hook_entity_type_alter().
 */</span>
<span class="k">function</span> <span class="n">better_flag_entity_type_alter</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$entity_types</span><span class="p">):</span> <span class="kt">void</span> <span class="p">{</span>
  <span class="c1">// Replace storage schema class of flagging entities.</span>
  <span class="nb">assert</span><span class="p">(</span><span class="nv">$entity_types</span><span class="p">[</span><span class="s1">'flagging'</span><span class="p">]</span> <span class="k">instanceof</span> <span class="nc">EntityTypeInterface</span><span class="p">);</span>
  <span class="nv">$entity_types</span><span class="p">[</span><span class="s1">'flagging'</span><span class="p">]</span><span class="o">-&gt;</span><span class="nf">setHandlerClass</span><span class="p">(</span><span class="s1">'storage_schema'</span><span class="p">,</span> <span class="nc">BetterFlaggingStorageSchema</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<p>As the last step, we needed yet another update hook where we could install the new storage schema. In our case, this means that ‚Äì under the hood ‚Äì Drupal will drop every preexisting index on the corresponding table(s) and then recreate the new ones.</p>

<div data-file="better_flag.install" class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td>
<td class="rouge-code"><pre><span class="cd">/**
 * Install the new storage schema handler of flagging entities.
 */</span>
<span class="k">function</span> <span class="n">better_flag_update_9002</span><span class="p">():</span> <span class="kt">void</span> <span class="p">{</span>
  <span class="nv">$entity_definition_update_manager</span> <span class="o">=</span> <span class="err">\</span><span class="nc">Drupal</span><span class="o">::</span><span class="nf">entityDefinitionUpdateManager</span><span class="p">();</span>
  <span class="nv">$entity_type</span> <span class="o">=</span> <span class="nv">$entity_definition_update_manager</span><span class="o">-&gt;</span><span class="nf">getEntityType</span><span class="p">(</span><span class="s1">'flagging'</span><span class="p">);</span>
  <span class="nv">$entity_type</span><span class="o">-&gt;</span><span class="nf">setHandlerClass</span><span class="p">(</span><span class="s1">'storage_schema'</span><span class="p">,</span> <span class="nc">BetterFlaggingStorageSchema</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
  <span class="nv">$entity_definition_update_manager</span><span class="o">-&gt;</span><span class="nf">updateEntityType</span><span class="p">(</span><span class="nv">$entity_type</span><span class="p">);</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<p><strong>That was all!</strong></p>

<h2 id="diagnostic">Diagnostic</h2>

<p>If you‚Äôve reached this line, I‚Äôm pretty sure you‚Äôre wondering what happened to the Views database query. ‚ÄúUnfortunately‚Äù, I was not patient enough to wait for the unoptimized database query to finish üò∂.</p>

<h3 id="original">Original</h3>

<p>This was the original query (no result after <strong>~30 minutes</strong>):</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td>
<td class="rouge-code"><pre><span class="k">SELECT</span> 
    <span class="n">node_field_data</span><span class="p">.</span><span class="n">langcode</span> <span class="k">AS</span> <span class="n">node_field_data_langcode</span><span class="p">,</span> 
    <span class="n">flagging_node_field_data</span><span class="p">.</span><span class="n">uid</span> <span class="k">AS</span> <span class="n">flagging_node_field_data_uid</span><span class="p">,</span> 
    <span class="n">node_field_data</span><span class="p">.</span><span class="n">changed</span> <span class="k">AS</span> <span class="n">node_field_data_changed</span><span class="p">,</span> 
    <span class="n">node_field_data</span><span class="p">.</span><span class="n">nid</span> <span class="k">AS</span> <span class="n">nid</span><span class="p">,</span> 
    <span class="n">flagging_node_field_data</span><span class="p">.</span><span class="n">id</span> <span class="k">AS</span> <span class="n">flagging_node_field_data_id</span> 
<span class="k">FROM</span> <span class="n">node_field_data</span> <span class="n">node_field_data</span> 
<span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">flagging</span> <span class="n">flagging_node_field_data</span> <span class="k">ON</span> 
    <span class="n">node_field_data</span><span class="p">.</span><span class="n">nid</span> <span class="o">=</span> <span class="n">flagging_node_field_data</span><span class="p">.</span><span class="n">entity_id</span> <span class="k">AND</span> 
    <span class="n">flagging_node_field_data</span><span class="p">.</span><span class="n">flag_id</span> <span class="o">=</span> <span class="s1">'custom_flag_id'</span> 
<span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">comment_entity_statistics</span> <span class="n">comment_entity_statistics</span> <span class="k">ON</span> 
    <span class="n">node_field_data</span><span class="p">.</span><span class="n">nid</span> <span class="o">=</span> <span class="n">comment_entity_statistics</span><span class="p">.</span><span class="n">entity_id</span> <span class="k">AND</span> 
    <span class="n">comment_entity_statistics</span><span class="p">.</span><span class="n">entity_type</span> <span class="o">=</span> <span class="s1">'node'</span> 
<span class="k">WHERE</span> 
    <span class="p">(</span><span class="n">node_field_data</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">'1'</span><span class="p">)</span> <span class="k">AND</span> 
    <span class="p">(</span><span class="n">node_field_data</span><span class="p">.</span><span class="k">type</span> <span class="k">IN</span> <span class="p">(</span><span class="s1">'topic'</span><span class="p">))</span> <span class="k">AND</span> 
    <span class="p">(</span><span class="n">comment_entity_statistics</span><span class="p">.</span><span class="n">comment_count</span> <span class="o">&gt;</span> <span class="s1">'0'</span><span class="p">)</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">node_field_data_changed</span> <span class="k">DESC</span> 
<span class="k">LIMIT</span> <span class="mi">10</span> <span class="k">OFFSET</span> <span class="mi">0</span><span class="p">;</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<p>Original <code class="language-plaintext highlighter-rouge">EXPLAIN</code> result:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td>
<td class="rouge-code"><pre><span class="o">+</span><span class="c1">----+-------------+---------------------------+------------+-------+--------------------------------------------------------------------------------------------+--------------------------------------+---------+--------------------------------------------+---------+----------+-----------------------------------------------------------+</span>
<span class="o">|</span> <span class="n">id</span> <span class="o">|</span> <span class="n">select_type</span> <span class="o">|</span> <span class="k">table</span>                     <span class="o">|</span> <span class="n">partitions</span> <span class="o">|</span> <span class="k">type</span>  <span class="o">|</span> <span class="n">possible_keys</span>                                                                              <span class="o">|</span> <span class="k">key</span>                                  <span class="o">|</span> <span class="n">key_len</span> <span class="o">|</span> <span class="k">ref</span>                                        <span class="o">|</span> <span class="k">rows</span>    <span class="o">|</span> <span class="n">filtered</span> <span class="o">|</span> <span class="n">Extra</span>                                                     <span class="o">|</span>
<span class="o">+</span><span class="c1">----+-------------+---------------------------+------------+-------+--------------------------------------------------------------------------------------------+--------------------------------------+---------+--------------------------------------------+---------+----------+-----------------------------------------------------------+</span>
<span class="o">|</span>  <span class="mi">1</span> <span class="o">|</span> <span class="k">SIMPLE</span>      <span class="o">|</span> <span class="n">comment_entity_statistics</span> <span class="o">|</span> <span class="k">NULL</span>       <span class="o">|</span> <span class="k">range</span> <span class="o">|</span> <span class="k">PRIMARY</span><span class="p">,</span><span class="n">comment_count</span><span class="p">,</span><span class="n">testing__entity_id__entity_type__comment_count</span>                       <span class="o">|</span> <span class="n">comment_count</span>                        <span class="o">|</span> <span class="mi">4</span>       <span class="o">|</span> <span class="k">NULL</span>                                       <span class="o">|</span> <span class="mi">1874806</span> <span class="o">|</span>    <span class="mi">10</span><span class="p">.</span><span class="mi">00</span> <span class="o">|</span> <span class="k">Using</span> <span class="k">where</span><span class="p">;</span> <span class="k">Using</span> <span class="k">index</span><span class="p">;</span> <span class="k">Using</span> <span class="k">temporary</span><span class="p">;</span> <span class="k">Using</span> <span class="n">filesort</span> <span class="o">|</span>
<span class="o">|</span>  <span class="mi">1</span> <span class="o">|</span> <span class="k">SIMPLE</span>      <span class="o">|</span> <span class="n">node_field_data</span>           <span class="o">|</span> <span class="k">NULL</span>       <span class="o">|</span> <span class="k">ref</span>   <span class="o">|</span> <span class="k">PRIMARY</span><span class="p">,</span><span class="n">node__id__default_langcode__langcode</span><span class="p">,</span><span class="n">node_field__type__target_id</span><span class="p">,</span><span class="n">node__status_type</span> <span class="o">|</span> <span class="n">node__id__default_langcode__langcode</span> <span class="o">|</span> <span class="mi">4</span>       <span class="o">|</span> <span class="n">drupal</span><span class="p">.</span><span class="n">comment_entity_statistics</span><span class="p">.</span><span class="n">entity_id</span> <span class="o">|</span>       <span class="mi">1</span> <span class="o">|</span>     <span class="mi">5</span><span class="p">.</span><span class="mi">00</span> <span class="o">|</span> <span class="k">Using</span> <span class="k">where</span>                                               <span class="o">|</span>
<span class="o">|</span>  <span class="mi">1</span> <span class="o">|</span> <span class="k">SIMPLE</span>      <span class="o">|</span> <span class="n">flagging_node_field_data</span>  <span class="o">|</span> <span class="k">NULL</span>       <span class="o">|</span> <span class="k">ref</span>   <span class="o">|</span> <span class="n">flagging_field__flag_id__target_id</span><span class="p">,</span><span class="n">entity_id__uid</span>                                          <span class="o">|</span> <span class="n">flagging_field__flag_id__target_id</span>   <span class="o">|</span> <span class="mi">34</span>      <span class="o">|</span> <span class="n">const</span>                                      <span class="o">|</span>    <span class="mi">3091</span> <span class="o">|</span>   <span class="mi">100</span><span class="p">.</span><span class="mi">00</span> <span class="o">|</span> <span class="k">Using</span> <span class="k">where</span>                                               <span class="o">|</span>
<span class="o">+</span><span class="c1">----+-------------+---------------------------+------------+-------+--------------------------------------------------------------------------------------------+--------------------------------------+---------+--------------------------------------------+---------+----------+-----------------------------------------------------------+</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<h3 id="optimized-query">Optimized query</h3>

<p>This is the optimized query ‚Äì it finishes in <strong>1ms-3ms</strong>!:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td>
<td class="rouge-code"><pre><span class="k">SELECT</span>
    <span class="n">node_field_data</span><span class="p">.</span><span class="n">langcode</span> <span class="k">AS</span> <span class="n">node_field_data_langcode</span><span class="p">,</span> 
    <span class="n">flagging_node_field_data</span><span class="p">.</span><span class="n">uid</span> <span class="k">AS</span> <span class="n">flagging_node_field_data_uid</span><span class="p">,</span> 
    <span class="n">node_field_data</span><span class="p">.</span><span class="n">changed</span> <span class="k">AS</span> <span class="n">node_field_data_changed</span><span class="p">,</span> 
    <span class="n">node_field_data</span><span class="p">.</span><span class="n">nid</span> <span class="k">AS</span> <span class="n">nid</span><span class="p">,</span> 
    <span class="n">flagging_node_field_data</span><span class="p">.</span><span class="n">id</span> <span class="k">AS</span> <span class="n">flagging_node_field_data_id</span> 
<span class="k">FROM</span> <span class="n">node_field_data</span> <span class="n">node_field_data</span> 
<span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">flagging</span> <span class="n">flagging_node_field_data</span> <span class="k">ON</span> 
    <span class="n">node_field_data</span><span class="p">.</span><span class="n">nid</span> <span class="o">=</span> <span class="n">flagging_node_field_data</span><span class="p">.</span><span class="n">entity_id_int</span> <span class="k">AND</span> 
    <span class="n">flagging_node_field_data</span><span class="p">.</span><span class="n">flag_id</span> <span class="o">=</span> <span class="s1">'custom_flag_id'</span>
<span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">comment_entity_statistics</span> <span class="n">comment_entity_statistics</span> <span class="k">ON</span> 
    <span class="n">node_field_data</span><span class="p">.</span><span class="n">nid</span> <span class="o">=</span> <span class="n">comment_entity_statistics</span><span class="p">.</span><span class="n">entity_id</span> <span class="k">AND</span> 
    <span class="n">comment_entity_statistics</span><span class="p">.</span><span class="n">entity_type</span> <span class="o">=</span> <span class="s1">'node'</span> 
<span class="k">WHERE</span> 
    <span class="p">(</span><span class="n">node_field_data</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">'1'</span><span class="p">)</span> <span class="k">AND</span> 
    <span class="p">(</span><span class="n">node_field_data</span><span class="p">.</span><span class="k">type</span> <span class="k">IN</span> <span class="p">(</span><span class="s1">'topic'</span><span class="p">))</span> <span class="k">AND</span> 
    <span class="p">(</span><span class="n">comment_entity_statistics</span><span class="p">.</span><span class="n">comment_count</span> <span class="o">&gt;</span> <span class="s1">'0'</span><span class="p">)</span> 
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">node_field_data_changed</span> <span class="k">DESC</span> 
<span class="k">LIMIT</span> <span class="mi">10</span> <span class="k">OFFSET</span> <span class="mi">0</span><span class="p">;</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<p>Optimized <code class="language-plaintext highlighter-rouge">EXPLAIN</code> result:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td>
<td class="rouge-code"><pre><span class="o">+</span><span class="c1">----+-------------+---------------------------+------------+-------+--------------------------------------------------------------------------------------------+------------------------------------------------+---------+----------------------------------+------+----------+--------------------------+</span>
<span class="o">|</span> <span class="n">id</span> <span class="o">|</span> <span class="n">select_type</span> <span class="o">|</span> <span class="k">table</span>                     <span class="o">|</span> <span class="n">partitions</span> <span class="o">|</span> <span class="k">type</span>  <span class="o">|</span> <span class="n">possible_keys</span>                                                                              <span class="o">|</span> <span class="k">key</span>                                            <span class="o">|</span> <span class="n">key_len</span> <span class="o">|</span> <span class="k">ref</span>                              <span class="o">|</span> <span class="k">rows</span> <span class="o">|</span> <span class="n">filtered</span> <span class="o">|</span> <span class="n">Extra</span>                    <span class="o">|</span>
<span class="o">+</span><span class="c1">----+-------------+---------------------------+------------+-------+--------------------------------------------------------------------------------------------+------------------------------------------------+---------+----------------------------------+------+----------+--------------------------+</span>
<span class="o">|</span>  <span class="mi">1</span> <span class="o">|</span> <span class="k">SIMPLE</span>      <span class="o">|</span> <span class="n">node_field_data</span>           <span class="o">|</span> <span class="k">NULL</span>       <span class="o">|</span> <span class="k">index</span> <span class="o">|</span> <span class="k">PRIMARY</span><span class="p">,</span><span class="n">node__id__default_langcode__langcode</span><span class="p">,</span><span class="n">node_field__type__target_id</span><span class="p">,</span><span class="n">node__status_type</span> <span class="o">|</span> <span class="n">node_field__changed</span>                            <span class="o">|</span> <span class="mi">4</span>       <span class="o">|</span> <span class="k">NULL</span>                             <span class="o">|</span>   <span class="mi">36</span> <span class="o">|</span>     <span class="mi">5</span><span class="p">.</span><span class="mi">00</span> <span class="o">|</span> <span class="k">Using</span> <span class="k">where</span>              <span class="o">|</span>
<span class="o">|</span>  <span class="mi">1</span> <span class="o">|</span> <span class="k">SIMPLE</span>      <span class="o">|</span> <span class="n">comment_entity_statistics</span> <span class="o">|</span> <span class="k">NULL</span>       <span class="o">|</span> <span class="k">ref</span>   <span class="o">|</span> <span class="k">PRIMARY</span><span class="p">,</span><span class="n">comment_count</span><span class="p">,</span><span class="n">testing__entity_id__entity_type__comment_count</span>                       <span class="o">|</span> <span class="n">testing__entity_id__entity_type__comment_count</span> <span class="o">|</span> <span class="mi">38</span>      <span class="o">|</span> <span class="n">drupal</span><span class="p">.</span><span class="n">node_field_data</span><span class="p">.</span><span class="n">nid</span><span class="p">,</span><span class="n">const</span> <span class="o">|</span>    <span class="mi">1</span> <span class="o">|</span>    <span class="mi">50</span><span class="p">.</span><span class="mi">00</span> <span class="o">|</span> <span class="k">Using</span> <span class="k">where</span><span class="p">;</span> <span class="k">Using</span> <span class="k">index</span> <span class="o">|</span>
<span class="o">|</span>  <span class="mi">1</span> <span class="o">|</span> <span class="k">SIMPLE</span>      <span class="o">|</span> <span class="n">flagging_node_field_data</span>  <span class="o">|</span> <span class="k">NULL</span>       <span class="o">|</span> <span class="k">ref</span>   <span class="o">|</span> <span class="n">flagging_field__flag_id__target_id</span><span class="p">,</span><span class="n">better__flag_id__entity_id_int</span>                          <span class="o">|</span> <span class="n">better__flag_id__entity_id_int</span>                 <span class="o">|</span> <span class="mi">39</span>      <span class="o">|</span> <span class="n">drupal</span><span class="p">.</span><span class="n">node_field_data</span><span class="p">.</span><span class="n">nid</span><span class="p">,</span><span class="n">const</span> <span class="o">|</span>    <span class="mi">1</span> <span class="o">|</span>   <span class="mi">100</span><span class="p">.</span><span class="mi">00</span> <span class="o">|</span> <span class="k">NULL</span>                     <span class="o">|</span>
<span class="o">+</span><span class="c1">----+-------------+---------------------------+------------+-------+--------------------------------------------------------------------------------------------+------------------------------------------------+---------+----------------------------------+------+----------+--------------------------+</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

    </div>
<div class="tags rhythm-onehalf">
        <strong>Tagged with:</strong>
        
        <a class="postmeta__item postmeta__item--tag label" href="https://huzooka.github.io/tag/drupal">Drupal</a>
        
        <a class="postmeta__item postmeta__item--tag label" href="https://huzooka.github.io/tag/flag">Flag</a>
        
        <a class="postmeta__item postmeta__item--tag label" href="https://huzooka.github.io/tag/views">Views</a>
        
        <a class="postmeta__item postmeta__item--tag label" href="https://huzooka.github.io/tag/performance">Performance</a>
        
        <a class="postmeta__item postmeta__item--tag label" href="https://huzooka.github.io/tag/database-api">Database API</a>
        
    </div>
<a class="u-url" href="/development/2023/05/18/flagging-views.html" hidden></a>
</article>

      </div>
    </main><footer class="footer h-card bg-dark">
    <data class="u-url" href="/"></data>

    <div class="wrapper">
        <div class="footer__row">
            <div class="footer__col footer__col--slogan">
                <div class="slogan">
                    <span class="logo slogan__logo"></span>
                    <p class="slogan__slogan">The Github Page where I¬†temporarily publish my¬†professional posts</p>
                </div>
            </div>

            <div class="footer__col">
<ul class="menu-list font-heading">
<li class="menu-list__item h4">
        <a href="/about/">About</a>
    </li>
<li class="menu-list__item h4">
        <a href="https://huzooka.github.io/tag/drupal">Drupal</a>
    </li>
<li class="menu-list__item h4">
        <a href="https://huzooka.github.io/tag/migration">Migration</a>
    </li>
<li class="menu-list__item h4">
        <a href="/feed.xml">RSS</a>
    </li>
</ul>
</div>

            <div class="footer__col">
<ul class="menu-list font-heading">
<li class="menu-list__item h4"><a href="https://drupal.org/u/huzooka" target="_blank" rel="noopener noreferrer">Drupal.org</a></li>
<li class="menu-list__item h4"><a href="https://github.com/zolhorvath" target="_blank" rel="noopener noreferrer">Github</a></li>
<li class="menu-list__item h4"><a href="https://www.linkedin.com/in/zoltan-attila-horvath" target="_blank" rel="noopener noreferrer">Linkedin</a></li>
<li class="menu-list__item h4"><a href="https://www.twitter.com/huzooka" target="_blank" rel="noopener noreferrer">Twitter</a></li>
</ul>
</div>
        </div>
    </div>
</footer>
</body>

</html>
