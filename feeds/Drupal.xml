<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.2.2">Jekyll</generator><link href="https://huzooka.github.io/feeds/Drupal.xml" rel="self" type="application/atom+xml" /><link href="https://huzooka.github.io/" rel="alternate" type="text/html" /><updated>2023-06-19T05:27:28+00:00</updated><id>https://huzooka.github.io/feeds/Drupal.xml</id><title type="html">HuZooka</title><subtitle>The Github Page where I temporarily publish my professional posts</subtitle><author><name>Zoltán Horváth</name></author><entry><title type="html">Views with Flaggings? You Can Make Them Fast!</title><link href="https://huzooka.github.io/development/2023/05/18/flagging-views.html" rel="alternate" type="text/html" title="Views with Flaggings? You Can Make Them Fast!" /><published>2023-05-18T14:24:57+00:00</published><updated>2023-05-18T14:24:57+00:00</updated><id>https://huzooka.github.io/development/2023/05/18/flagging-views</id><content type="html" xml:base="https://huzooka.github.io/development/2023/05/18/flagging-views.html"><![CDATA[<p class="lead">Nowadays, I am working on the migration of a Drupal 7 site with millions of nodes and 10 millions of comments. We also have some flaggings to import. But after we managed to migrate all the <em>Flagging</em> entities we needed, we found that our views on the main page got extremely slow 😳. As it turned out, we had an extremely slow Views query which used <em>flagging</em> relationship.</p>

<h2 id="the-problem">The problem</h2>

<p>The extremely slow query is caused by the different data type used in the <em>flagging</em> table. Nodes, comments (basically most the content entities I’m aware of) are using unsigned integers for their ID column, while <em>flagging</em> uses varchar. And in my opinion, <strong>Flag module is right!</strong> There is no constraint which forces entities to have integer IDs: it is just the default type in case of <em>content</em> entities.</p>

<p>Anyway, the query we need to execute joins <code class="language-plaintext highlighter-rouge">flagging</code> and <code class="language-plaintext highlighter-rouge">node_field_data</code> tables by comparing a <code class="language-plaintext highlighter-rouge">VARCHAR</code> column to an <code class="language-plaintext highlighter-rouge">INT</code> column. This has two disadvantages:</p>
<ol>
  <li>Comparison falls back to floating-point comparison which isn’t precize at all and this is also much slower than comparing a <code class="language-plaintext highlighter-rouge">VARCHAR</code> to <code class="language-plaintext highlighter-rouge">VARCHAR</code> or <code class="language-plaintext highlighter-rouge">INT</code> to <code class="language-plaintext highlighter-rouge">INT</code>. Size and other configurations also must match – in an ideal situation, an <code class="language-plaintext highlighter-rouge">INT(10) UNSIGNED</code> column should be compared to another <code class="language-plaintext highlighter-rouge">INT(10) UNSIGNED</code>).</li>
  <li><a href="https://dev.mysql.com/doc/refman/8.0/en/type-conversion.html">MySQL/MariaDB cannot use index</a>, so the query will be much slower:
    <blockquote>
      <p>For comparisons of a string column with a number, MySQL cannot use an index on the column to look up the value quickly.</p>
    </blockquote>

    <p>(By the way, there is no such index on the <code class="language-plaintext highlighter-rouge">flagging</code> table anyway.)</p>
  </li>
</ol>

<p>The simple solution would be to change the data type of the <code class="language-plaintext highlighter-rouge">entity_id</code> in the <code class="language-plaintext highlighter-rouge">flagging</code> table <strong>and</strong> add an index, but I think that would be a very bad idea, because if we did, it would break Flag module’s current capabilities and would possibly cause issues even if newer Flag releases try to change or update the column.</p>

<h2 id="the-solution-we-applied-for-views">The solution we applied (for Views)</h2>

<p>We decided to add a new integer column to the <code class="language-plaintext highlighter-rouge">flagging</code> table, then in Flag module’s <a href="https://git.drupalcode.org/project/flag/-/blob/9e12a609b2/src/Plugin/views/relationship/FlagViewsRelationship.php">Views relationship plugin</a>, we could use this column if the base table’s column’s type is also integer. So the tasks were:</p>

<ul>
  <li>Add a new column to the base table of flagging entities (so to the <code class="language-plaintext highlighter-rouge">flagging</code> table: <code class="language-plaintext highlighter-rouge">entity_id_int INT(10) UNSIGNED</code> defaulting to <code class="language-plaintext highlighter-rouge">NULL</code>).</li>
  <li>Ask the Flag module to fill this column with the value of flagging’s <code class="language-plaintext highlighter-rouge">entity_id</code> property if the property value is numeric.</li>
  <li>Change the related query added by the <code class="language-plaintext highlighter-rouge">flag_relationship</code> plugin, so if flagging records are joined and the other table’s appropriate column has integer type, we change <code class="language-plaintext highlighter-rouge">flagging.entity_id</code> column to <code class="language-plaintext highlighter-rouge">flagging.entity_id_int</code></li>
  <li>Add the appropriate index with an enhanced flagging storage schema handler.</li>
  <li>In an update hook, install the new column and the new storage schema handler.</li>
  <li>In a post update function, fill the new column with the values fetched from the preexisting record’s <code class="language-plaintext highlighter-rouge">entity_id</code> column.</li>
</ul>

<h3 id="new-base-field">New base field</h3>

<p>The easiest (and the Drupal-) way to add a new column to the base table of an entity is adding a new base field. Base fields are available for every entity bundle, which makes them the best fit for our situation too.</p>

<p>To add a new base field to an entity type provided by another module, we can implement <code class="language-plaintext highlighter-rouge">hook_entity_base_field_info()</code> (see the <a href="https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Core%21Entity%21ContentEntityBase.php/function/ContentEntityBase%3A%3AbaseFieldDefinitions">documentation at <code class="language-plaintext highlighter-rouge">ContentEntityBase::baseFieldDefinitions</code></a>):</p>

<div data-file="better_flag.module" class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="cd">/**
 * Implements hook_entity_base_field_info().
 */</span>
<span class="k">function</span> <span class="n">better_flag_entity_base_field_info</span><span class="p">(</span><span class="kt">EntityTypeInterface</span> <span class="nv">$entity_type</span><span class="p">):</span> <span class="kt">array</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$entity_type</span><span class="o">-&gt;</span><span class="nf">id</span><span class="p">()</span> <span class="o">!==</span> <span class="s1">'flagging'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[];</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="p">[</span>
    <span class="s1">'entity_id_int'</span> <span class="o">=&gt;</span> <span class="nc">BaseFieldDefinition</span><span class="o">::</span><span class="nf">create</span><span class="p">(</span><span class="s1">'integer'</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="nf">setLabel</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Entity ID as integer'</span><span class="p">))</span>
      <span class="o">-&gt;</span><span class="nf">setDescription</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="s1">'The ID of the flagged entity if it is integer.'</span><span class="p">))</span>
      <span class="o">-&gt;</span><span class="nf">setSetting</span><span class="p">(</span><span class="s1">'unsigned'</span><span class="p">,</span> <span class="kc">TRUE</span><span class="p">)</span>
      <span class="c1">// Provider must be set to 'flag'.</span>
      <span class="c1">// - If it's set to 'better_flag' then on uninstall, ModuleInstaller tries</span>
      <span class="c1">//   to remove it even if we delete this field in our uninstall hook. Why?</span>
      <span class="c1">//   Because this hook gets invoked!</span>
      <span class="c1">// - But if we don't do anything on uninstall, the entity schema won't be</span>
      <span class="c1">//   updated and the 'flagging' entity's schema will be outdated - meaning</span>
      <span class="c1">//   that the extra column in DB won't be removed.</span>
      <span class="o">-&gt;</span><span class="nf">setProvider</span><span class="p">(</span><span class="s1">'flag'</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="nf">setInitialValue</span><span class="p">(</span><span class="kc">NULL</span><span class="p">),</span>
  <span class="p">];</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Of course, if the entity was already available before our module was installed, we have to provide an update hook to have its column installed to the database table. This is one of the tasks that <code class="language-plaintext highlighter-rouge">EntityDefinitionUpdateManager</code> was designed for!</p>

<div data-file="better_flag.install" class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="cd">/**
 * Installs 'entity_id_int' column to Flagging entities' DB table.
 */</span>
<span class="k">function</span> <span class="n">better_flag_update_9001</span><span class="p">():</span> <span class="kt">void</span> <span class="p">{</span>
  <span class="err">\</span><span class="nc">Drupal</span><span class="o">::</span><span class="nf">entityDefinitionUpdateManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">installFieldStorageDefinition</span><span class="p">(</span>
    <span class="s1">'entity_id_int'</span><span class="p">,</span>
    <span class="s1">'flagging'</span><span class="p">,</span>
    <span class="s1">'flag'</span><span class="p">,</span>
    <span class="nc">BaseFieldDefinition</span><span class="o">::</span><span class="nf">create</span><span class="p">(</span><span class="s1">'integer'</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="nf">setLabel</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Entity ID as integer'</span><span class="p">))</span>
      <span class="o">-&gt;</span><span class="nf">setDescription</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="s1">'The ID of the flagged entity if it is integer.'</span><span class="p">))</span>
      <span class="o">-&gt;</span><span class="nf">setSetting</span><span class="p">(</span><span class="s1">'unsigned'</span><span class="p">,</span> <span class="kc">TRUE</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="nf">setInitialValue</span><span class="p">(</span><span class="kc">NULL</span><span class="p">)</span>
  <span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>After our new base field was installed in the update hook above, we weren’t done yet:</p>
<ol>
  <li>We still had to update every pre-existing record, so they will have the right value in the new base field.</li>
  <li>We also had to ensure that new flaggings would have the appropriate value there.</li>
</ol>

<p>Let’s fill the new column with the right value for the preexisting flagging entities! Ideally, this should be done in a post update function. We only updated those records where the value of the original <code class="language-plaintext highlighter-rouge">entity_id</code> column only contained integer characters:</p>

<div data-file="better_flag.post_update.php" class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="cd">/**
 * Fill 'entity_id_int' column values.
 */</span>
<span class="k">function</span> <span class="n">better_flag_post_update_fill_entity_id_integer_column</span><span class="p">():</span> <span class="kt">void</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="nv">$flagging_definition</span> <span class="o">=</span> <span class="err">\</span><span class="nc">Drupal</span><span class="o">::</span><span class="nf">entityTypeManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getDefinition</span><span class="p">(</span><span class="s1">'flagging'</span><span class="p">);</span>
    <span class="nv">$connection</span> <span class="o">=</span> <span class="err">\</span><span class="nc">Drupal</span><span class="o">::</span><span class="nf">database</span><span class="p">();</span>
    <span class="nv">$regexp_operator</span> <span class="o">=</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="nf">databaseType</span><span class="p">()</span> <span class="o">===</span> <span class="s1">'pgsql'</span> <span class="o">?</span> <span class="s1">'~'</span> <span class="o">:</span> <span class="s1">'REGEXP'</span><span class="p">;</span>
    
    <span class="nv">$connection</span><span class="o">-&gt;</span><span class="nf">update</span><span class="p">(</span><span class="nv">$flagging_definition</span><span class="o">-&gt;</span><span class="nf">getBaseTable</span><span class="p">())</span>
      <span class="o">-&gt;</span><span class="nb">expression</span><span class="p">(</span><span class="s1">'entity_id_int'</span><span class="p">,</span> <span class="s1">'entity_id'</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'entity_id'</span><span class="p">,</span> <span class="s1">'^[0-9]+$'</span><span class="p">,</span> <span class="nv">$regexp_operator</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="nf">execute</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">catch</span> <span class="p">(</span><span class="err">\</span><span class="nc">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nc">UpdateException</span><span class="p">(</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="nf">getMessage</span><span class="p">());</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>After this, in a <code class="language-plaintext highlighter-rouge">hook_ENTITY_TYPE_presave()</code> implementation, we ensured that new flaggings have the right value in the new <code class="language-plaintext highlighter-rouge">entity_id_int</code> field.</p>

<div data-file="better_flag.module" class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="cd">/**
 * Implements hook_ENTITY_TYPE_presave() for flagging.
 */</span>
<span class="k">function</span> <span class="n">better_flag_flagging_presave</span><span class="p">(</span><span class="kt">EntityInterface</span> <span class="nv">$flagging</span><span class="p">)</span> <span class="p">{</span>
  <span class="nb">assert</span><span class="p">(</span><span class="nv">$flagging</span> <span class="k">instanceof</span> <span class="nc">FlaggingInterface</span><span class="p">);</span>
  <span class="nb">assert</span><span class="p">(</span><span class="nv">$flagging</span> <span class="k">instanceof</span> <span class="nc">ContentEntityBase</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/^\d{1,10}$/'</span><span class="p">,</span> <span class="nv">$flagged_entity_id</span> <span class="o">=</span> <span class="nv">$flagging</span><span class="o">-&gt;</span><span class="nf">getFlaggableId</span><span class="p">()))</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// We know that the entity ID is numeric (and it isn't longer than 10 digits),</span>
  <span class="c1">// so we can store the ID value in our extra integer field too.</span>
  <span class="nv">$flagging</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'entity_id_int'</span><span class="p">,</span> <span class="nv">$flagged_entity_id</span><span class="p">);</span>
  <span class="nv">$flagging</span><span class="o">-&gt;</span><span class="nf">updateOriginalValues</span><span class="p">();</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="views-relationship">Views relationship</h3>

<p>The next task was to make the <code class="language-plaintext highlighter-rouge">flag_relationship</code> Views plugin to use the new integer column for joining its table whenever the base table’s corresponding field also has an integer type.</p>

<p>Luckily, Views utilizes Plugin API for most of the components it is using. It is very easy to alter for example the <code class="language-plaintext highlighter-rouge">flag_relationship</code> plugin. We don’t have too many options, but all what we need to do is to replace the plugin’s class in the plugin definition with our enhanced, “smarter” class:</p>

<div data-file="src/Plugin/views/relationship/BetterFlagViewsRelationship.php" class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre><span class="cd">/**
 * Replacement class for FlagViewsRelationship.
 */</span>
<span class="kd">class</span> <span class="nc">BetterFlagViewsRelationship</span> <span class="kd">extends</span> <span class="nc">FlagViewsRelationship</span> <span class="p">{</span>

  <span class="cd">/**
   * {@inheritdoc}
   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="n">query</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span>
      <span class="c1">// We have a real DB column to join on.</span>
      <span class="k">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">realField</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
      <span class="c1">// The current display has an entity type.</span>
      <span class="o">!</span><span class="nb">empty</span><span class="p">(</span><span class="nv">$entity_type</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getEntityType</span><span class="p">())</span> <span class="o">&amp;&amp;</span>
      <span class="c1">// The column is one of the base fields of the entity type.</span>
      <span class="p">(</span><span class="nv">$base_field_definition</span> <span class="o">=</span> <span class="err">\</span><span class="nc">Drupal</span><span class="o">::</span><span class="nf">service</span><span class="p">(</span><span class="s1">'entity_field.manager'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getBaseFieldDefinitions</span><span class="p">(</span><span class="nv">$entity_type</span><span class="p">)[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">realField</span><span class="p">]</span> <span class="o">??</span> <span class="kc">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
      <span class="c1">// The type of the column is integer.</span>
      <span class="p">(</span><span class="nv">$base_field_definition</span> <span class="k">instanceof</span> <span class="nc">FieldDefinitionInterface</span> <span class="o">&amp;&amp;</span> <span class="nv">$base_field_definition</span><span class="o">-&gt;</span><span class="nb">getType</span><span class="p">()</span> <span class="o">===</span> <span class="s1">'integer'</span><span class="p">)</span>
    <span class="p">)</span> <span class="p">{</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">definition</span><span class="p">[</span><span class="s1">'base field'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'entity_id_int'</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">parent</span><span class="o">::</span><span class="nf">query</span><span class="p">();</span>
  <span class="p">}</span>

<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>After this we could go ahead and change the plugin definition by using a <code class="language-plaintext highlighter-rouge">hook_views_plugins_relationship_alter()</code> hook:</p>

<div data-file="better_flag.module" class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="cd">/**
 * Implements hook_views_plugins_relationship_alter().
 */</span>
<span class="k">function</span> <span class="n">better_flag_views_plugins_relationship_alter</span><span class="p">(</span><span class="kt">array</span> <span class="o">&amp;</span><span class="nv">$plugins</span><span class="p">):</span> <span class="kt">void</span> <span class="p">{</span>
  <span class="c1">// Replaces flag_relationship views plugin with our own, improved version</span>
  <span class="c1">// which then speeds up queries using integer type of entity ID column in case</span>
  <span class="c1">// of joins.</span>
  <span class="k">if</span> <span class="p">(</span>
    <span class="k">isset</span><span class="p">(</span><span class="nv">$plugins</span><span class="p">[</span><span class="s1">'flag_relationship'</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
    <span class="nv">$plugins</span><span class="p">[</span><span class="s1">'flag_relationship'</span><span class="p">][</span><span class="s1">'class'</span><span class="p">]</span> <span class="o">===</span> <span class="nc">FlagViewsRelationship</span><span class="o">::</span><span class="n">class</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="nv">$plugins</span><span class="p">[</span><span class="s1">'flag_relationship'</span><span class="p">][</span><span class="s1">'class'</span><span class="p">]</span> <span class="o">=</span> <span class="nc">BetterFlagViewsRelationship</span><span class="o">::</span><span class="n">class</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="extend-the-entity-table-with-new-indexes">Extend the entity table with new indexes</h3>

<p>Finally, we extended the <a href="https://git.drupalcode.org/project/flag/-/blob/9e12a609b2/src/Entity/Storage/FlaggingStorageSchema.php">storage schema</a> of flagging entities. Why? Because without having the matching index in place, the query still took about 1200—1500ms to finish with about 1 million flaggings.</p>

<p><em>This is a bit of a fragile solution</em>: we cannot decorate these handlers, we can only change them. If another module has to do the same to flaggings, our replacement storage schema handler might be replaced, and we can’t take advantage of our dedicated index. All we can do is add a PHPUnit test that checks the schema handler of flaggings with all the modules in our project installed.</p>

<p>This is our replacement storage schema handler which adds the new index with <code class="language-plaintext highlighter-rouge">flag_id</code> and <code class="language-plaintext highlighter-rouge">entity_id_int</code>:</p>

<div data-file="src/Entity/Storage/BetterFlaggingStorageSchema.php" class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="cd">/**
 * Replacement class for Flagging entity storage schema handler.
 */</span>
<span class="kd">class</span> <span class="nc">BetterFlaggingStorageSchema</span> <span class="kd">extends</span> <span class="nc">FlaggingStorageSchema</span> <span class="p">{</span>

  <span class="cd">/**
   * {@inheritdoc}
   */</span>
  <span class="k">protected</span> <span class="k">function</span> <span class="n">getEntitySchema</span><span class="p">(</span><span class="kt">ContentEntityTypeInterface</span> <span class="nv">$entity_type</span><span class="p">,</span> <span class="nv">$reset</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$schema</span> <span class="o">=</span> <span class="k">parent</span><span class="o">::</span><span class="nf">getEntitySchema</span><span class="p">(</span><span class="nv">$entity_type</span><span class="p">,</span> <span class="nv">$reset</span><span class="p">);</span>
    <span class="nv">$schema</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">entityType</span><span class="o">-&gt;</span><span class="nf">getBaseTable</span><span class="p">()][</span><span class="s1">'indexes'</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span>
      <span class="s1">'better__flag_id__entity_id_int'</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">'flag_id'</span><span class="p">,</span>
        <span class="s1">'entity_id_int'</span><span class="p">,</span>
      <span class="p">],</span>
    <span class="p">];</span>

    <span class="k">return</span> <span class="nv">$schema</span><span class="p">;</span>
  <span class="p">}</span>

<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Of course, we also had to replace the original handler with our own. This can be done with a <code class="language-plaintext highlighter-rouge">hook_entity_type_alter()</code> implementation:</p>

<div data-file="better_flag.module" class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="cd">/**
 * Implements hook_entity_type_alter().
 */</span>
<span class="k">function</span> <span class="n">better_flag_entity_type_alter</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$entity_types</span><span class="p">):</span> <span class="kt">void</span> <span class="p">{</span>
  <span class="c1">// Replace storage schema class of flagging entities.</span>
  <span class="nb">assert</span><span class="p">(</span><span class="nv">$entity_types</span><span class="p">[</span><span class="s1">'flagging'</span><span class="p">]</span> <span class="k">instanceof</span> <span class="nc">EntityTypeInterface</span><span class="p">);</span>
  <span class="nv">$entity_types</span><span class="p">[</span><span class="s1">'flagging'</span><span class="p">]</span><span class="o">-&gt;</span><span class="nf">setHandlerClass</span><span class="p">(</span><span class="s1">'storage_schema'</span><span class="p">,</span> <span class="nc">BetterFlaggingStorageSchema</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>As the last step, we needed yet another update hook where we could install the new storage schema. In our case, this means that – under the hood – Drupal will drop every preexisting index on the corresponding table(s) and then recreate the new ones.</p>

<div data-file="better_flag.install" class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="cd">/**
 * Install the new storage schema handler of flagging entities.
 */</span>
<span class="k">function</span> <span class="n">better_flag_update_9002</span><span class="p">():</span> <span class="kt">void</span> <span class="p">{</span>
  <span class="nv">$entity_definition_update_manager</span> <span class="o">=</span> <span class="err">\</span><span class="nc">Drupal</span><span class="o">::</span><span class="nf">entityDefinitionUpdateManager</span><span class="p">();</span>
  <span class="nv">$entity_type</span> <span class="o">=</span> <span class="nv">$entity_definition_update_manager</span><span class="o">-&gt;</span><span class="nf">getEntityType</span><span class="p">(</span><span class="s1">'flagging'</span><span class="p">);</span>
  <span class="nv">$entity_type</span><span class="o">-&gt;</span><span class="nf">setHandlerClass</span><span class="p">(</span><span class="s1">'storage_schema'</span><span class="p">,</span> <span class="nc">BetterFlaggingStorageSchema</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
  <span class="nv">$entity_definition_update_manager</span><span class="o">-&gt;</span><span class="nf">updateEntityType</span><span class="p">(</span><span class="nv">$entity_type</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>That was all!</strong></p>

<h2 id="diagnostic">Diagnostic</h2>

<p>If you’ve reached this line, I’m pretty sure you’re wondering what happened to the Views database query. “Unfortunately”, I was not patient enough to wait for the unoptimized database query to finish 😶.</p>

<h3 id="original">Original</h3>

<p>This was the original query (no result after <strong>~30 minutes</strong>):</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="k">SELECT</span> 
    <span class="n">node_field_data</span><span class="p">.</span><span class="n">langcode</span> <span class="k">AS</span> <span class="n">node_field_data_langcode</span><span class="p">,</span> 
    <span class="n">flagging_node_field_data</span><span class="p">.</span><span class="n">uid</span> <span class="k">AS</span> <span class="n">flagging_node_field_data_uid</span><span class="p">,</span> 
    <span class="n">node_field_data</span><span class="p">.</span><span class="n">changed</span> <span class="k">AS</span> <span class="n">node_field_data_changed</span><span class="p">,</span> 
    <span class="n">node_field_data</span><span class="p">.</span><span class="n">nid</span> <span class="k">AS</span> <span class="n">nid</span><span class="p">,</span> 
    <span class="n">flagging_node_field_data</span><span class="p">.</span><span class="n">id</span> <span class="k">AS</span> <span class="n">flagging_node_field_data_id</span> 
<span class="k">FROM</span> <span class="n">node_field_data</span> <span class="n">node_field_data</span> 
<span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">flagging</span> <span class="n">flagging_node_field_data</span> <span class="k">ON</span> 
    <span class="n">node_field_data</span><span class="p">.</span><span class="n">nid</span> <span class="o">=</span> <span class="n">flagging_node_field_data</span><span class="p">.</span><span class="n">entity_id</span> <span class="k">AND</span> 
    <span class="n">flagging_node_field_data</span><span class="p">.</span><span class="n">flag_id</span> <span class="o">=</span> <span class="s1">'custom_flag_id'</span> 
<span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">comment_entity_statistics</span> <span class="n">comment_entity_statistics</span> <span class="k">ON</span> 
    <span class="n">node_field_data</span><span class="p">.</span><span class="n">nid</span> <span class="o">=</span> <span class="n">comment_entity_statistics</span><span class="p">.</span><span class="n">entity_id</span> <span class="k">AND</span> 
    <span class="n">comment_entity_statistics</span><span class="p">.</span><span class="n">entity_type</span> <span class="o">=</span> <span class="s1">'node'</span> 
<span class="k">WHERE</span> 
    <span class="p">(</span><span class="n">node_field_data</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">'1'</span><span class="p">)</span> <span class="k">AND</span> 
    <span class="p">(</span><span class="n">node_field_data</span><span class="p">.</span><span class="k">type</span> <span class="k">IN</span> <span class="p">(</span><span class="s1">'topic'</span><span class="p">))</span> <span class="k">AND</span> 
    <span class="p">(</span><span class="n">comment_entity_statistics</span><span class="p">.</span><span class="n">comment_count</span> <span class="o">&gt;</span> <span class="s1">'0'</span><span class="p">)</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">node_field_data_changed</span> <span class="k">DESC</span> 
<span class="k">LIMIT</span> <span class="mi">10</span> <span class="k">OFFSET</span> <span class="mi">0</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Original <code class="language-plaintext highlighter-rouge">EXPLAIN</code> result:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="o">+</span><span class="c1">----+-------------+---------------------------+------------+-------+--------------------------------------------------------------------------------------------+--------------------------------------+---------+--------------------------------------------+---------+----------+-----------------------------------------------------------+</span>
<span class="o">|</span> <span class="n">id</span> <span class="o">|</span> <span class="n">select_type</span> <span class="o">|</span> <span class="k">table</span>                     <span class="o">|</span> <span class="n">partitions</span> <span class="o">|</span> <span class="k">type</span>  <span class="o">|</span> <span class="n">possible_keys</span>                                                                              <span class="o">|</span> <span class="k">key</span>                                  <span class="o">|</span> <span class="n">key_len</span> <span class="o">|</span> <span class="k">ref</span>                                        <span class="o">|</span> <span class="k">rows</span>    <span class="o">|</span> <span class="n">filtered</span> <span class="o">|</span> <span class="n">Extra</span>                                                     <span class="o">|</span>
<span class="o">+</span><span class="c1">----+-------------+---------------------------+------------+-------+--------------------------------------------------------------------------------------------+--------------------------------------+---------+--------------------------------------------+---------+----------+-----------------------------------------------------------+</span>
<span class="o">|</span>  <span class="mi">1</span> <span class="o">|</span> <span class="k">SIMPLE</span>      <span class="o">|</span> <span class="n">comment_entity_statistics</span> <span class="o">|</span> <span class="k">NULL</span>       <span class="o">|</span> <span class="k">range</span> <span class="o">|</span> <span class="k">PRIMARY</span><span class="p">,</span><span class="n">comment_count</span><span class="p">,</span><span class="n">testing__entity_id__entity_type__comment_count</span>                       <span class="o">|</span> <span class="n">comment_count</span>                        <span class="o">|</span> <span class="mi">4</span>       <span class="o">|</span> <span class="k">NULL</span>                                       <span class="o">|</span> <span class="mi">1874806</span> <span class="o">|</span>    <span class="mi">10</span><span class="p">.</span><span class="mi">00</span> <span class="o">|</span> <span class="k">Using</span> <span class="k">where</span><span class="p">;</span> <span class="k">Using</span> <span class="k">index</span><span class="p">;</span> <span class="k">Using</span> <span class="k">temporary</span><span class="p">;</span> <span class="k">Using</span> <span class="n">filesort</span> <span class="o">|</span>
<span class="o">|</span>  <span class="mi">1</span> <span class="o">|</span> <span class="k">SIMPLE</span>      <span class="o">|</span> <span class="n">node_field_data</span>           <span class="o">|</span> <span class="k">NULL</span>       <span class="o">|</span> <span class="k">ref</span>   <span class="o">|</span> <span class="k">PRIMARY</span><span class="p">,</span><span class="n">node__id__default_langcode__langcode</span><span class="p">,</span><span class="n">node_field__type__target_id</span><span class="p">,</span><span class="n">node__status_type</span> <span class="o">|</span> <span class="n">node__id__default_langcode__langcode</span> <span class="o">|</span> <span class="mi">4</span>       <span class="o">|</span> <span class="n">drupal</span><span class="p">.</span><span class="n">comment_entity_statistics</span><span class="p">.</span><span class="n">entity_id</span> <span class="o">|</span>       <span class="mi">1</span> <span class="o">|</span>     <span class="mi">5</span><span class="p">.</span><span class="mi">00</span> <span class="o">|</span> <span class="k">Using</span> <span class="k">where</span>                                               <span class="o">|</span>
<span class="o">|</span>  <span class="mi">1</span> <span class="o">|</span> <span class="k">SIMPLE</span>      <span class="o">|</span> <span class="n">flagging_node_field_data</span>  <span class="o">|</span> <span class="k">NULL</span>       <span class="o">|</span> <span class="k">ref</span>   <span class="o">|</span> <span class="n">flagging_field__flag_id__target_id</span><span class="p">,</span><span class="n">entity_id__uid</span>                                          <span class="o">|</span> <span class="n">flagging_field__flag_id__target_id</span>   <span class="o">|</span> <span class="mi">34</span>      <span class="o">|</span> <span class="n">const</span>                                      <span class="o">|</span>    <span class="mi">3091</span> <span class="o">|</span>   <span class="mi">100</span><span class="p">.</span><span class="mi">00</span> <span class="o">|</span> <span class="k">Using</span> <span class="k">where</span>                                               <span class="o">|</span>
<span class="o">+</span><span class="c1">----+-------------+---------------------------+------------+-------+--------------------------------------------------------------------------------------------+--------------------------------------+---------+--------------------------------------------+---------+----------+-----------------------------------------------------------+</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="optimized-query">Optimized query</h3>

<p>This is the optimized query – it finishes in <strong>1ms-3ms</strong>!:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="k">SELECT</span>
    <span class="n">node_field_data</span><span class="p">.</span><span class="n">langcode</span> <span class="k">AS</span> <span class="n">node_field_data_langcode</span><span class="p">,</span> 
    <span class="n">flagging_node_field_data</span><span class="p">.</span><span class="n">uid</span> <span class="k">AS</span> <span class="n">flagging_node_field_data_uid</span><span class="p">,</span> 
    <span class="n">node_field_data</span><span class="p">.</span><span class="n">changed</span> <span class="k">AS</span> <span class="n">node_field_data_changed</span><span class="p">,</span> 
    <span class="n">node_field_data</span><span class="p">.</span><span class="n">nid</span> <span class="k">AS</span> <span class="n">nid</span><span class="p">,</span> 
    <span class="n">flagging_node_field_data</span><span class="p">.</span><span class="n">id</span> <span class="k">AS</span> <span class="n">flagging_node_field_data_id</span> 
<span class="k">FROM</span> <span class="n">node_field_data</span> <span class="n">node_field_data</span> 
<span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">flagging</span> <span class="n">flagging_node_field_data</span> <span class="k">ON</span> 
    <span class="n">node_field_data</span><span class="p">.</span><span class="n">nid</span> <span class="o">=</span> <span class="n">flagging_node_field_data</span><span class="p">.</span><span class="n">entity_id_int</span> <span class="k">AND</span> 
    <span class="n">flagging_node_field_data</span><span class="p">.</span><span class="n">flag_id</span> <span class="o">=</span> <span class="s1">'custom_flag_id'</span>
<span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">comment_entity_statistics</span> <span class="n">comment_entity_statistics</span> <span class="k">ON</span> 
    <span class="n">node_field_data</span><span class="p">.</span><span class="n">nid</span> <span class="o">=</span> <span class="n">comment_entity_statistics</span><span class="p">.</span><span class="n">entity_id</span> <span class="k">AND</span> 
    <span class="n">comment_entity_statistics</span><span class="p">.</span><span class="n">entity_type</span> <span class="o">=</span> <span class="s1">'node'</span> 
<span class="k">WHERE</span> 
    <span class="p">(</span><span class="n">node_field_data</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">'1'</span><span class="p">)</span> <span class="k">AND</span> 
    <span class="p">(</span><span class="n">node_field_data</span><span class="p">.</span><span class="k">type</span> <span class="k">IN</span> <span class="p">(</span><span class="s1">'topic'</span><span class="p">))</span> <span class="k">AND</span> 
    <span class="p">(</span><span class="n">comment_entity_statistics</span><span class="p">.</span><span class="n">comment_count</span> <span class="o">&gt;</span> <span class="s1">'0'</span><span class="p">)</span> 
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">node_field_data_changed</span> <span class="k">DESC</span> 
<span class="k">LIMIT</span> <span class="mi">10</span> <span class="k">OFFSET</span> <span class="mi">0</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Optimized <code class="language-plaintext highlighter-rouge">EXPLAIN</code> result:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="o">+</span><span class="c1">----+-------------+---------------------------+------------+-------+--------------------------------------------------------------------------------------------+------------------------------------------------+---------+----------------------------------+------+----------+--------------------------+</span>
<span class="o">|</span> <span class="n">id</span> <span class="o">|</span> <span class="n">select_type</span> <span class="o">|</span> <span class="k">table</span>                     <span class="o">|</span> <span class="n">partitions</span> <span class="o">|</span> <span class="k">type</span>  <span class="o">|</span> <span class="n">possible_keys</span>                                                                              <span class="o">|</span> <span class="k">key</span>                                            <span class="o">|</span> <span class="n">key_len</span> <span class="o">|</span> <span class="k">ref</span>                              <span class="o">|</span> <span class="k">rows</span> <span class="o">|</span> <span class="n">filtered</span> <span class="o">|</span> <span class="n">Extra</span>                    <span class="o">|</span>
<span class="o">+</span><span class="c1">----+-------------+---------------------------+------------+-------+--------------------------------------------------------------------------------------------+------------------------------------------------+---------+----------------------------------+------+----------+--------------------------+</span>
<span class="o">|</span>  <span class="mi">1</span> <span class="o">|</span> <span class="k">SIMPLE</span>      <span class="o">|</span> <span class="n">node_field_data</span>           <span class="o">|</span> <span class="k">NULL</span>       <span class="o">|</span> <span class="k">index</span> <span class="o">|</span> <span class="k">PRIMARY</span><span class="p">,</span><span class="n">node__id__default_langcode__langcode</span><span class="p">,</span><span class="n">node_field__type__target_id</span><span class="p">,</span><span class="n">node__status_type</span> <span class="o">|</span> <span class="n">node_field__changed</span>                            <span class="o">|</span> <span class="mi">4</span>       <span class="o">|</span> <span class="k">NULL</span>                             <span class="o">|</span>   <span class="mi">36</span> <span class="o">|</span>     <span class="mi">5</span><span class="p">.</span><span class="mi">00</span> <span class="o">|</span> <span class="k">Using</span> <span class="k">where</span>              <span class="o">|</span>
<span class="o">|</span>  <span class="mi">1</span> <span class="o">|</span> <span class="k">SIMPLE</span>      <span class="o">|</span> <span class="n">comment_entity_statistics</span> <span class="o">|</span> <span class="k">NULL</span>       <span class="o">|</span> <span class="k">ref</span>   <span class="o">|</span> <span class="k">PRIMARY</span><span class="p">,</span><span class="n">comment_count</span><span class="p">,</span><span class="n">testing__entity_id__entity_type__comment_count</span>                       <span class="o">|</span> <span class="n">testing__entity_id__entity_type__comment_count</span> <span class="o">|</span> <span class="mi">38</span>      <span class="o">|</span> <span class="n">drupal</span><span class="p">.</span><span class="n">node_field_data</span><span class="p">.</span><span class="n">nid</span><span class="p">,</span><span class="n">const</span> <span class="o">|</span>    <span class="mi">1</span> <span class="o">|</span>    <span class="mi">50</span><span class="p">.</span><span class="mi">00</span> <span class="o">|</span> <span class="k">Using</span> <span class="k">where</span><span class="p">;</span> <span class="k">Using</span> <span class="k">index</span> <span class="o">|</span>
<span class="o">|</span>  <span class="mi">1</span> <span class="o">|</span> <span class="k">SIMPLE</span>      <span class="o">|</span> <span class="n">flagging_node_field_data</span>  <span class="o">|</span> <span class="k">NULL</span>       <span class="o">|</span> <span class="k">ref</span>   <span class="o">|</span> <span class="n">flagging_field__flag_id__target_id</span><span class="p">,</span><span class="n">better__flag_id__entity_id_int</span>                          <span class="o">|</span> <span class="n">better__flag_id__entity_id_int</span>                 <span class="o">|</span> <span class="mi">39</span>      <span class="o">|</span> <span class="n">drupal</span><span class="p">.</span><span class="n">node_field_data</span><span class="p">.</span><span class="n">nid</span><span class="p">,</span><span class="n">const</span> <span class="o">|</span>    <span class="mi">1</span> <span class="o">|</span>   <span class="mi">100</span><span class="p">.</span><span class="mi">00</span> <span class="o">|</span> <span class="k">NULL</span>                     <span class="o">|</span>
<span class="o">+</span><span class="c1">----+-------------+---------------------------+------------+-------+--------------------------------------------------------------------------------------------+------------------------------------------------+---------+----------------------------------+------+----------+--------------------------+</span>
</pre></td></tr></tbody></table></code></pre></div></div>]]></content><author><name>Zoltán Horváth</name></author><category term="Development" /><category term="Drupal" /><category term="Flag" /><category term="Views" /><category term="Performance" /><category term="Database API" /><summary type="html"><![CDATA[How we accelerated our extremely slow Views queries which were using flagging relationship.]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://huzooka.github.io/files/image/snail.jpg" /><media:content medium="image" url="https://huzooka.github.io/files/image/snail.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Database Query Trick for SQL-based Migrate Source Plugins</title><link href="https://huzooka.github.io/development/2022/06/12/migrate-source-query-trick.html" rel="alternate" type="text/html" title="Database Query Trick for SQL-based Migrate Source Plugins" /><published>2022-06-12T04:37:37+00:00</published><updated>2022-06-12T04:37:37+00:00</updated><id>https://huzooka.github.io/development/2022/06/12/migrate-source-query-trick</id><content type="html" xml:base="https://huzooka.github.io/development/2022/06/12/migrate-source-query-trick.html"><![CDATA[<p class="lead">In my previous post about <a href="/development/2022/05/29/empty-properties-change-tracking.html">strange empty destination property handling</a> I mentioned <a href="https://www.drupal.org/u/yashrode">Yash Rode</a>’s brilliant <a href="https://drupal.org/i/3272705">YouTube field → media migration</a> feature. But I missed taking a note about a crucial trick we used there: how we managed to use a column alias as migration source item identifier.</p>

<h2 id="the-problem">The problem</h2>

<p>Let’s suppose there are multiple YouTube fields on the source Drupal 7 site! Each of them have different field names, so the field property column names are also different:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Field name</th>
      <th style="text-align: left">Input property column</th>
      <th style="text-align: left">Video ID column</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">field_yt_foo</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">field_yt_foo_input</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">field_yt_foo_video_id</code></td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">field_yt_bar</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">field_yt_bar_input</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">field_yt_bar_video_id</code></td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">field_yt_baz</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">field_yt_baz_input</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">field_yt_baz_video_id</code></td>
    </tr>
  </tbody>
</table>

<p>In Drupal’s Migrate API, SQL-based source plugins <a href="https://git.drupalcode.org/project/drupal/-/blob/3aaef92fe5/core/modules/migrate/src/Plugin/migrate/source/SqlBase.php#L379-L382">should return a database select query</a> (a <code class="language-plaintext highlighter-rouge">Drupal\Core\Database\Query\SelectInterface</code>). But how can we get all the data in a single database query? Well, we can’t. But we can use a separate query to get the list of the field names with the specified type:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="k">protected</span> <span class="k">function</span> <span class="n">getYouTubeFieldNames</span><span class="p">():</span> <span class="kt">array</span> <span class="p">{</span>
  <span class="nv">$youtube_fields</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">select</span><span class="p">(</span><span class="s1">'field_config'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">fields</span><span class="p">(</span><span class="s1">'field_config'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'field_name'</span><span class="p">])</span>
    <span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'type'</span><span class="p">,</span> <span class="s1">'youtube'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'module'</span><span class="p">,</span> <span class="s1">'youtube'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">execute</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="nf">fetchAllKeyed</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

  <span class="k">return</span> <span class="nb">array_values</span><span class="p">(</span><span class="nv">$youtube_fields</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>…Then use the list to build a <code class="language-plaintext highlighter-rouge">UNION</code> query (the <code class="language-plaintext highlighter-rouge">static::addUnionQuery()</code> is explained in this<sup id="fnref:union" role="doc-noteref"><a href="#fn:union" class="footnote" rel="footnote">1</a></sup> footnote):</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="cd">/**
 * {@inheritdoc}
 */</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">query</span><span class="p">()</span> <span class="p">{</span>
  <span class="nv">$union_query</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">;</span>
  <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getYouTubeFieldNames</span><span class="p">()</span> <span class="k">as</span> <span class="nv">$field_name</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$subquery</span> <span class="o">=</span> <span class="nv">$this</span>
      <span class="o">-&gt;</span><span class="nf">select</span><span class="p">(</span><span class="s2">"field_data_</span><span class="nv">$field_name</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$field_name</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="nf">fields</span><span class="p">(</span><span class="s2">"field_data_</span><span class="si">{</span><span class="nv">$field_name</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="p">[</span><span class="s2">"</span><span class="si">{</span><span class="nv">$field_name</span><span class="si">}</span><span class="s2">_input"</span><span class="p">]);</span>
    <span class="k">static</span><span class="o">::</span><span class="nf">addUnionQuery</span><span class="p">(</span><span class="nv">$union_query</span><span class="p">,</span> <span class="nv">$subquery</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nv">$union_query</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Query string:</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="k">SELECT</span>
  <span class="nv">"field_data_field_yt_foo"</span><span class="p">.</span><span class="nv">"field_yt_foo_input"</span> <span class="k">AS</span> <span class="nv">"field_yt_foo_input"</span>
<span class="k">FROM</span> <span class="p">{</span><span class="n">field_data_field_yt_foo</span><span class="p">}</span> <span class="nv">"field_yt_foo"</span>
<span class="k">UNION</span>
<span class="k">SELECT</span>
  <span class="nv">"field_data_field_yt_bar"</span><span class="p">.</span><span class="nv">"field_yt_bar_input"</span> <span class="k">AS</span> <span class="nv">"field_yt_bar_input"</span>
<span class="k">FROM</span> <span class="p">{</span><span class="n">field_data_field_yt_bar</span><span class="p">}</span> <span class="nv">"field_yt_bar"</span>
<span class="k">UNION</span>
<span class="k">SELECT</span>
  <span class="nv">"field_data_field_yt_baz"</span><span class="p">.</span><span class="nv">"field_yt_baz_input"</span> <span class="k">AS</span> <span class="nv">"field_yt_baz_input"</span>
<span class="k">FROM</span> <span class="p">{</span><span class="n">field_data_field_yt_baz</span><span class="p">}</span> <span class="nv">"field_yt_baz"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Unfortunately, we cannot really use this query as the iterator source of our migrate source: Migrate source plugins must specify which columns are identifying a single migration row. (These are called “<em>source IDs</em>”.) The identifier<sup id="fnref:idplural" role="doc-noteref"><a href="#fn:idplural" class="footnote" rel="footnote">2</a></sup> should be unique for every migrate source item. If they aren’t unique, every next item with the same ID will be ignored during the migration<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">3</a></sup>.</p>

<p>So instead of using the name of the <code class="language-plaintext highlighter-rouge">input</code> field property, let’s use an alias, and define the alias as source item identifier!</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="cd">/**
 * {@inheritdoc}
 */</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">query</span><span class="p">()</span> <span class="p">{</span>
  <span class="nv">$union_query</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">;</span>
  <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getYouTubeFieldNames</span><span class="p">()</span> <span class="k">as</span> <span class="nv">$field_name</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$subquery</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">select</span><span class="p">(</span><span class="s2">"field_data_</span><span class="nv">$field_name</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$field_name</span><span class="p">);</span>
    <span class="nv">$subquery</span><span class="o">-&gt;</span><span class="nf">addField</span><span class="p">(</span><span class="nv">$field_name</span><span class="p">,</span> <span class="s2">"</span><span class="si">{</span><span class="nv">$field_name</span><span class="si">}</span><span class="s2">_input"</span><span class="p">,</span> <span class="s1">'input'</span><span class="p">);</span>
    <span class="k">static</span><span class="o">::</span><span class="nf">addUnionQuery</span><span class="p">(</span><span class="nv">$union_query</span><span class="p">,</span> <span class="nv">$subquery</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nv">$union_query</span><span class="p">;</span>
<span class="p">}</span>

<span class="cd">/**
 * {@inheritdoc}
 */</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">getIds</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">[</span><span class="s1">'input'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="s1">'string'</span><span class="p">]];</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Query string:</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="k">SELECT</span>
  <span class="nv">"field_data_field_yt_foo"</span><span class="p">.</span><span class="nv">"field_yt_foo_input"</span> <span class="k">AS</span> <span class="nv">"input"</span>
<span class="k">FROM</span> <span class="p">{</span><span class="n">field_data_field_yt_foo</span><span class="p">}</span> <span class="nv">"field_yt_foo"</span>
<span class="k">UNION</span>
<span class="k">SELECT</span>
  <span class="nv">"field_data_field_yt_bar"</span><span class="p">.</span><span class="nv">"field_yt_bar_input"</span> <span class="k">AS</span> <span class="nv">"input"</span>
<span class="k">FROM</span> <span class="p">{</span><span class="n">field_data_field_yt_bar</span><span class="p">}</span> <span class="nv">"field_yt_bar"</span>
<span class="k">UNION</span>
<span class="k">SELECT</span>
  <span class="nv">"field_data_field_yt_baz"</span><span class="p">.</span><span class="nv">"field_yt_baz_input"</span> <span class="k">AS</span> <span class="nv">"input"</span>
<span class="k">FROM</span> <span class="p">{</span><span class="n">field_data_field_yt_baz</span><span class="p">}</span> <span class="nv">"field_yt_baz"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>But this is still wrong! Although the query works as expected, but as soon as we try to use joinable source and ID map databases, we will have an ugly message in our migrate kernel test:</p>
<pre><code class="language-cli">Migration failed with source plugin exception: SQLSTATE[42703]: Undefined column: 7  ERROR:  column "input" does not exist
LINE 4: ...ublic.60254974m_map_d7_youtube_field "map" ON input = ma...
                                                             ^: 
SELECT "field_yt_foo"."field_yt_foo_input" AS "input", "map"."sourceid1" AS "migrate_map_sourceid1", "map"."source_row_status" AS "migrate_map_source_row_status"
FROM
"602549740field_data_field_yt_foo" "field_yt_foo"
LEFT OUTER JOIN .public.60254974m_map_d7_youtube_field "map" ON input = map.sourceid1
WHERE ("map"."sourceid1" IS NULL) OR ("map"."source_row_status" = :db_condition_placeholder_0) UNION SELECT "field_yt_bar"."field_yt_bar_input" AS "input"
FROM
"602549740field_data_field_yt_bar" "field_yt_bar" UNION SELECT "field_yt_baz"."field_yt_baz_input" AS "input"
FROM
"602549740field_data_field_yt_baz" "field_yt_baz"; Array
(
  [:db_condition_placeholder_0] =&lt;; 1
)
in /Users/zoli/projects/media_migration/zdev/public_html/core/lib/Drupal/Core/Database/ExceptionHandler.php line 79
</code></pre>

<p>In essence this happens because the source plugin tries to exclude the source records from the database query which are already migrated. Although the outer joined query SqlBase has added is unaware of that we have a UNION query, the exception totally makes sense: We really don’t have an “input” column – since it’s just an alias of the <code class="language-plaintext highlighter-rouge">field_yt_foo_input</code>, <code class="language-plaintext highlighter-rouge">field_yt_bar_input</code> and <code class="language-plaintext highlighter-rouge">field_yt_baz_input</code> columns.</p>

<h2 id="the-solution">The solution</h2>

<p>Just check out <a href="https://git.drupalcode.org/project/drupal/-/blob/3aaef92fe5/core/lib/Drupal/Core/Database/Connection.php#L1197-1215">the docblock of <code class="language-plaintext highlighter-rouge">Drupal\Core\Database\Connection::select()</code></a>, focusing on the type of the first method parameter<sup id="fnref:4" role="doc-noteref"><a href="#fn:4" class="footnote" rel="footnote">4</a></sup>! 🧐</p>

<blockquote>
  <p>@param <code class="language-plaintext highlighter-rouge">string</code>|<code class="language-plaintext highlighter-rouge">\Drupal\Core\Database\Query\SelectInterface</code> <code class="language-plaintext highlighter-rouge">$table</code></p>

  <p>The base table name or subquery for this query, used in the FROM clause. If a string, the table specified will also be used as the “base” table for query_alter hook implementations.</p>
</blockquote>

<p>Because of the name of the variable, we all<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">5</a></sup> think that <code class="language-plaintext highlighter-rouge">$table</code> must be a string – the name of the table – but it <strong>can be</strong> either <strong>a select statement</strong>! And this is the essence of our solution as well: <em>We wrap the “big” union query into a new query</em>, which then allows us to use any kind of alias as source item identifier – be it a column alias or alias of a complex SQL expression!</p>

<p>It’s that simple:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="cd">/**
 * {@inheritdoc}
 */</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">query</span><span class="p">()</span> <span class="p">{</span>
  <span class="nv">$union_query</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">;</span>
  <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getYoutubeFieldNames</span><span class="p">()</span> <span class="k">as</span> <span class="nv">$field_name</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$subquery</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">select</span><span class="p">(</span><span class="s2">"field_data_</span><span class="nv">$field_name</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$field_name</span><span class="p">);</span>
    <span class="nv">$subquery</span><span class="o">-&gt;</span><span class="nf">addField</span><span class="p">(</span><span class="nv">$field_name</span><span class="p">,</span> <span class="s2">"</span><span class="si">{</span><span class="nv">$field_name</span><span class="si">}</span><span class="s2">_input"</span><span class="p">,</span> <span class="s1">'input'</span><span class="p">);</span>
    <span class="k">static</span><span class="o">::</span><span class="nf">addUnionQuery</span><span class="p">(</span><span class="nv">$union_query</span><span class="p">,</span> <span class="nv">$subquery</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nv">$wrapper_query</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">select</span><span class="p">(</span><span class="nv">$union_query</span><span class="p">,</span> <span class="s1">'all_yt'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">fields</span><span class="p">(</span><span class="s1">'all_yt'</span><span class="p">);</span>
  <span class="nv">$wrapper_query</span><span class="o">-&gt;</span><span class="nf">orderBy</span><span class="p">(</span><span class="s1">'all_yt.input'</span><span class="p">);</span>
  <span class="k">return</span> <span class="nv">$wrapper_query</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>This is the query string of the Drupal select above:</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="k">SELECT</span> 
  <span class="nv">"all_yt"</span><span class="p">.</span><span class="o">*</span>
<span class="k">FROM</span> <span class="p">(</span>
  <span class="k">SELECT</span>
    <span class="nv">"field_data_field_yt_foo"</span><span class="p">.</span><span class="nv">"field_yt_foo_input"</span> <span class="k">AS</span> <span class="nv">"input"</span>
  <span class="k">FROM</span> <span class="p">{</span><span class="n">field_data_field_yt_foo</span><span class="p">}</span> <span class="nv">"field_yt_foo"</span>
  <span class="k">UNION</span>
  <span class="k">SELECT</span>
    <span class="nv">"field_data_field_yt_bar"</span><span class="p">.</span><span class="nv">"field_yt_bar_input"</span> <span class="k">AS</span> <span class="nv">"input"</span>
  <span class="k">FROM</span> <span class="p">{</span><span class="n">field_data_field_yt_bar</span><span class="p">}</span> <span class="nv">"field_yt_bar"</span>
  <span class="k">UNION</span>
  <span class="k">SELECT</span>
    <span class="nv">"field_data_field_yt_baz"</span><span class="p">.</span><span class="nv">"field_yt_baz_input"</span> <span class="k">AS</span> <span class="nv">"input"</span>
  <span class="k">FROM</span> <span class="p">{</span><span class="n">field_data_field_yt_baz</span><span class="p">}</span> <span class="nv">"field_yt_baz"</span>
<span class="p">)</span> <span class="nv">"all_yt"</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="nv">"all_yt"</span><span class="p">.</span><span class="nv">"input"</span> <span class="k">ASC</span> <span class="n">NULLS</span> <span class="k">FIRST</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Have nice <em>database queries</em>! 🙂</p>

<hr />

<p><em>Footnotes</em>:</p>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:union" role="doc-endnote">
      <p>This <code class="language-plaintext highlighter-rouge">::addUnionQuery()</code> is a very simple helper function:</p>

      <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="k">protected</span> <span class="k">static</span> <span class="k">function</span> <span class="n">addUnionQuery</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$union_destination</span><span class="p">,</span> <span class="nc">SelectInterface</span> <span class="nv">$query</span><span class="p">)</span><span class="o">:</span> <span class="n">void</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$union_destination</span> <span class="k">instanceof</span> <span class="nc">SelectInterface</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$union_destination</span><span class="o">-&gt;</span><span class="nf">union</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nv">$union_destination</span> <span class="o">=</span> <span class="k">clone</span> <span class="nv">$query</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div>      </div>

      <p>If the destination query is empty, then it just sets <code class="language-plaintext highlighter-rouge">$destination</code> to the clone of the source query. But if it is already a <code class="language-plaintext highlighter-rouge">SelectInterface</code>, then it ‘unions’ the two queries. <a href="#fnref:union" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:idplural" role="doc-endnote">
      <p>We can define multiple identifiers too. <a href="#fnref:idplural" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p>This is a very handy feature! It is actively used in Drupal core migrate source plugins too: This is why <code class="language-plaintext highlighter-rouge">d7_field</code> and <code class="language-plaintext highlighter-rouge">d7_field_instance</code> can use the same database query to get their source data. <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:4" role="doc-endnote">
      <p>This option is available in <code class="language-plaintext highlighter-rouge">::join()</code>, <code class="language-plaintext highlighter-rouge">::isNull()</code> etc too. As well as in <code class="language-plaintext highlighter-rouge">::union()</code>! 😉 <a href="#fnref:4" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:3" role="doc-endnote">
      <p>Or at least I’ve only known about this feature for two years (since 2020, when I started working on migrations). <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>]]></content><author><name>Zoltán Horváth</name></author><category term="Development" /><category term="Drupal" /><category term="Database API" /><category term="Migration" /><summary type="html"><![CDATA[How we can use DB column or DB expression aliases as migration source item identifiers.]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://huzooka.github.io/simple.png" /><media:content medium="image" url="https://huzooka.github.io/simple.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Strange Empty Destination Property Handling in Drupal’s Migration API</title><link href="https://huzooka.github.io/development/2022/05/29/empty-properties-change-tracking.html" rel="alternate" type="text/html" title="Strange Empty Destination Property Handling in Drupal’s Migration API" /><published>2022-05-29T12:34:32+00:00</published><updated>2022-05-29T12:34:32+00:00</updated><id>https://huzooka.github.io/development/2022/05/29/empty-properties-change-tracking</id><content type="html" xml:base="https://huzooka.github.io/development/2022/05/29/empty-properties-change-tracking.html"><![CDATA[<p class="lead">One of my colleagues, <a href="https://www.drupal.org/u/yashrode">Yash Rode</a> developed a very nice improvement for <a href="https://drupal.org/project/media_migration">Media Migration</a> about one and half months ago: he added a <a href="https://drupal.org/i/3272705">YouTube field → media migration</a> to the module. After I committed it, the question immediately arose in my mind: what will happen during incremental migrations? I definitely cannot migrate file IDs to media entity IDs anymore!</p>

<p>So I started getting rid of the <code class="language-plaintext highlighter-rouge">mid</code> destination properties in the media entity migrations <code class="language-plaintext highlighter-rouge">d7_file_entity</code> and <code class="language-plaintext highlighter-rouge">d7_file_plain</code> and also update all migrate process plugins which assumed that the source file ID will be the ID of the migrated media entity, like the plugins which are processing text fields<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup>.</p>

<p>The task wasn’t that difficult if we didn’t count with Migrate Upgrade… Well, that was what I thought before I ran into a core bug (I think it is a bug).</p>

<h2 id="the-situation">The situation</h2>

<p>The first thing I did was removing the <code class="language-plaintext highlighter-rouge">mid: fid</code> process pipelines from <code class="language-plaintext highlighter-rouge">d7_file_entity</code> and <code class="language-plaintext highlighter-rouge">d7_file_plain</code>. Then I took a look at the process plugins which are parsing text fields<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup> and I updated them accordingly. Latter was required because I couldn’t assume anymore that the destination media entity’s ID is the same as the source file ID – by the way, I already knew that it was a wrong assumption… See <a href="https://www.drupal.org/project/media_migration/issues/3214791">this (#3214791)</a> and <a href="https://www.drupal.org/project/media_migration/issues/3267064">this (#3267064)</a> issue.</p>

<p>Pretty slowly I refactored all the components I knew to handle the new situation properly, and then I ran into a whole unexpected <code class="language-plaintext highlighter-rouge">EntityStorageException</code> while running the refresh test:</p>

<pre><code class="language-cli">SQLSTATE[23502]: Not null violation: 7 ERROR:  null value in column "uuid" violates not-null constraint
DETAIL:  Failing row contains (4, 4, image, null, en).: UPDATE "test68160068media" SET "vid"=:db_update_placeholder_0, "bundle"=:db_update_placeholder_1, "uuid"=:db_update_placeholder_2, "langcode"=:db_update_placeholder_3
WHERE "mid" = :db_condition_placeholder_0; Array
(
  "db_update_placeholder_0" =&gt; 4,
  "db_update_placeholder_1" =&gt; "image",
  "db_update_placeholder_2" =&gt; NULL,
  "db_update_placeholder_3" =&gt; "en"
)
(/Users/zoli/projects/media_migration/zdev/public_html/core/lib/Drupal/Core/Entity/Sql/SqlContentEntityStorage.php:811)
</code></pre>

<h2 id="debugging">Debugging</h2>

<p>Obviously I started debugging this situation by setting up a breakpoint in <code class="language-plaintext highlighter-rouge">SqlContentEntityStorage</code> at line 811 then checking the <em>backtrace</em>. There was no surprise: the <code class="language-plaintext highlighter-rouge">uuid</code> property of the updated entity in <code class="language-plaintext highlighter-rouge">EntityContentBase::save()</code><sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">3</a></sup> really was empty!</p>

<p class="figure"><img src="/files/image/Empty-dest-prop-uuid.png" alt="" /></p>

<p>I checked the next trace (<code class="language-plaintext highlighter-rouge">EntityContentBase::import()</code>), and found a very weird thing in the <code class="language-plaintext highlighter-rouge">$row</code> variable’s empty destination properties:</p>

<p class="figure"><img src="/files/image/Empty-dest-prop-empty-props.png" alt="" /></p>

<p>Why is <code class="language-plaintext highlighter-rouge">uuid</code> listed twice? I flagged it as an empty destination in the <code class="language-plaintext highlighter-rouge">MediaMigrateUuid</code> process plugin if there is no <em>prophecy</em> for the given file ID (managed files are the data sources of the migrated media entities). So I set up another breakpoint there, and then followed the processing of the actual migration row.</p>

<h2 id="change-between-92x-and-93x">Change between 9.2.x and 9.3.x</h2>

<p>It turned out that the second time <code class="language-plaintext highlighter-rouge">uuid</code> is marked as empty happens in <code class="language-plaintext highlighter-rouge">MigrateExecutable</code>, more precisely <a href="https://git.drupalcode.org/project/drupal/-/blob/86c7ed07/core/modules/migrate/src/MigrateExecutable.php#L411-L419">here, at the end of its <code class="language-plaintext highlighter-rouge">processRow</code></a> method:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="c1">// Ensure all values, including nulls, are migrated.</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$plugins</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$value</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$row</span><span class="o">-&gt;</span><span class="nf">setDestinationProperty</span><span class="p">(</span><span class="nv">$destination</span><span class="p">,</span> <span class="nv">$value</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="nv">$row</span><span class="o">-&gt;</span><span class="nf">setEmptyDestinationProperty</span><span class="p">(</span><span class="nv">$destination</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>I was absolutely sure that this was not the way how destination property values were handled until recently, so I started checking the contents of the <code class="language-plaintext highlighter-rouge">MigrateExecutable</code> class switching between core development branches.</p>

<p>It turned out I remembered well! There was a bigger change between <code class="language-plaintext highlighter-rouge">9.2.x</code> and <code class="language-plaintext highlighter-rouge">9.3.x</code>. <a href="https://git.drupalcode.org/project/drupal/-/commit/8616edd24f8ded10f25a259e8d01244d9fb44f29">A commit (with a very less expressive commit message) has introduced</a> even the <code class="language-plaintext highlighter-rouge">MigrateExecutable::processRow</code> method and with it, the current way of handling empty destination properties.</p>

<p>I went back to my <code class="language-plaintext highlighter-rouge">MediaMigrateUuid</code> process plugin, and made the empty property flagging conditional: I do it only if the actual core version is lower than <code class="language-plaintext highlighter-rouge">9.3.0</code>:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="c1">// No UUID was found – lets set the destination property to empty before</span>
<span class="c1">// throwing a skip process exception (this is only required for 9.2.x and</span>
<span class="c1">// below).</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">version_compare</span><span class="p">(</span><span class="err">\</span><span class="nc">Drupal</span><span class="o">::</span><span class="no">VERSION</span><span class="p">,</span> <span class="s1">'9.3.0'</span><span class="p">,</span> <span class="s1">'lt'</span><span class="p">))</span> <span class="p">{</span>
  <span class="nv">$row</span><span class="o">-&gt;</span><span class="nf">setEmptyDestinationProperty</span><span class="p">(</span><span class="nv">$destination_property</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>I hoped that this would fix the issue, but unfortunately this fix wasn’t enough: my change tracking test was wailing with the same error message that I saw at first.</p>

<h2 id="still-wrong-but-why">Still wrong! But why?…</h2>

<p>I knew I needed to know how my fully processed migration row looks and then what is the entity that is attempted to be saved by the migration destination plugin. In every similar situation I used to set up a breakpoint in <code class="language-plaintext highlighter-rouge">MigrateExecutabe</code>, <a href="https://git.drupalcode.org/project/drupal/-/blob/86c7ed07/core/modules/migrate/src/MigrateExecutable.php#L230">at the line where the destination plugin’s <code class="language-plaintext highlighter-rouge">import</code> method is invoked</a>.</p>

<p>I tracked down what happened: Before the import, my row contained the calculated destination properties and values I expected. But in <a href="https://git.drupalcode.org/project/drupal/-/blob/86c7ed07/core/modules/migrate/src/Plugin/migrate/destination/EntityContentBase.php#L159"><code class="language-plaintext highlighter-rouge">EntityContentBase::import</code></a>, the entity instance returned by <a href="https://git.drupalcode.org/project/drupal/-/blob/86c7ed07/core/modules/migrate/src/Plugin/migrate/destination/Entity.php#L155"><code class="language-plaintext highlighter-rouge">::getEntity()</code> method</a> (this is inherited from the parent <code class="language-plaintext highlighter-rouge">Entity</code> class) contained weird things: At the entity’s <code class="language-plaintext highlighter-rouge">values</code> key, I could see the current uuid, but at the <code class="language-plaintext highlighter-rouge">fields</code> key (this is where the processed destination property values are pushed into), the <code class="language-plaintext highlighter-rouge">uuid</code> property was present, and it was an empty array!</p>

<p class="figure"><img src="/files/image/Empty-dest-prop-update-uuid.png" alt="" /></p>

<p>Let’s see what happens in <code class="language-plaintext highlighter-rouge">Entity::getEntity()</code>! <a href="https://git.drupalcode.org/project/drupal/-/blob/86c7ed07/core/modules/migrate/src/Plugin/migrate/destination/Entity.php#L155-L161">This method basically starts with a condition</a>: if old destination IDs are available, then it tries to load the preexisting entity, then invokes <code class="language-plaintext highlighter-rouge">::updateEntity()</code>; and <a href="https://git.drupalcode.org/project/drupal/-/blob/86c7ed07/core/modules/migrate/src/Plugin/migrate/destination/EntityContentBase.php#L287-L289">at the end of the <code class="language-plaintext highlighter-rouge">EntityContentBase::updateEntity()</code></a> method we can see why the value of the <code class="language-plaintext highlighter-rouge">uuid</code> property will be <code class="language-plaintext highlighter-rouge">NULL</code>:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="k">protected</span> <span class="k">function</span> <span class="n">updateEntity</span><span class="p">(</span><span class="kt">EntityInterface</span> <span class="nv">$entity</span><span class="p">,</span> <span class="kt">Row</span> <span class="nv">$row</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$empty_destinations</span> <span class="o">=</span> <span class="nv">$row</span><span class="o">-&gt;</span><span class="nf">getEmptyDestinationProperties</span><span class="p">();</span>
  
  <span class="p">(</span><span class="mf">...</span><span class="p">)</span>
  
  <span class="k">foreach</span> <span class="p">(</span><span class="nv">$empty_destinations</span> <span class="k">as</span> <span class="nv">$field_name</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$entity</span><span class="o">-&gt;</span><span class="nv">$field_name</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">setRollbackAction</span><span class="p">(</span><span class="nv">$row</span><span class="o">-&gt;</span><span class="nf">getIdMap</span><span class="p">(),</span> <span class="nv">$rollback_action</span><span class="p">);</span>

  <span class="c1">// We might have a different (translated) entity, so return it.</span>
  <span class="k">return</span> <span class="nv">$entity</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>I’ll be honest: I have no idea why this is needed. I would definitely unset the destination property values of the current <code class="language-plaintext highlighter-rouge">$row</code> object instead of setting the fields of the entity to <code class="language-plaintext highlighter-rouge">NULL</code>. <code class="language-plaintext highlighter-rouge">NULL</code> is a value, it does not mean emptiness by default. The <em>“empty”</em> attribution is determined by the field’s <em>FieldType</em> class (<a href="https://git.drupalcode.org/project/drupal/-/blob/86c7ed07/core/lib/Drupal/Core/TypedData/ComplexDataInterface.php#L97-L103">see <code class="language-plaintext highlighter-rouge">ComplexDataInterface::isEmtpy()</code></a>) or item list class (<a href="https://git.drupalcode.org/project/drupal/-/blob/86c7ed07/core/lib/Drupal/Core/TypedData/ListInterface.php#L28-L34">see <code class="language-plaintext highlighter-rouge">ListInterface::isEmpty()</code></a>).</p>

<p>Maybe I totally misunderstood what empty destination properties are used for…</p>

<h2 id="workaround">Workaround</h2>

<p>I worked this around with a complex process pipeline. Luckily, I had to write <a href="https://www.drupal.org/docs/contributed-modules/migrate-magician/migrate-magician-process-plugins-110/migmaggetentityproperty-120"><code class="language-plaintext highlighter-rouge">MigMagGetEntityProperty</code></a> for working around <a href="/development/2021/09/21/menu-link-migration-mess.html">menu link migration weirdnesses of Drupal core</a>, and this process plugin was a big help this time too.</p>

<p>So the actual solution:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">track_changes_uuid</code>: I do a lookup for the ID of an already migrated entity, and if it exists, then I get the entity’s UUID. This destination property only has value if the same entity has been migrated previously.</li>
  <li><code class="language-plaintext highlighter-rouge">oracle_uuid</code>: This is the process pipeline that computed the <code class="language-plaintext highlighter-rouge">uuid</code> property previously, by only taking the <em>UUID prophecy</em> table into account – but it was renamed to <code class="language-plaintext highlighter-rouge">oracle_uuid</code>.</li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">uuid</code>: Here is the magic! One of my favorite process plugins: <code class="language-plaintext highlighter-rouge">null_coalesce</code>! If <code class="language-plaintext highlighter-rouge">track_changes_uuid</code> is not null, then the computed <code class="language-plaintext highlighter-rouge">uuid</code> will be the value of <code class="language-plaintext highlighter-rouge">track_changes_uuid</code>. If it is <code class="language-plaintext highlighter-rouge">NULL</code>, but <code class="language-plaintext highlighter-rouge">oracle_uuid</code> has a non-null value, then that will be set.</p>

    <p>If both are empty, then this destination property will be set to <code class="language-plaintext highlighter-rouge">NULL</code> (and will be marked as being empty like before), but this happens only if we migrate the entity for the first time. And fortunately, the database exception is only triggered during entity updates.</p>
  </li>
</ul>

<p>Here is the code:</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre><span class="na">id</span><span class="pi">:</span> <span class="s">d7_file_entity</span>
<span class="c1"># Label, source config, deriver class configuration...</span>
<span class="na">process</span><span class="pi">:</span>
  <span class="na">track_changes_uuid</span><span class="pi">:</span>
    <span class="pi">-</span>
      <span class="na">plugin</span><span class="pi">:</span> <span class="s">migration_lookup</span>
      <span class="na">source</span><span class="pi">:</span> <span class="s">fid</span>
      <span class="na">migration</span><span class="pi">:</span> <span class="s">d7_file_entity</span>
      <span class="na">no_stub</span><span class="pi">:</span> <span class="no">true</span>
    <span class="pi">-</span>
      <span class="na">plugin</span><span class="pi">:</span> <span class="s">skip_on_empty</span>
      <span class="na">method</span><span class="pi">:</span> <span class="s">process</span>
    <span class="pi">-</span>
      <span class="na">plugin</span><span class="pi">:</span> <span class="s">migmag_get_entity_property</span>
      <span class="na">entity_type_id</span><span class="pi">:</span> <span class="s1">'</span><span class="s">media'</span>
      <span class="na">property</span><span class="pi">:</span> <span class="s1">'</span><span class="s">uuid'</span>
  <span class="na">oracle_uuid</span><span class="pi">:</span>
    <span class="na">plugin</span><span class="pi">:</span> <span class="s">media_migrate_uuid</span>
    <span class="na">source</span><span class="pi">:</span> <span class="s">fid</span>
  <span class="na">uuid</span><span class="pi">:</span>
    <span class="na">plugin</span><span class="pi">:</span> <span class="s1">'</span><span class="s">null_coalesce'</span>
    <span class="na">source</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s1">'</span><span class="s">@track_changes_uuid'</span>
      <span class="pi">-</span> <span class="s1">'</span><span class="s">@oracle_uuid'</span>
<span class="c1"># The rest of the migration YAML remaind unchanged.</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<hr />

<p><em>Footnotes</em>:</p>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>These plugins are parsing test fields and transforming the old media embed codes to their Drupal 9+ equivalents and also replace inline <code class="language-plaintext highlighter-rouge">&lt;img&gt;</code> tags with embed code. <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p>These are the process plugins which are changing Drupal 7 Media embed JSONs to Drupal 9 embed tags and which are transforming image and other file links to linkit tags, and which are converting <em>directly</em> used images (<code class="language-plaintext highlighter-rouge">&lt;img src="..."&gt;</code>) to Drupal 9 equivalent embed HTML tags. <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:3" role="doc-endnote">
      <p><code class="language-plaintext highlighter-rouge">EntityContentBase</code> is the destination plugin class of Drupal content entities. It is derived by <code class="language-plaintext highlighter-rouge">MigrateEntity</code> which decides <a href="https://git.drupalcode.org/project/drupal/-/blob/86c7ed07/core/modules/migrate/src/Plugin/Derivative/MigrateEntity.php#L59-L61">what plugin class should be used per entity type</a>. <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>]]></content><author><name>Zoltán Horváth</name></author><category term="Development" /><category term="Drupal" /><category term="Migration" /><summary type="html"><![CDATA[Do you have any idea why it works this way?]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://huzooka.github.io/files/image/Empty-dest-prop-uuid.png" /><media:content medium="image" url="https://huzooka.github.io/files/image/Empty-dest-prop-uuid.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Composer Package Trick for Installing Incompatible Composer Extensions</title><link href="https://huzooka.github.io/development/2022/05/08/composer-package-trick.html" rel="alternate" type="text/html" title="Composer Package Trick for Installing Incompatible Composer Extensions" /><published>2022-05-08T17:30:00+00:00</published><updated>2022-05-08T17:30:00+00:00</updated><id>https://huzooka.github.io/development/2022/05/08/composer-package-trick</id><content type="html" xml:base="https://huzooka.github.io/development/2022/05/08/composer-package-trick.html"><![CDATA[<p class="lead">This is the up-to-date, user-friendly version of the <a href="/development/2020/04/08/composer-package-drupal9.html">post I wrote 2 years ago</a> about the same topic.</p>

<p><a href="#steps-to-follow">⇩ Jump to the steps</a>.</p>

<p>In this post you will be able to see how to add an incompatible Drupal module to a Drupal 10 project with Composer. At the time I’m writing (well, making up-to-date) this post, I’m not able to do this with <a href="https://drupal.org/project/eme">Entity Migrate Export</a> module: both the latest tag release (<code class="language-plaintext highlighter-rouge">1.0.0-alpha10</code>) and the latest branch release (<code class="language-plaintext highlighter-rouge">1.0.x-dev</code>) require Drupal core <code class="language-plaintext highlighter-rouge">^8.9 || ^9</code>:</p>

<pre><code class="language-cli">$ composer require drupal/eme
Using version ^1.0@alpha for drupal/eme
./composer.json has been updated
Running composer update drupal/eme
Gathering patches for root package.
No patches supplied.
Loading composer repositories with package information
Updating dependencies
Info from https://repo.packagist.org: #StandWithUkraine
Your requirements could not be resolved to an installable set of packages.

  Problem 1
    - drupal/eme[1.0.0-alpha1, ..., 1.0.0-alpha5] require drupal/core ^8.7.7 || ^9 -&gt; found drupal/core[8.7.7, ..., 8.9.x-dev, 9.0.0-alpha1, ..., 9.5.x-dev] but the package is fixed to 10.0.x-dev (lock file version) by a partial update and that version does not match. Make sure you list it as an argument for the update command.
    - drupal/eme[1.0.0-alpha6, ..., 1.0.0-alpha10] require drupal/core ^8.9 || ^9 -&gt; found drupal/core[8.9.0-beta1, ..., 8.9.x-dev, 9.0.0-alpha1, ..., 9.5.x-dev] but the package is fixed to 10.0.x-dev (lock file version) by a partial update and that version does not match. Make sure you list it as an argument for the update command.
    - Root composer.json requires drupal/eme ^1.0@alpha -&gt; satisfiable by drupal/eme[1.0.0-alpha1, ..., 1.0.0-alpha10].

Use the option --with-all-dependencies (-W) to allow upgrades, downgrades and removals for packages currently locked to specific versions.

Installation failed, reverting ./composer.json and ./composer.lock to their original content.
</code></pre>

<h2 id="steps-to-follow">Steps to follow</h2>

<h3 id="find-the-corresponding-package-info-json-file">Find the corresponding package info JSON file</h3>

<ol>
  <li>We will be using the package info that’s already available for your composer. So, locate where your composer cache is, by executing <code class="language-plaintext highlighter-rouge">composer config cache-dir</code>:
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>composer config cache-dir
/Users/zoli/Library/Caches/composer
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>
    <p>The package info will be inside the cache directory’s <code class="language-plaintext highlighter-rouge">repo</code> subdirectory, in the corresponding repository subdirectory. On my development environment, in case of Drupal extensions, this is <code class="language-plaintext highlighter-rouge">/Users/zoli/Library/Caches/composer/repo/https---packages.drupal.org-8/</code>.</p>
  </li>
  <li>For Entity Migrate Export, we will have two different JSON files: one for the <em>usual</em> tag-based releases (this is <code class="language-plaintext highlighter-rouge">provider-drupal~eme.json</code>), and an another one for the <em>branch</em> based releases (<code class="language-plaintext highlighter-rouge">provider-drupal~eme~dev.json</code>). Imho the best practice is to <em>replace</em> the latest release we found in the <em>tag</em> info JSON: so if the maintainer releases a newer (and already compatible) release, then we will also be informed through Drupal’s Module Update UI.</li>
</ol>

<h3 id="add-the-right-json-object-to-your-root-composerjson-as-custom-package">Add the right JSON object to your root <code class="language-plaintext highlighter-rouge">composer.json</code> as custom package</h3>

<p>One rule here: your custom package entry must be added before the Drupal packagist repository.</p>

<ol>
  <li>Open the package file, locate the latest release. This is the info you will be using:
    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"packages"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"drupal/eme"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"keywords"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"Drupal"</span><span class="p">],</span><span class="w">
        </span><span class="nl">"homepage"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://www.drupal.org/project/eme"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1.0.0-alpha10"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"version_normalized"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1.0.0.0-alpha10"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"license"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GPL-2.0-or-later"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"authors"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="err">…</span><span class="p">],</span><span class="w">
        </span><span class="nl">"support"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">…</span><span class="p">},</span><span class="w">
        </span><span class="nl">"source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">…</span><span class="p">},</span><span class="w">
        </span><span class="nl">"dist"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">…</span><span class="p">},</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"drupal-module"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"uid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"eme-3219974"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"drupal/eme"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"extra"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">…</span><span class="p">},</span><span class="w">
        </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Exports content entities into a migration module"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"require"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"drupal/core"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^8.9 || ^9"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"require-dev"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"drupal/migrate_tools"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^5"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"drupal/migrate_plus"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^5"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"drush/drush"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^9 || ^10"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="err">…</span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="err">…</span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"minified"</span><span class="p">:</span><span class="w"> </span><span class="s2">"composer/2.0"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"last-modified"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Sat, 30 Apr 2022 16:30:38 GMT"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>The section you will paste into the root <code class="language-plaintext highlighter-rouge">composer.json</code> is a single release info, an object which starts with the <code class="language-plaintext highlighter-rouge">keywords</code> key. Add this section to your root <code class="language-plaintext highlighter-rouge">composer.json</code>, above Drupal’s repository:
    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"z.a.horvath/incubator"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"drupal-project"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"repositories"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"custom repo key"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"package"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"package"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"keywords"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"Drupal"</span><span class="p">],</span><span class="w">
        </span><span class="nl">"homepage"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://www.drupal.org/project/eme"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1.0.0-alpha10"</span><span class="w">
        </span><span class="err">…</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"drupal"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"composer"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://packages.drupal.org/8"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="err">…</span><span class="w">
</span><span class="p">}</span><span class="w">       
</span></pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
</ol>

<h3 id="fix-the-requirements-version-constraints-which-cause-the-conflict">Fix the requirement’s version constraints which cause the conflict</h3>

<p>Locate the <code class="language-plaintext highlighter-rouge">require</code> key in the package info, and modify the version constraints which cause conflicts:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nl">"require"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nl">"drupal/core"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^8.9 || ^9"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>
<p>Let’s change the version constraint of <code class="language-plaintext highlighter-rouge">drupal/core</code> requirement, and allow Drupal 10 as well:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nl">"require"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nl">"drupal/core"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^8.9 || ^9 || ^10"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="summary">Summary</h2>

<p>With the solution explained above we are able to download and use incompatible extensions in our Composer project. Of course these extensions might be <em>really</em> incompatible, but as soon as we can download them we can use <a href="https://github.com/cweagans/composer-patches">cweagans/composer-patches</a> to apply patches fixing the issues, or we can start writing the fix and share it with the community.</p>]]></content><author><name>Zoltán Horváth</name></author><category term="Development" /><category term="Composer" /><category term="Drupal" /><summary type="html"><![CDATA[How to suppress the repository info of a Composer package to make it installable in your Drupal 10 project.]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://huzooka.github.io/simple.png" /><media:content medium="image" url="https://huzooka.github.io/simple.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Prepare a Customer’s Database to be Used in a Test – with a Drupal Kernel Test!</title><link href="https://huzooka.github.io/development/2021/12/04/ttd-test-data.html" rel="alternate" type="text/html" title="Prepare a Customer’s Database to be Used in a Test – with a Drupal Kernel Test!" /><published>2021-12-04T14:34:26+00:00</published><updated>2021-12-04T14:34:26+00:00</updated><id>https://huzooka.github.io/development/2021/12/04/ttd-test-data</id><content type="html" xml:base="https://huzooka.github.io/development/2021/12/04/ttd-test-data.html"><![CDATA[<p class="lead">The more complex the menu structure is, the more important it is to the customer is. And at the same time, the more complex the menu structure is, the less menu links are migrated to Drupal 9. We immediately realized this when we understood <a href="/development/2021/09/21/menu-link-migration-mess.html">the bug in my previous post</a>.</p>

<h2 id="motivation">Motivation</h2>

<p>Although we’ve built some patches for this customer, we aim to help not only Acquia customers, but as many Drupal 7 users as possible. This is why the latest <a href="https://drupal.org/project/migmag/">Migrate Magician</a> submodule will be created soon.</p>

<p>In this post, I share my basic notes I took while I was transforming the sanitized customer database to a minimal database fixture that I have been using during the development.</p>

<h2 id="fundaments">Fundaments</h2>

<p>Maybe you already know this about me: I really like tests! Not just because they give me some extra confidence about the code I write, but because tests do the tedious and time-consuming, repetitive steps for me, and I can focus more on the actual development.</p>

<p>But this case was a bit special: we had a great, difficult menu structure in a client’s database which I wanted to use as test data during the development, when running the “real” test.</p>

<p>Maybe you don’t know about it, but Drupal 9 has a built-in <a href="https://api.drupal.org/api/drupal/core%21scripts%21db-tools.php">CLI database application</a> which can export MySQL/MariaDB databases into a PHP file. The only problem with it is that it creates one single PHP file. I wrote a smarter replacement on its fundamentals which creates per-table database fixture files, and it also can be configured to split big tables into chunks. This is <a href="https://www.drupal.org/project/smart_db_tools">Smart DB Tools</a>, that is what I was using here.</p>

<h2 id="preparation">Preparation</h2>

<ol>
  <li>
    <p>I’ve exported our customer’s sanitized source database to a database fixture using Smart DB Tools.</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre> php ./modules/contrib/smart_db_tool/scripts/smart-db-tools.php dump<span class="se">\</span>
   <span class="nt">--database</span> fixture_connection<span class="se">\</span>
   <span class="nt">--split-destination</span> ./temp/d7-menu-link-raw.php
</pre></td></tr></tbody></table></code></pre></div>    </div>

    <p class="figure"><img src="/files/image/tdd-menu-link-raw-export.png" alt="The exported database fixture file, and the subdirectory which holds the per-table fixtures" />
 The exported database fixture file, and the subdirectory which holds the per-table fixtures</p>
  </li>
  <li>
    <p>I created a <code class="language-plaintext highlighter-rouge">tests/fixtures/d7-menu-link-db.php</code> file and a <code class="language-plaintext highlighter-rouge">tests/fixtures/d7-menu-link-db</code> subdirectory, moved the exported <code class="language-plaintext highlighter-rouge">menu_links.php</code> and <code class="language-plaintext highlighter-rouge">menu_custom.php</code> table fixture files into the subdirectory – because I assumed that executing the <code class="language-plaintext highlighter-rouge">d7_menu_link</code> migration will probably need these tables 😉.</p>
  </li>
  <li>I wrote a very basic kernel test based on MigrateDrupalTestBase, specified the <code class="language-plaintext highlighter-rouge">tests/fixtures/d7-menu-link-db.php</code> file created previously as a fixture file, and executed the test, which only migrated <code class="language-plaintext highlighter-rouge">d7_menu</code> and <code class="language-plaintext highlighter-rouge">d7_menu_links</code>. Each time the test failed, I checked the error message, and either:
    <ul>
      <li>added the missing migration to the <code class="language-plaintext highlighter-rouge">executeMigrations()</code> method argument array</li>
      <li>installed the missing core module, or the missing entity schema or module config</li>
      <li>or if the error was about a missing database table a migration source plugin tried to access, then I created the corresponding table fixture file in the <code class="language-plaintext highlighter-rouge">tests/fixtures/d7-menu-link-db</code> subdirectory, copied the table schema from the original fixture into it, and added an <code class="language-plaintext highlighter-rouge">include</code> statement in the main <code class="language-plaintext highlighter-rouge">tests/fixtures/d7-menu-link-db.php</code> file.</li>
    </ul>
  </li>
  <li>
    <p>There are some tables which <em>should</em> be present,but can be empty. These were <code class="language-plaintext highlighter-rouge">field_config</code>, <code class="language-plaintext highlighter-rouge">field_config_instance</code>, <code class="language-plaintext highlighter-rouge">role</code>, <code class="language-plaintext highlighter-rouge">role_permissions</code>, <code class="language-plaintext highlighter-rouge">users</code> and <code class="language-plaintext highlighter-rouge">user_roles</code>. We obviously need a user for authoring the migrated nodes, but user 1 will be available in our kernel test.</p>
  </li>
  <li>I also created empty fixture files for the <code class="language-plaintext highlighter-rouge">node</code> and the <code class="language-plaintext highlighter-rouge">node_revision</code> tables temporarily, and made a cleaned-up <code class="language-plaintext highlighter-rouge">system</code> table fixture file where I only kept the rows of the <code class="language-plaintext highlighter-rouge">field</code>, <code class="language-plaintext highlighter-rouge">field_storage</code>, <code class="language-plaintext highlighter-rouge">menu</code>, <code class="language-plaintext highlighter-rouge">node</code>, <code class="language-plaintext highlighter-rouge">system</code> and <code class="language-plaintext highlighter-rouge">user</code> modules (all of them enabled).</li>
</ol>

<p>And this was the kernel test I used:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">Drupal\Tests\migmag_menu_link_migrate\Kernel</span><span class="p">;</span>

<span class="kn">use</span> <span class="nf">Drupal\menu_link_content</span><span class="err">\</span><span class="nc">Entity\MenuLinkContent</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Tests\migmag\Traits\MigMagKernelTestDxTrait</span><span class="p">;</span>
<span class="kn">use</span> <span class="nf">Drupal\Tests\migrate_drupal</span><span class="err">\</span><span class="nc">Kernel\MigrateDrupalTestBase</span><span class="p">;</span>

<span class="cd">/**
 * Tests the enhanced menu link migration.
 *
 * @group migmag_menu_link_migrate
 */</span>
<span class="kd">class</span> <span class="nc">MenuLinkMigrateTest</span> <span class="kd">extends</span> <span class="nc">MigrateDrupalTestBase</span> <span class="p">{</span>

  <span class="kn">use</span> <span class="nc">MigMagKernelTestDxTrait</span><span class="p">;</span>

  <span class="cd">/**
   * {@inheritdoc}
   */</span>
  <span class="k">protected</span> <span class="k">static</span> <span class="nv">$modules</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'comment'</span><span class="p">,</span>
    <span class="s1">'link'</span><span class="p">,</span>
    <span class="s1">'menu_link_content'</span><span class="p">,</span>
    <span class="s1">'node'</span><span class="p">,</span>
  <span class="p">];</span>

  <span class="cd">/**
   * {@inheritdoc}
   */</span>
  <span class="k">protected</span> <span class="k">function</span> <span class="n">setUp</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">parent</span><span class="o">::</span><span class="nf">setUp</span><span class="p">();</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">installEntitySchema</span><span class="p">(</span><span class="s1">'menu_link_content'</span><span class="p">);</span>

    <span class="nv">$fixture_path</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="no">DIRECTORY_SEPARATOR</span><span class="p">,</span> <span class="p">[</span>
      <span class="nf">drupal_get_path</span><span class="p">(</span><span class="s1">'module'</span><span class="p">,</span> <span class="s1">'migmag_menu_link_migrate'</span><span class="p">),</span>
      <span class="s1">'tests'</span><span class="p">,</span>
      <span class="s1">'fixtures'</span><span class="p">,</span>
      <span class="s1">'d7-menu-link-db.php'</span><span class="p">,</span>
    <span class="p">]);</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">loadFixture</span><span class="p">(</span><span class="nv">$fixture_path</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cd">/**
   * Test the enhanced menu link migration.
   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="n">testMenuLinkMigration</span><span class="p">()</span> <span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">startCollectingMessages</span><span class="p">();</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">executeMigrations</span><span class="p">([</span>
      <span class="s1">'d7_node_type'</span><span class="p">,</span>
      <span class="s1">'d7_user_role'</span><span class="p">,</span>
      <span class="s1">'d7_user'</span><span class="p">,</span>
      <span class="s1">'d7_node_complete'</span><span class="p">,</span>
      <span class="s1">'d7_menu'</span><span class="p">,</span>
      <span class="s1">'d7_menu_links'</span><span class="p">,</span>
    <span class="p">]);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertNoMigrationMessages</span><span class="p">();</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertCount</span><span class="p">(</span><span class="mi">999</span><span class="p">,</span> <span class="nc">MenuLinkContent</span><span class="o">::</span><span class="nf">loadMultiple</span><span class="p">());</span>
  <span class="p">}</span>

<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="write-a-database-fixture-with-a-test">Write a database fixture with a test!</h2>

<p>I removed the <code class="language-plaintext highlighter-rouge">d7_node_type</code>, <code class="language-plaintext highlighter-rouge">d7_user_role</code>, <code class="language-plaintext highlighter-rouge">d7_user</code> and <code class="language-plaintext highlighter-rouge">d7_node_complete</code> migrations, set a breakpoint after the migrations were executed, and checked how many records I have in the migrate map table of <code class="language-plaintext highlighter-rouge">d7_menu_links</code>: I had 289 messages! I went ahead and updated the count assertion: I want to have all of them migrated.</p>

<p>At this point, I had only one menu link which had been migrated. And almost every other menu link which failed to be migrated had a message in the migrate message table! Most of them (276 out of 283) contained a message like this:</p>

<pre><code class="language-cli">d7_menu_links:link/uri: The path "internal:/node/801" failed validation.
</code></pre>

<p>This customer has more than 2500 nodes. Obviously, I don’t want to sanitize the whole client DB when I publish this work including a test with the database fixture. First, because it is an overhead, and on the other side I don’t want to migrate 2500 nodes (17000 revisions in case of using the complete node migration) just for being able to migrate 289 menu links. I only need the minimal data being available about these nodes. And the very minimal data is <em>their ID</em>. I can get them very easily, by parsing these migration messages!</p>

<ol>
  <li>
    <p>Let’s get the messages! This method was my tool:</p>

    <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="cd">/**
 * Returns the migration messages saved for the specified migration.
 *
 * @param string $plugin_id
 *   The (full) plugin ID of the corresponding migration plugin instance.
 * 
 * @return array[]
 *   The list of the migrate message record properties, containing only the 
 *   message (keyed by its column name 'message').
 */</span>
<span class="k">protected</span> <span class="k">function</span> <span class="n">getMigrationMessages</span><span class="p">(</span><span class="nv">$plugin_id</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$migration</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getMigration</span><span class="p">(</span><span class="nv">$plugin_id</span><span class="p">);</span>
  <span class="nv">$idmap</span> <span class="o">=</span> <span class="nv">$migration</span><span class="o">-&gt;</span><span class="nf">getIdMap</span><span class="p">();</span>
  <span class="nb">assert</span><span class="p">(</span><span class="nv">$idmap</span> <span class="k">instanceof</span> <span class="nc">Sql</span><span class="p">);</span>
   
  <span class="k">return</span> <span class="err">\</span><span class="nc">Drupal</span><span class="o">::</span><span class="nf">database</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="nf">select</span><span class="p">(</span><span class="nv">$idmap</span><span class="o">-&gt;</span><span class="nf">messageTableName</span><span class="p">(),</span> <span class="s1">'m'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">fields</span><span class="p">(</span><span class="s1">'m'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'message'</span><span class="p">])</span>
    <span class="o">-&gt;</span><span class="nf">execute</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="nf">fetchAll</span><span class="p">(</span><span class="err">\</span><span class="no">PDO</span><span class="o">::</span><span class="no">FETCH_ASSOC</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>
    <p>And now, I can get the IDs of those nodes which have a menu link:</p>

    <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre><span class="cd">/**
 * Obtains the required node IDs from the migration messages.
 * 
 * @param array[] $messages
 *   An array of the migrate map table records. At the very minimum, the 
 *   message key must be present (and its value should be the message).
 * 
 * @return int[]
 *   The "missing" node IDs.
 */</span>
<span class="k">protected</span> <span class="k">function</span> <span class="n">getMissingNodeIds</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$messages</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$missing_node_ids</span> <span class="o">=</span> <span class="nb">array_reduce</span><span class="p">(</span>
    <span class="nv">$messages</span><span class="p">,</span>
    <span class="k">function</span> <span class="p">(</span><span class="kt">array</span> <span class="nv">$carry</span><span class="p">,</span> <span class="kt">array</span> <span class="nv">$message_data</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/\sThe path "\w+:\/node\/(\d+).*" failed validation/'</span><span class="p">,</span> <span class="nv">$message_data</span><span class="p">[</span><span class="s1">'message'</span><span class="p">],</span> <span class="nv">$matches</span><span class="p">))</span> <span class="p">{</span>
        <span class="nv">$carry</span><span class="p">[]</span> <span class="o">=</span> <span class="p">(</span><span class="n">int</span><span class="p">)</span> <span class="nv">$matches</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nv">$carry</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="p">[]</span>
  <span class="p">);</span>
  <span class="nv">$missing_node_ids</span> <span class="o">=</span> <span class="nb">array_unique</span><span class="p">(</span><span class="nv">$missing_node_ids</span><span class="p">);</span>
  <span class="nb">natsort</span><span class="p">(</span><span class="nv">$missing_node_ids</span><span class="p">);</span>
  <span class="k">return</span> <span class="nb">array_values</span><span class="p">(</span><span class="nv">$missing_node_ids</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>

    <p>This method returned 210 node IDs. Yes, this number is less than 276, but this difference means that we have some menu links which are pointing to the same node.</p>
  </li>
  <li>
    <p>The next task was adding records of these node IDs into the <code class="language-plaintext highlighter-rouge">node</code> and the <code class="language-plaintext highlighter-rouge">node_revision</code> DB table fixture. So I wrote a new helper method which consumes the list of these node IDs returned by <code class="language-plaintext highlighter-rouge">::getMissingNodeIds()</code>, builds the appropriate data for the fixture, and exports it into a file.</p>

    <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
</pre></td><td class="rouge-code"><pre><span class="cd">/**
 * Saves a developer friendly (but incomplete) node table fixture file.
 * 
 * @param int[] $missing_node_ids
 *   The missing node IDs.
 */</span>
<span class="k">protected</span> <span class="k">function</span> <span class="n">saveToNodeFixture</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$missing_node_ids</span><span class="p">):</span> <span class="kt">void</span> <span class="p">{</span>
  <span class="nv">$raw_data</span> <span class="o">=</span> <span class="nb">array_reduce</span><span class="p">(</span>
    <span class="nv">$missing_node_ids</span><span class="p">,</span>
    <span class="k">function</span> <span class="p">(</span><span class="kt">array</span> <span class="nv">$carry</span><span class="p">,</span> <span class="kt">int</span> <span class="nv">$node_id</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$type</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">'test_type1'</span><span class="p">,</span>
        <span class="s1">'test_type2'</span><span class="p">,</span>
        <span class="s1">'test_type3'</span><span class="p">,</span>
      <span class="p">][</span><span class="nb">random_int</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)];</span>
   
      <span class="nv">$carry</span><span class="p">[</span><span class="nv">$node_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">'nid'</span> <span class="o">=&gt;</span> <span class="nv">$node_id</span><span class="p">,</span>
        <span class="s1">'vid'</span> <span class="o">=&gt;</span> <span class="nv">$node_id</span><span class="p">,</span>
        <span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="nv">$type</span><span class="p">,</span>
        <span class="s1">'language'</span> <span class="o">=&gt;</span> <span class="s1">'und'</span><span class="p">,</span>
        <span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="s2">"Node #</span><span class="si">{</span><span class="nv">$node_id</span><span class="si">}</span><span class="s2"> title"</span><span class="p">,</span>
        <span class="s1">'uid'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">'status'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">'created'</span> <span class="o">=&gt;</span> <span class="mi">1600000000</span> <span class="o">+</span> <span class="nv">$node_id</span><span class="p">,</span>
        <span class="s1">'changed'</span> <span class="o">=&gt;</span> <span class="mi">1600000000</span> <span class="o">+</span> <span class="nv">$node_id</span><span class="p">,</span>
        <span class="s1">'comment'</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">'promote'</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">'sticky'</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">'tnid'</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">'translate'</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
      <span class="p">];</span>
      <span class="k">return</span> <span class="nv">$carry</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="p">[]</span>
  <span class="p">);</span>
   
  <span class="nv">$data_to_save</span> <span class="o">=</span> <span class="nb">array_reduce</span><span class="p">(</span>
    <span class="nv">$raw_data</span><span class="p">,</span>
    <span class="k">function</span> <span class="p">(</span><span class="kt">string</span> <span class="nv">$carry</span><span class="p">,</span> <span class="kt">array</span> <span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$carry</span> <span class="mf">.</span><span class="o">=</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">-&gt;values("</span><span class="p">;</span>
      <span class="nv">$carry</span> <span class="mf">.</span><span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="nc">Variable</span><span class="o">::</span><span class="nf">export</span><span class="p">(</span><span class="nv">$data</span><span class="p">));</span>
      <span class="nv">$carry</span> <span class="mf">.</span><span class="o">=</span> <span class="s1">')'</span><span class="p">;</span>
      <span class="k">return</span> <span class="nv">$carry</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="s2">"&lt;?php</span><span class="se">\n</span><span class="s2">// phpcs:ignoreFile</span><span class="se">\n</span><span class="s2">"</span>
  <span class="p">);</span>
  <span class="nv">$data_to_save</span> <span class="mf">.</span><span class="o">=</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">-&gt;execute();"</span><span class="p">;</span>
   
  <span class="nb">file_put_contents</span><span class="p">(</span><span class="nb">implode</span><span class="p">(</span><span class="no">DIRECTORY_SEPARATOR</span><span class="p">,</span> <span class="p">[</span>
    <span class="nf">drupal_get_path</span><span class="p">(</span><span class="s1">'module'</span><span class="p">,</span> <span class="s1">'migmag_menu_link_migrate'</span><span class="p">),</span>
    <span class="s1">'tests/fixtures'</span><span class="p">,</span>
    <span class="s1">'node-cleaned.php'</span>
  <span class="p">]),</span> <span class="nv">$data_to_save</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>
    <p>And the last step was that I modified the method above to write a fixture for my super-clean <code class="language-plaintext highlighter-rouge">node_revisions</code> table (<code class="language-plaintext highlighter-rouge">node_revisions</code> has slightly different table structure), and re-ran the test.</p>
  </li>
</ol>

<h2 id="profit">Profit</h2>

<p>Basically, that was all. Although I did not dare to delete the original fixture file for a couple of hours, after a while I realized that if I still needed it, I could regenerate it anytime.</p>

<p>And I think I’ll finish this soonish! 🥳</p>]]></content><author><name>Zoltán Horváth</name></author><category term="Development" /><category term="Drupal" /><category term="Migration" /><category term="Testing" /><category term="PHPUnit" /><summary type="html"><![CDATA[How TDD helped creating a minimal test database used for the enhanced menu link migration submodule of Migrate Magician.]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://huzooka.github.io/simple.png" /><media:content medium="image" url="https://huzooka.github.io/simple.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Migrating moderated Drupal 7 content to Drupal 9? There is a module for that!</title><link href="https://huzooka.github.io/development/2021/11/14/workbench-moderation-migrate.html" rel="alternate" type="text/html" title="Migrating moderated Drupal 7 content to Drupal 9? There is a module for that!" /><published>2021-11-14T12:06:43+00:00</published><updated>2021-11-14T12:06:43+00:00</updated><id>https://huzooka.github.io/development/2021/11/14/workbench-moderation-migrate</id><content type="html" xml:base="https://huzooka.github.io/development/2021/11/14/workbench-moderation-migrate.html"><![CDATA[<p class="lead">This August we got a <em>bug report</em> from a customer: They had an issue with the published state of their migrated nodes. Their complaint was that some of their nodes were migrated with the latest revision being active for anyone, while the correct visible revision should have been a previous node version.</p>

<p>We checked their installed Drupal 7 modules, and our suspicion was confirmed: the source site was using <a href="https://www.drupal.org/project/workbench_moderation">Workbench Moderation</a> configured to provide moderation workflows for some of their content types. And at the time we didn’t have any solutions for correctly migrating moderated content to Drupal 9.</p>

<p>I guess you won’t be too surprised if I say that Acquia decided to fund the development of moderated content types and their moderation states. This ended in <a href="https://www.drupal.org/project/workbench_moderation_migrate"><strong>Workbench Moderation Migrate</strong></a>, and I am telling you about how the moderation worked in Drupal 7 and how it works in Drupal 9, and what was the greatest challenge I had to solve in the migration paths.</p>

<h2 id="moderated-content">Moderated content</h2>

<p>The main feature of content moderation consists of the following things:</p>

<ul>
  <li>It provides <em>moderation states</em> a content can be in (<em>Draft</em>, <em>In Review</em>, <em>Published</em>, <em>Archived</em> etc.), and</li>
  <li><em>Transitions</em> between the states; and rules around when a transition can be used on a moderated content, and what state will be applied on the content if the transition is performed.</li>
</ul>

<p>This ecosystem allows you to have a published content version that is live and also have a separate working copy that is undergoes reviewing before it gets published, replacing the previous live content version.</p>

<h3 id="moderated-content-in-drupal7">Moderated content in Drupal 7</h3>

<p>Drupal 7 doesn’t have any support for “forward” (<a href="https://drupal.org/i/2890364">or “pending”</a>): it always checks the revision with the highest revision ID. And users always see (or don’t see) this most recent node version.</p>

<p><a href="https://www.drupal.org/project/workbench_moderation">Drupal 7 Workbench Moderation</a> works around this behavior. Whenever a user creates or edits a non-public draft of an already published node, the module saves a new, published revision which is the clone of the most recent published version. and since the last saved published revision has a higher revision ID than the “pending” version, users will not notice any change. (But in fact they will see a new revision.)</p>

<p>Workbench Moderation tracks the state transitions in its history database table, which contains an incremental history ID, an entity and an entity revision ID, the previous and the new state of the version, and the time when the transition happened.</p>

<p>An example how this works in Drupal 7:</p>

<table caption="Published node revision is #9, which is a clone of #7. But editors are editing #5 (this is what “current” means).">
  <thead>
    <tr>
      <th style="text-align: right">#</th>
      <th style="text-align: left">Action performed</th>
      <th style="text-align: right">Rev. ID</th>
      <th style="text-align: left">From</th>
      <th style="text-align: left">To</th>
      <th style="text-align: center">Public</th>
      <th style="text-align: center"><em>Current</em></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: right">1</td>
      <td style="text-align: left">New node, sent to review</td>
      <td style="text-align: right">1</td>
      <td style="text-align: left"> </td>
      <td style="text-align: left">in_review</td>
      <td style="text-align: center">◯</td>
      <td style="text-align: center">◯</td>
    </tr>
    <tr>
      <td style="text-align: right">2</td>
      <td style="text-align: left">Reviewer publishes</td>
      <td style="text-align: right">2</td>
      <td style="text-align: left">in_review</td>
      <td style="text-align: left">published</td>
      <td style="text-align: center">◯</td>
      <td style="text-align: center">◯</td>
    </tr>
    <tr>
      <td style="text-align: right">3</td>
      <td style="text-align: left">User creates a new draft</td>
      <td style="text-align: right">3</td>
      <td style="text-align: left">published</td>
      <td style="text-align: left">draft</td>
      <td style="text-align: center">◯</td>
      <td style="text-align: center">◯</td>
    </tr>
    <tr>
      <td style="text-align: right">4</td>
      <td style="text-align: left"><em>WBM clones rev. #2</em></td>
      <td style="text-align: right">4</td>
      <td style="text-align: left">published</td>
      <td style="text-align: left">published</td>
      <td style="text-align: center">◯</td>
      <td style="text-align: center">◯</td>
    </tr>
    <tr>
      <td style="text-align: right">5</td>
      <td style="text-align: left">Draft sent to review</td>
      <td style="text-align: right">5</td>
      <td style="text-align: left">draft</td>
      <td style="text-align: left">in_review</td>
      <td style="text-align: center">◯</td>
      <td style="text-align: center">◯</td>
    </tr>
    <tr>
      <td style="text-align: right">6</td>
      <td style="text-align: left"><em>WBM clones rev #4</em></td>
      <td style="text-align: right">6</td>
      <td style="text-align: left">published</td>
      <td style="text-align: left">published</td>
      <td style="text-align: center">◯</td>
      <td style="text-align: center">◯</td>
    </tr>
    <tr>
      <td style="text-align: right">7</td>
      <td style="text-align: left">Pending draft published</td>
      <td style="text-align: right">7</td>
      <td style="text-align: left">in_review</td>
      <td style="text-align: left">published</td>
      <td style="text-align: center">◯</td>
      <td style="text-align: center">◯</td>
    </tr>
    <tr>
      <td style="text-align: right">8</td>
      <td style="text-align: left">New draft</td>
      <td style="text-align: right">8</td>
      <td style="text-align: left">published</td>
      <td style="text-align: left">draft</td>
      <td style="text-align: center">◯</td>
      <td style="text-align: center">◉</td>
    </tr>
    <tr>
      <td style="text-align: right">9</td>
      <td style="text-align: left"><em>WBM clones rev #7</em></td>
      <td style="text-align: right">9</td>
      <td style="text-align: left">published</td>
      <td style="text-align: left">published</td>
      <td style="text-align: center">◉</td>
      <td style="text-align: center">◯</td>
    </tr>
  </tbody>
</table>

<p><small>Published node revision is #9, which is a clone of #7. But editors are editing #5 (this is what “current” means).</small></p>

<h3 id="content-moderation-module-in-drupal9">Content Moderation module in Drupal 9</h3>

<p>Workflows and Content Moderation added to Drupal 8.2.x have clearer foundations: moderated workflows can track and maintain not only the moderation states of content revisions, but they can manage a flag on the revisions. This flag contains the info whether the version is a default revision or not. And Drupal’s Entity API is also aware of this. If an entity specific (and not entity revision specific!) read operation happens, Entity API checks the most recent revision flagged as being default. And this version’s state will determine whether the user can access the content, and if it is a public state, this will be the version they will see.</p>

<p>Here is the equivalent history data of the steps performed from the previous point on Drupal 9:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: right">#</th>
      <th style="text-align: left">Action performed</th>
      <th style="text-align: right">Rev. ID</th>
      <th style="text-align: left">From</th>
      <th style="text-align: left">To</th>
      <th style="text-align: right">Public</th>
      <th style="text-align: right">Default</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: right">1</td>
      <td style="text-align: left">New node, sent to review</td>
      <td style="text-align: right">1</td>
      <td style="text-align: left"> </td>
      <td style="text-align: left">in_review</td>
      <td style="text-align: right">◯</td>
      <td style="text-align: right">◉</td>
    </tr>
    <tr>
      <td style="text-align: right">2</td>
      <td style="text-align: left">Reviewer publishes</td>
      <td style="text-align: right">2</td>
      <td style="text-align: left">in_review</td>
      <td style="text-align: left">published</td>
      <td style="text-align: right">◉</td>
      <td style="text-align: right">◉</td>
    </tr>
    <tr>
      <td style="text-align: right">3</td>
      <td style="text-align: left">User creates a new draft</td>
      <td style="text-align: right">3</td>
      <td style="text-align: left">published</td>
      <td style="text-align: left">draft</td>
      <td style="text-align: right">◯</td>
      <td style="text-align: right">◯</td>
    </tr>
    <tr>
      <td style="text-align: right">4</td>
      <td style="text-align: left">Draft sent to review</td>
      <td style="text-align: right">4</td>
      <td style="text-align: left">draft</td>
      <td style="text-align: left">in_review</td>
      <td style="text-align: right">◯</td>
      <td style="text-align: right">◯</td>
    </tr>
    <tr>
      <td style="text-align: right">5</td>
      <td style="text-align: left">Pending draft published</td>
      <td style="text-align: right">5</td>
      <td style="text-align: left">in_review</td>
      <td style="text-align: left">published</td>
      <td style="text-align: right">◉</td>
      <td style="text-align: right">◉</td>
    </tr>
    <tr>
      <td style="text-align: right">5</td>
      <td style="text-align: left">New pending draft</td>
      <td style="text-align: right">6</td>
      <td style="text-align: left">published</td>
      <td style="text-align: left">in_review</td>
      <td style="text-align: right">◯</td>
      <td style="text-align: right">◯</td>
    </tr>
  </tbody>
</table>

<p>Please note how this new “default” flag works: as long as there is no published version, all versions are “default”. It looks weird at first, but it totally makes sense: if a visitor tries to access the content early on, when only the draft revision #1 exists, Drupal should return a 403 response.</p>

<h2 id="how-can-we-move-this-from-drupal7-to-drupal9">How can we move this from Drupal 7 to Drupal 9?</h2>

<p>You may already have a clue what the solution is: we have to identify which node versions are the clones of a previous published revision, and skip their migration. <a href="https://git.drupalcode.org/project/workbench_moderation_migrate/-/blob/63f033bf/src/ModerationStateMigrate.php#L99-L113">And yes, this is its essence</a>, beside other nits – like being able to identify the first published revision. Unfortunately, it wasn’t this easy to solve.</p>

<p>But I had the first rule I set up: <strong>Clones of a published revision shouldn’t be migrated</strong>.</p>

<h2 id="the-biggest-challenges">The biggest challenges</h2>

<p>Drupal 7 Node + Workbench Moderation allows users to change the state of a revision and even to delete revisions on the revision UI<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup>. It isn’t a big problem if a <em>published version clone</em> was deleted, but in every other case, we will have “holes” in the revision history, and this needs to be bridged somehow.</p>

<h3 id="states-changed-on-revision-ui">States changed on revision UI</h3>

<p>Why is it a problem that the state was changed on the revision UI? Because then Drupal does not create a new revision for the pending draft, so we will have more than one history record for the same revision. This is how it looks (watch out what happens between the sixth and eighth lines):</p>

<table>
  <thead>
    <tr>
      <th style="text-align: right">#</th>
      <th style="text-align: left">Action performed</th>
      <th style="text-align: right">Rev. ID</th>
      <th style="text-align: left">From</th>
      <th style="text-align: left">To</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: right">1</td>
      <td style="text-align: left">New node, sent to review</td>
      <td style="text-align: right">1</td>
      <td style="text-align: left"> </td>
      <td style="text-align: left">in_review</td>
    </tr>
    <tr>
      <td style="text-align: right">2</td>
      <td style="text-align: left">Reviewer approves and publishes</td>
      <td style="text-align: right">2</td>
      <td style="text-align: left">in_review</td>
      <td style="text-align: left">published</td>
    </tr>
    <tr>
      <td style="text-align: right">3</td>
      <td style="text-align: left">Published version was edited</td>
      <td style="text-align: right">3</td>
      <td style="text-align: left">published</td>
      <td style="text-align: left">published</td>
    </tr>
    <tr>
      <td style="text-align: right">4</td>
      <td style="text-align: left">New draft</td>
      <td style="text-align: right">4</td>
      <td style="text-align: left">published</td>
      <td style="text-align: left">draft</td>
    </tr>
    <tr>
      <td style="text-align: right">5</td>
      <td style="text-align: left"><em>WBM clones rev #3</em></td>
      <td style="text-align: right">5</td>
      <td style="text-align: left">published</td>
      <td style="text-align: left">published</td>
    </tr>
    <tr>
      <td style="text-align: right">6</td>
      <td style="text-align: left">New draft sent to review</td>
      <td style="text-align: right"><strong>6</strong></td>
      <td style="text-align: left">draft</td>
      <td style="text-align: left">in_review</td>
    </tr>
    <tr>
      <td style="text-align: right">7</td>
      <td style="text-align: left"><em>WBM clones rev #5</em></td>
      <td style="text-align: right"><strong>7</strong></td>
      <td style="text-align: left">published</td>
      <td style="text-align: left">published</td>
    </tr>
    <tr>
      <td style="text-align: right">8</td>
      <td style="text-align: left">Reviewer sets back to draft on rev. UI</td>
      <td style="text-align: right"><strong>6</strong></td>
      <td style="text-align: left">in_review</td>
      <td style="text-align: left">draft</td>
    </tr>
    <tr>
      <td style="text-align: right">9</td>
      <td style="text-align: left"><em>WBM clones rev #7</em></td>
      <td style="text-align: right"><strong>8</strong></td>
      <td style="text-align: left">published</td>
      <td style="text-align: left">published</td>
    </tr>
    <tr>
      <td style="text-align: right">10</td>
      <td style="text-align: left">Draft sent back ro review</td>
      <td style="text-align: right">9</td>
      <td style="text-align: left">draft</td>
      <td style="text-align: left">in_review</td>
    </tr>
    <tr>
      <td style="text-align: right">11</td>
      <td style="text-align: left"><em>WBM clones rev #9</em></td>
      <td style="text-align: right">10</td>
      <td style="text-align: left">published</td>
      <td style="text-align: left">published</td>
    </tr>
    <tr>
      <td style="text-align: right">12</td>
      <td style="text-align: left">New draft reviewed and published</td>
      <td style="text-align: right">11</td>
      <td style="text-align: left">in_review</td>
      <td style="text-align: left">published</td>
    </tr>
    <tr>
      <td style="text-align: right">13</td>
      <td style="text-align: left">First published rev. is restored</td>
      <td style="text-align: right">12</td>
      <td style="text-align: left">published</td>
      <td style="text-align: left">published</td>
    </tr>
  </tbody>
</table>

<p>This led me to set up the second rule that I applied when I was checking the <em>“from”</em> or the <em>“to” states</em> of a node revision: <strong><em>from state</em> should be fetched from the first history entry, <em>to state</em> should be fetched from the last history entry</strong> of a node revision.</p>

<h3 id="removed-revisions">Removed revisions</h3>

<p>I hope that it is obvious why it is a problem if revisions are deleted. Assume that only revision #4, #6 and #12 are available in the source. These are the only revisions which will be migrated by <code class="language-plaintext highlighter-rouge">d7_node_complete</code>. Just take a look at this history where I removed those history entries whose revision was deleted:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: right">#</th>
      <th style="text-align: left">Action performed</th>
      <th style="text-align: right">Rev. ID</th>
      <th style="text-align: left">From</th>
      <th style="text-align: left">To</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: right">4</td>
      <td style="text-align: left">New draft</td>
      <td style="text-align: right">4</td>
      <td style="text-align: left">published</td>
      <td style="text-align: left">draft</td>
    </tr>
    <tr>
      <td style="text-align: right">6</td>
      <td style="text-align: left">New draft sent to review</td>
      <td style="text-align: right">6</td>
      <td style="text-align: left">draft</td>
      <td style="text-align: left">in_review</td>
    </tr>
    <tr>
      <td style="text-align: right">8</td>
      <td style="text-align: left">Reviewer sets back to draft on rev. UI</td>
      <td style="text-align: right">6</td>
      <td style="text-align: left">in_review</td>
      <td style="text-align: left">draft</td>
    </tr>
    <tr>
      <td style="text-align: right">13</td>
      <td style="text-align: left">First published rev. is restored</td>
      <td style="text-align: right">12</td>
      <td style="text-align: left">published</td>
      <td style="text-align: left">published</td>
    </tr>
  </tbody>
</table>

<p>How can we migrate these to the destination site by retaining the highest level of data integrity?</p>

<p>We can see the connection between the two non-published revision<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup>. But how can we connect the last one’s <em>to state</em> with the last, published revision’s state? We cannot assume that there is a direct transition from <em>draft</em> to <em>published</em>!</p>

<p>In such cases, the solution is a bit sad: <strong>If there is no connection</strong> between the <em>first</em> drafts and the <em>first</em> published version, then we ask <code class="language-plaintext highlighter-rouge">d7_node_complete</code> to <strong>skip migrating the <em>stale</em> drafts</strong>. This was the third rule.</p>

<h3 id="unpublished-nodes-which-were-published-before">Unpublished nodes which were published before</h3>

<p>I want to show another tricky example<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">3</a></sup>:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: right">#</th>
      <th style="text-align: left">Action performed</th>
      <th style="text-align: right">Rev. ID</th>
      <th style="text-align: left">From</th>
      <th style="text-align: left">To</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: right">1</td>
      <td style="text-align: left">New draft sent to review</td>
      <td style="text-align: right">1</td>
      <td style="text-align: left"> </td>
      <td style="text-align: left">in_review</td>
    </tr>
    <tr>
      <td style="text-align: right">2</td>
      <td style="text-align: left">Reviewer publishes</td>
      <td style="text-align: right">2</td>
      <td style="text-align: left">in_review</td>
      <td style="text-align: left">published</td>
    </tr>
    <tr>
      <td style="text-align: right">3</td>
      <td style="text-align: left">New draft</td>
      <td style="text-align: right">3</td>
      <td style="text-align: left">published</td>
      <td style="text-align: left">draft</td>
    </tr>
    <tr>
      <td style="text-align: right">4</td>
      <td style="text-align: left"><em>WBM clones rev #2</em></td>
      <td style="text-align: right">4</td>
      <td style="text-align: left">published</td>
      <td style="text-align: left">published</td>
    </tr>
    <tr>
      <td style="text-align: right">5</td>
      <td style="text-align: left">Unpublished on revision UI</td>
      <td style="text-align: right">4</td>
      <td style="text-align: left">published</td>
      <td style="text-align: left">draft</td>
    </tr>
  </tbody>
</table>

<p>We can migrate rev #1 and #2, but what should we do with #3 and #4? I obviously cannot drop #4 – although it was a clone initially, it became a real transition because this was the published revision which <em>archived</em> the whole content. And on the other hand, if I didn’t migrate it, then the node would be published in Drupal 9, because revision #2 was public, and #3 is only a new, pending revision.</p>

<p>Well, I checked what happens on Drupal 9 if I repeat the same steps there, and there was a big relief: every single moderated content can be archived, even if it has a pending version.</p>

<p>So this transition log migrated into Drupal 9 looks like this :</p>

<table>
  <thead>
    <tr>
      <th style="text-align: right">#</th>
      <th style="text-align: left">Action performed</th>
      <th style="text-align: right">Rev. ID</th>
      <th style="text-align: left">From</th>
      <th style="text-align: left">To</th>
      <th style="text-align: right">Public</th>
      <th style="text-align: right">Default</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: right">1</td>
      <td style="text-align: left">New draft sent to review</td>
      <td style="text-align: right">1</td>
      <td style="text-align: left"> </td>
      <td style="text-align: left">in_review</td>
      <td style="text-align: right">◯</td>
      <td style="text-align: right">◉</td>
    </tr>
    <tr>
      <td style="text-align: right">2</td>
      <td style="text-align: left">Reviewer publishes</td>
      <td style="text-align: right">2</td>
      <td style="text-align: left">in_review</td>
      <td style="text-align: left">published</td>
      <td style="text-align: right">◉</td>
      <td style="text-align: right">◉</td>
    </tr>
    <tr>
      <td style="text-align: right">3</td>
      <td style="text-align: left">New draft</td>
      <td style="text-align: right">3</td>
      <td style="text-align: left">published</td>
      <td style="text-align: left">draft</td>
      <td style="text-align: right">◯</td>
      <td style="text-align: right">◯</td>
    </tr>
    <tr>
      <td style="text-align: right">4</td>
      <td style="text-align: left">Content unpublished</td>
      <td style="text-align: right">4</td>
      <td style="text-align: left">published</td>
      <td style="text-align: left">archive</td>
      <td style="text-align: right">◯</td>
      <td style="text-align: right">◉</td>
    </tr>
  </tbody>
</table>

<hr />

<p><em>Drupal core issues discovered</em>:</p>

<ul>
  <li><a href="https://drupal.org/i/3200949#comment-14014993">#3200949-9</a>: Non-default entity revisions are migrated as default revision because EntityContentComplete does not allow creating forward (and non-default) revisions</li>
  <li><a href="https://drupal.org/i/3052115#comment-14296084">#3052115-32</a>: Mark an entity as ‘syncing’ during a migration ‘update’ and possibly test syncing semantics (no changed item bump, no content moderation revisions)</li>
  <li><a href="https://drupal.org/i/2329253#comment-14239586">#2329253-78</a>: Allow the ChangedItem to skip updating when synchronizing (f.e. when migrating)</li>
</ul>

<hr />

<p><em>Footnotes</em>:</p>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>In these cases, the moderation history table will still contain the history of the node, so we won’t have the revision data available. <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p>Yes, there are <em>three</em> non-public table rows in the table, but two of them were recorded for the <em>same node revision ID</em>. <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:3" role="doc-endnote">
      <p>This represents the typical history entries of the nodes we got the incident notice from the customer about. <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>]]></content><author><name>Zoltán Horváth</name></author><category term="Development" /><category term="Drupal" /><category term="Migration" /><category term="Workbench Moderation" /><category term="Workflows" /><summary type="html"><![CDATA[Why the Workbench Moderation Migrate module works the way it does.]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://huzooka.github.io/simple.png" /><media:content medium="image" url="https://huzooka.github.io/simple.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Find Test Output Saved by Drupal CI’s Jenkins Server</title><link href="https://huzooka.github.io/development/2021/10/20/drupalci-output.html" rel="alternate" type="text/html" title="Find Test Output Saved by Drupal CI’s Jenkins Server" /><published>2021-10-20T19:09:12+00:00</published><updated>2021-10-20T19:09:12+00:00</updated><id>https://huzooka.github.io/development/2021/10/20/drupalci-output</id><content type="html" xml:base="https://huzooka.github.io/development/2021/10/20/drupalci-output.html"><![CDATA[<p class="lead">It happens very rarely that a functional test runs successfully on our local environment, but it fails on the <a href="https://www.drupal.org/drupalorg/docs/drupal-ci">Drupal CI</a> Jenkins server. But sometimes it does. Fortunately, the CI server saves all the important output of the test run (log files, configurations), including the HTML files of the drupal pages visited during the Browser and Webdriver tests.</p>

<p>You can download the entire test artifact as well, but usually I only want to check the HTML output. This is how we can find and check these HTML files in the browser:</p>

<ol>
  <li>
    <p>Click the link of the test you want to check:</p>

    <p class="figure"><img src="/files/image/DrupalCI-0.png" alt="" /></p>
  </li>
  <li>
    <p>Click on “View results on dispatcher”:</p>

    <p class="figure"><img src="/files/image/DrupalCI-1-view-results.png" alt="" /></p>
  </li>
  <li>
    <p>Click “Build Artifacts”:</p>

    <p class="figure"><img src="/files/image/DrupalCI-2-build-artifacts.png" alt="" /></p>

    <p>From this point, you will browse the directories and the files of the test artifact.</p>
  </li>
  <li>
    <p>Click the “artifact” directory’s link:</p>

    <p class="figure"><img src="/files/image/DrupalCI-3-artifacts.png" alt="" /></p>
  </li>
  <li>
    <p>Select the task of which output you want to check. If the project uses the <a href="https://www.drupal.org/drupalorg/docs/drupal-ci/customizing-drupalci-testing-for-projects#s-build-definition-organization">default build definition</a> and the <a href="https://git.drupalcode.org/project/drupal/blob/HEAD/core/drupalci.yml">default drupalci.yml configuration</a>, then the output of the Webdriver (aka FunctionalJavascript) tests can be found in the <code class="language-plaintext highlighter-rouge">run_tests.js</code> directory; every other PHPUnit test’s output will be in the <code class="language-plaintext highlighter-rouge">run_tests.standard</code> dir<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup>. Pick the one you want to check:</p>

    <p class="figure"><img src="/files/image/DrupalCI-4-run-tests.png" alt="" /></p>
  </li>
  <li>
    <p>The HTML output we are usually looking for can be found in the <code class="language-plaintext highlighter-rouge">simpletest_html</code> directory.</p>

    <p class="figure"><img src="/files/image/DrupalCI-5-simpletest-html.png" alt="" /></p>
  </li>
</ol>

<p><strong>There they are!</strong></p>

<p class="figure"><img src="/files/image/DrupalCI-6-whoala.png" alt="" /></p>

<p>Happy coding!</p>

<hr />

<p><em>Footnotes</em>:</p>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>These directory names are the same as the key of the corresponding job. <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>]]></content><author><name>Zoltán Horváth</name></author><category term="Development" /><category term="Drupal" /><category term="Drupal CI" /><category term="Jenkins" /><summary type="html"><![CDATA[How to find the HTML file output saved during testing on Drupal CI’s Jenkins server.]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://huzooka.github.io/simple.png" /><media:content medium="image" url="https://huzooka.github.io/simple.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Drupal’s Menu Link Migration Mess</title><link href="https://huzooka.github.io/development/2021/09/21/menu-link-migration-mess.html" rel="alternate" type="text/html" title="Drupal’s Menu Link Migration Mess" /><published>2021-09-21T10:35:13+00:00</published><updated>2021-09-21T10:35:13+00:00</updated><id>https://huzooka.github.io/development/2021/09/21/menu-link-migration-mess</id><content type="html" xml:base="https://huzooka.github.io/development/2021/09/21/menu-link-migration-mess.html"><![CDATA[<p class="lead">We recently got a bug report from a customer: their menu links weren’t migrated from their Drupal 7 site to Drupal 9. They had some links which were, but unfortunately the majority of their links were gone.</p>

<p>After some digging we saw that the client had a very complex menu tree, including more menu levels, with various types of links.</p>

<h2 id="why-did-this-happen-to-them">Why did this happen to them?</h2>

<p>In core’s <code class="language-plaintext highlighter-rouge">d7_menu_link</code> migration we cannot create stub <code class="language-plaintext highlighter-rouge">menu_link_content</code> entities. But this is essential if the menu link we migrate has a parent menu link.</p>

<p>Let’s assume that this menu link structure is our source:</p>

<pre><code class="language-cli"># An example menu tree

Main menu
─────────
├─&lt;LINK#2&gt;(blog node/1)
│ │
│ └─&lt;LINK#1&gt;(blog node/2)
│
├─&lt;LINK#3&gt;(blog node/3)
│ │
│ └─&lt;LINK#4&gt;(article node/4)
│
└─&lt;LINK#5&gt;(node/add or a views page link)
  │
  ├─&lt;LINK#6&gt;(user/6)
  │
  └─&lt;LINK#7&gt;(blog node/7)
</code></pre>

<h3 id="problem-1">Problem #1</h3>

<p>If the menu link we want to migrate isn’t a custom or customized menu link, then the menu link cannot be migrated. This is because core only migrates custom or customized menu links (<a href="https://git.drupalcode.org/project/drupal/-/blob/45a503ab/core/modules/menu_link_content/src/Plugin/migrate/source/MenuLink.php#L25-L27">custom menu link condition here</a>, <a href="https://git.drupalcode.org/project/drupal/-/blob/45a503ab/core/modules/menu_link_content/src/Plugin/migrate/source/MenuLink.php#L29">customized condition here</a>.</p>

<h3 id="problem-2">Problem #2</h3>

<p>By default, the URI’s of the migrated menu links <a href="https://git.drupalcode.org/project/drupal/-/blob/45a503ab/core/modules/menu_link_content/src/Plugin/migrate/process/LinkUri.php#L119">are validated</a>. This means that if we try to stub a menu link’s parent menu link (e.g. a node, or views page) that’s target isn’t available, then the migration will be skipped.</p>

<p>Example: We cannot migrate <code class="language-plaintext highlighter-rouge">&lt;LINK#6&gt;</code> or <code class="language-plaintext highlighter-rouge">&lt;LINK#7&gt;</code>, because their parent menu link’s target won’t be available ever (there is no source row for <code class="language-plaintext highlighter-rouge">&lt;LINK#5&gt;</code>).</p>

<h3 id="problem-3">Problem #3</h3>

<p>A menu link source in <code class="language-plaintext highlighter-rouge">d7_menu_links</code> might be skipped for a valid reason, for example because it is migrated in <code class="language-plaintext highlighter-rouge">d7_menu_links_localized</code>, or by <code class="language-plaintext highlighter-rouge">node_translation_menu_links</code>.</p>

<h3 id="problem-4">Problem #4</h3>

<p><code class="language-plaintext highlighter-rouge">d7_menu_links</code> got a new <a href="https://git.drupalcode.org/project/drupal/-/blob/45a503ab/core/modules/menu_link_content/src/Plugin/migrate/source/MenuLink.php#L99">source property <code class="language-plaintext highlighter-rouge">'skip_translation'</code></a> (<strong>Achtung!</strong> Misleading var name!)<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup> recently. This source property is calculated and added in the MenuLink source plugin’s <code class="language-plaintext highlighter-rouge">prepareRow</code> method. And then, if a particular menu link’s <code class="language-plaintext highlighter-rouge">skip_translation</code> property is equal to a boolean FALSE, then the menu link’s migration will be skipped.</p>

<p>I have to repeat this again, making super-clean what happens:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">skip_translation == TRUE</code> → We will try to migrate the menu link.</li>
  <li><code class="language-plaintext highlighter-rouge">skip_translation == FALSE</code> (or <code class="language-plaintext highlighter-rouge">NULL</code>, <code class="language-plaintext highlighter-rouge">0</code>, <code class="language-plaintext highlighter-rouge">'0'</code>, <code class="language-plaintext highlighter-rouge">''</code> etc) → we don’t migrate</li>
</ul>

<p>Since core’s underlying stub service doesn’t invoke the migrate source plugin’s prepareRow method, this means that whenever a menu link has a parent menu link which isn’t yet migrated, then the current migration code cannot create a stub entity for the <em>not-yet-migrated</em> parent menu link, because <code class="language-plaintext highlighter-rouge">'skip_translation'</code> will be <code class="language-plaintext highlighter-rouge">NULL</code> (MigrateExecutable checks source properties by calling <code class="language-plaintext highlighter-rouge">$row-&gt;get(&lt;property&gt;)</code> <a href="https://git.drupalcode.org/project/drupal/-/blob/45a503ab/core/modules/migrate/src/Row.php#L136-L157">which returns null for missing properties</a>.</p>

<h2 id="tasks-to-solve">Tasks to solve</h2>

<h3 id="idea-addressing-1-and-2">Idea addressing #1 and #2</h3>

<p>We should try disabling route validation, and then:</p>

<ul>
  <li>
    <p>The MenuLink source plugin should include every source item what is used as the parent ID of customized menu links</p>

    <p><strong>or</strong></p>
  </li>
  <li>
    <p>We need to make it possible to create stubs for missing source records (I don’t know if Migrate API provides any infra for this)</p>
  </li>
</ul>

<h3 id="idea-addressing-3">Idea addressing #3</h3>

<p><a href="https://git.drupalcode.org/project/drupal/-/blob/45a503ab/core/modules/migrate/src/Plugin/migrate/process/MenuLinkParent.php#L144">MenuLinkParent process plugin</a> should collect every migration that’s destination is a <code class="language-plaintext highlighter-rouge">menu_link_content</code> entity (but not an entity translation), filter out migrations whose “Drupal #” tag does not match with the current migration’s tag, and then try to create a stub in every matching migration (derivative).</p>

<h3 id="idea-addressing-4">Idea addressing #4</h3>

<p>Since <a href="https://git.drupalcode.org/project/migmag/-/blob/1.2.x/migmag_process/src/MigMagMigrateStub.php"><em>Migrate Magician’s</em> MigMagMigrateStub service</a> invokes <code class="language-plaintext highlighter-rouge">MigrateSourceInterface::prepareRow </code>(so it returns a fully prepared source Row), using that service in MenuLinkParent instead of the original one would solve this issue.</p>

<h2 id="the-solution">The Solution</h2>

<p>We completely rewrote the process pipeline of the parent destination property in every related menu link migration:</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre></td><td class="rouge-code"><pre> id: d7_menu_links
 [...]
 process:
 [...]
   weight: weight
   expanded: expanded
   enabled: enabled
<span class="gi">+  parent_uuid:
+    -
+      plugin: skip_on_empty
+      source: plid
+      method: process
+    -
+      plugin: migmag_lookup
+      source: plid
+      default_values:
+        menu_name: '@menu_name'
+      migration:
+        - 'd7_menu_links'
+        - 'd7_menu_links_localized'
+        - 'd7_menu_links_translation'
+        - 'node_translation_menu_links'
+      fallback_stub_id: missing_menu_link_trap
+    -
+      plugin: migmag_get_entity_property
+      entity_type_id: 'menu_link_content'
+      property: uuid
</span>  parent:
<span class="gd">-    plugin: menu_link_parent
-    source:
-      - plid
-      - '@menu_name'
-      - parent_link_path
</span><span class="gi">+    -
+      plugin: default_value
+      source: '@parent_uuid'
+      default_value: null
+    -
+      plugin: skip_on_empty
+      method: process
+    -
+      plugin: concat
+      source:
+        - 'constants/plugin_prefix'
+        - '@parent_uuid'
+      delimiter: ':'
</span>   changed: updated
 destination:
   plugin: entity:menu_link_content
   no_stub: true
</pre></td></tr></tbody></table></code></pre></div></div>

<p>You can see that we dropped out the <code class="language-plaintext highlighter-rouge">menu_link_parent</code> process plugin. To get the parent menu link content entity’s ID we <a href="/development/2021/07/26/migmag-lookup.html">use <code class="language-plaintext highlighter-rouge">migmag_lookup</code> instead</a>. And we also wrote another plugin which <a href="https://git.drupalcode.org/project/migmag/-/blob/1.2.x/migmag_process/src/Plugin/migrate/process/MigMagGetEntityProperty.php">loads the given entity and returns one of its properties</a>.</p>

<p>You may notice that a weirdly named migration plugin ID is used as a fallback migration for creating stubs: <code class="language-plaintext highlighter-rouge">missing_menu_link_trap</code>. This migration is used for creating stubs for missing parent menu links:</p>

<div data-file="./migrations/missing_menu_link_trap.yml" class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td><td class="rouge-code"><pre><span class="na">id</span><span class="pi">:</span> <span class="s">missing_menu_link_trap</span>
<span class="na">source</span><span class="pi">:</span>
  <span class="na">plugin</span><span class="pi">:</span> <span class="s">embedded_data</span>
  <span class="na">data_rows</span><span class="pi">:</span> <span class="pi">[]</span>
  <span class="na">ids</span><span class="pi">:</span>
    <span class="na">mlid</span><span class="pi">:</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
  <span class="na">source_module</span><span class="pi">:</span> <span class="s">menu</span>
  <span class="na">constants</span><span class="pi">:</span>
    <span class="na">bundle</span><span class="pi">:</span> <span class="s">menu_link_content</span>
    <span class="na">langcode</span><span class="pi">:</span> <span class="s">und</span>
    <span class="na">title</span><span class="pi">:</span> <span class="s1">'</span><span class="s">(missing</span><span class="nv"> </span><span class="s">menu</span><span class="nv"> </span><span class="s">link</span><span class="nv"> </span><span class="s">stubbed</span><span class="nv"> </span><span class="s">by</span><span class="nv"> </span><span class="s">AMA)'</span>
    <span class="na">url</span><span class="pi">:</span> <span class="s1">'</span><span class="s">route:&lt;none&gt;'</span>
    <span class="na">options</span><span class="pi">:</span> <span class="pi">{}</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">menu_name_placeholder</span><span class="pi">:</span> <span class="s1">'</span><span class="s">'</span>
<span class="na">process</span><span class="pi">:</span>
  <span class="c1"># Trap should ignore mlid = 0.</span>
  <span class="na">id</span><span class="pi">:</span>
    <span class="na">plugin</span><span class="pi">:</span> <span class="s">skip_on_empty</span>
    <span class="na">source</span><span class="pi">:</span> <span class="s">mlid</span>
    <span class="na">method</span><span class="pi">:</span> <span class="s">row</span>
  <span class="na">langcode</span><span class="pi">:</span> <span class="s1">'</span><span class="s">constants/langcode'</span>
  <span class="na">bundle</span><span class="pi">:</span> <span class="s1">'</span><span class="s">constants/bundle'</span>
  <span class="na">title</span><span class="pi">:</span> 
    <span class="na">plugin</span><span class="pi">:</span> <span class="s">concat</span>
    <span class="na">source</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">mlid</span>
      <span class="pi">-</span> <span class="s1">'</span><span class="s">constants/title'</span>
    <span class="na">delimiter</span><span class="pi">:</span> <span class="s1">'</span><span class="nv"> </span><span class="s">'</span>
  <span class="c1"># Menu name will be set by migmag_lookup.</span>
  <span class="na">menu_name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">constants/menu_name_placeholder'</span>
  <span class="s1">'</span><span class="s">link/uri'</span><span class="err">:</span> <span class="s1">'</span><span class="s">constants/url'</span>
  <span class="s1">'</span><span class="s">link/options'</span><span class="err">:</span> <span class="s1">'</span><span class="s">constants/options'</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="s1">'</span><span class="s">constants/enabled'</span>
<span class="na">destination</span><span class="pi">:</span>
  <span class="na">plugin</span><span class="pi">:</span> <span class="s">entity:menu_link_content</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>And basically, with these changes, our customer was able to proceed, and migrate their menu links, and their complex link structure to Drupal 9, and we haven’t seen any failed rows in their map tables anymore!</p>

<hr />

<p><em>Footnotes</em>:</p>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>The correct property name should be <code class="language-plaintext highlighter-rouge">do_not_skip_because_this_is_not_translated</code>. <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>]]></content><author><name>Zoltán Horváth</name></author><category term="Development" /><category term="Drupal" /><category term="Migration" /><category term="Migration Lookup" /><summary type="html"><![CDATA[Why some menu links cannot be migrated with Drupal core migrations.]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://huzooka.github.io/simple.png" /><media:content medium="image" url="https://huzooka.github.io/simple.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">The Magical Migration Lookup Plugin</title><link href="https://huzooka.github.io/development/2021/07/26/migmag-lookup.html" rel="alternate" type="text/html" title="The Magical Migration Lookup Plugin" /><published>2021-07-26T23:58:51+00:00</published><updated>2021-07-26T23:58:51+00:00</updated><id>https://huzooka.github.io/development/2021/07/26/migmag-lookup</id><content type="html" xml:base="https://huzooka.github.io/development/2021/07/26/migmag-lookup.html"><![CDATA[<p class="hl">This post is a copy of the <a href="https://www.drupal.org/docs/contributed-modules/migrate-magician/migrate-magician-process-plugins-110/migmaglookup">MigMagLookup documentation</a> on Drupal.org</p>

<p class="lead"><a href="https://git.drupalcode.org/project/migmag/-/blob/1.1.x/migmag_process/src/Plugin/migrate/process/MigMagLookup.php#L105">MigMagLookup (<code class="language-plaintext highlighter-rouge">migmag_lookup</code>)</a> is a Drupal core compatible migration lookup plugin which creates migration stubs only for existing source IDs, and which is able to identify which migration should create the stub entity.</p>

<h2 id="why-might-you-need-this-plugin">Why might you need this plugin?</h2>

<p>Drupal core’s <a href="https://www.drupal.org/docs/contributed-modules/migrate-magician/migrate-magician-process-plugins-110/migmaglookup#:~:text=Drupal%20core%27s%20migration_lookup"><code class="language-plaintext highlighter-rouge">migration_lookup</code> migrate process plugin</a> has some limitations in regard of content stubbing which cannot be worked around (imho):</p>

<ul>
  <li>Core’s <code class="language-plaintext highlighter-rouge">MigrationLookup</code> is not able to identify which migration contains a source record (row) with the matching IDs.</li>
  <li>Because of this, it creates stubs entities with the wrong migrations – for example in the current migration. Or, if the current migration isn’t specified in the given lookup migrations configuration, then in the first lookup migration.</li>
  <li>The plugin <a href="https://www.drupal.org/project/drupal/issues/3156730">might create stubs which aren’t represented in the lookup migration(s) source</a> (we call them “invalid stubs”). These stubs can’t ever be updated, because they don’t exist in the source data.</li>
  <li>The plugin cannot create stubs from partial (not fully specified) source row IDs</li>
  <li>You cannot pass destination property values to the migrate stub service, although it would be able to handle them appropriately.</li>
</ul>

<p>However, <a href="https://git.drupalcode.org/project/migmag/-/blob/1.1.x/migmag_process/src/Plugin/migrate/process/MigMagLookup.php">MigMagLookup</a> overcomes the limitations above:</p>

<ul>
  <li><em>MigMagLookup</em> is able to identify which migrations may contain the row specified with the source plugin IDs.</li>
  <li>Because of this, it is able to create stubs in the <strong>right</strong> migrations. If the row specified with its source IDs can be found in more lookup migrations, then it creates stubs for every matching source record…</li>
  <li>…so it creates only valid stubs.</li>
  <li>Stub creation only fails if the underlying migration plugin instance makes it to fail, because it invokes <code class="language-plaintext highlighter-rouge">SourcePluginInterface::prepareRow()</code></li>
  <li>From version <code class="language-plaintext highlighter-rouge">1.2.0</code>, you <strong>can</strong> pass destination property values to the migrate stub service with the <code class="language-plaintext highlighter-rouge">stub_default_values</code> configuration. The configuration is an array of row properties, keyed by the stub migration’s destination properties. Row properties are fetched from the host migration’s row.</li>
  <li>And the best one: it is able to create stubs based on not-fully-specified source row IDs. If you need the destination ID of a node (e.g. referenced from an entity reference field), you only have to use the information you have from the original field value: the ID of the source node. You don’t have to worry about how to get a revision ID (or a language code) if you are looking for only the migrated node’s ID.</li>
</ul>

<p>If you specify the stub migration ID (which should store the stub) with the <code class="language-plaintext highlighter-rouge">stub_id</code> configuration key, then the original behavior is kept, so if you’re unlucky (or you want to do so), you might have invalid stubs.</p>

<p>If you want to create invalid stubs only when none of the provided lookup migrations contain the specified source record, you should specify the fallback stub migration’s plugin ID with the <code class="language-plaintext highlighter-rouge">fallback_stub_id</code> configuration key.</p>

<p>Some <a href="https://www.drupal.org/docs/contributed-modules/migrate-magician/migrate-magician-process-plugins-110/migmaglookup#s-examples">usage examples can be found on the documentation page</a>.</p>]]></content><author><name>Zoltán Horváth</name></author><category term="Development" /><category term="Drupal" /><category term="Migration" /><category term="Migration Lookup" /><summary type="html"><![CDATA[The migration lookup plugin that creates migration stubs only for existing source IDs and is able to identify which migration should create the stub.]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://huzooka.github.io/simple.png" /><media:content medium="image" url="https://huzooka.github.io/simple.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Lessons Learned with Bean Migrate</title><link href="https://huzooka.github.io/development/2021/03/25/bean-migration.html" rel="alternate" type="text/html" title="Lessons Learned with Bean Migrate" /><published>2021-03-25T23:58:51+00:00</published><updated>2021-03-25T23:58:51+00:00</updated><id>https://huzooka.github.io/development/2021/03/25/bean-migration</id><content type="html" xml:base="https://huzooka.github.io/development/2021/03/25/bean-migration.html"><![CDATA[<p class="lead"><a href="https://drupal.org/project/bean_migrate">Bean Migrate</a> is the next <em>migration path</em> module founded by Acquia. Drupal 7 Bean does not have a Drupal 8+ release, because the majority of its features are available in Drupal 8+, provided by the Custom Block module.</p>

<p><a href="https://drupal.org/node/1149602">Drupal 7 Bean</a> is basically the ancestor of the <a href="https://www.drupal.org/node/2826149">Custom Block module</a>. It allows users to create blocks of content (these are <em>bean</em> entities). Bean entities can have fields, view modes; they are revisionable; and can be placed into regions like blocks provided by other modules.</p>

<h2 id="dont-change-the-value-a-source-identifier">Don’t change the value a source identifier</h2>

<p>You shouldn’t ever change the value of a source property which is a source identifier. <a href="https://drupal.org/i/3199290">I did that</a>. In every <code class="language-plaintext highlighter-rouge">d7_field*</code> migration, if the value of the <code class="language-plaintext highlighter-rouge">entity_type</code> was bean, I changed it to <code class="language-plaintext highlighter-rouge">block_content</code>. Then we saw that the fields which were already migrated (and which weren’t touched on the source) are considered as not-yet migrated source items. And when we tried to re-import them, the operation ended up in an <code class="language-plaintext highlighter-rouge">EntityStorageException</code> complaining about duplicate IDs.</p>

<p>Why did this happen? Well, Migrate API assumes that these identifier properties aren’t changed during the migration. And this is not necessarily a bug. (I mean, I can live with that.)</p>

<p>What actually happens is that <a href="https://git.drupalcode.org/project/drupal/-/blob/9.2.x/core/modules/migrate/src/MigrateExecutable.php#L202">MigrateExecutable gets the source IDs of the row</a> before any processing happens. It also uses these early values when it tries to <a href="https://git.drupalcode.org/project/drupal/-/blob/9.2.x/core/modules/migrate/src/MigrateExecutable.php#L226">check whether the ID map plugin tracks any destination IDs</a> about the current source. But when the successfully imported row’s data is saved by the ID map plugin, it does not access these early-evaluated source IDs: <a href="https://git.drupalcode.org/project/drupal/-/blob/9.2.x/core/modules/migrate/src/MigrateExecutable.php#L233">it only gets the fully processed Row</a>. So it will fetch the source IDs from this object.</p>

<p>And if you have changed these IDs, then it will save the changed source IDs.</p>

<h2 id="never-ever-modify-the-process-pipeline-of-a-migration-at-the-prepare-row-phase">Never-ever modify the process pipeline of a migration at the <em>prepare row</em> phase</h2>

<p>If you do so, you will get bug reports like this: <a href="https://www.drupal.org/project/bean_migrate/issues/3205133">#3205133</a> Migrated field configurations and view modes get wrong entity type of <code class="language-plaintext highlighter-rouge">block_content</code></p>

<p>And it is so obvious… I don’t even know why I didn’t have any doubts about that! If you change the process pipelines on certain conditions, you will have to restore the original state right after the conditions aren’t met.</p>

<p>It’s just more clear, robust, less confusing and maintainable if you solve these issues by adding more process plugin configuration to the process pipeline you want to modify in a <code class="language-plaintext highlighter-rouge">hook_migration_plugins_alter()</code> implementation.</p>

<h2 id="core-sometimes-does-pointless-things">Core sometimes does pointless things</h2>

<p>The issues I had to report to core:</p>

<ol>
  <li>
    <p><a href="https://drupal.org/i/3200936">#3200936</a> DX: Block (config) destination shouldn’t recalculate block config ID for block translations</p>
  </li>
  <li>
    <p><a href="https://drupal.org/i/3200949">#3200949</a> Non-default entity revisions are migrated as default revision because EntityContentComplete does not allow creating forward (and non-default) revisions</p>
  </li>
</ol>

<h2 id="some-features-are-still-missing-from-core-migrate-api">Some features are still missing from core Migrate API</h2>

<p>Initially I tried to migrate the block placements (aka Block configuration entities) by modifying Drupal core’s d7_block migration. But unfortunately, it isn’t customizable at all, mostly because of the <a href="https://git.drupalcode.org/project/drupal/-/blob/9.2.x/core/modules/block/src/Plugin/migrate/process/BlockPluginId.php"><code class="language-plaintext highlighter-rouge">BlockPluginId</code> process plugin</a> (and on the other hand because of the <a href="https://git.drupalcode.org/project/drupal/-/blob/9.2.x/core/modules/block/migrations/d7_block.yml#L26-L61">process pipeline of the <code class="language-plaintext highlighter-rouge">plugin</code> destination property</a> in the <code class="language-plaintext highlighter-rouge">d7_block</code> migration).</p>

<p>The process plugin was designed to be used in this process pipeline, and the process pipeline was built on the top of this process plugin. 😳</p>

<p><code class="language-plaintext highlighter-rouge">BlockPluginId</code> <a href="https://git.drupalcode.org/project/drupal/-/blob/9.2.x/core/modules/block/src/Plugin/migrate/process/BlockPluginId.php#L98">shouldn’t reset the source value</a> if it is an array and it does not fit in any case statements; it should return the incoming value without any changes.</p>

<p>And instead of the last <code class="language-plaintext highlighter-rouge">skip_on_empty</code> process, there should be another process plugin which skips the migration of the actual row if it cannot find a block plugin ID based on the value it gets:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="cd">/**
 * Checks whether the source value is a valid block plugin ID.
 * 
 * @return string
 */</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">transform</span><span class="p">(</span><span class="nv">$value</span><span class="p">,</span> <span class="kt">MigrateExecutableInterface</span> <span class="nv">$migrate_executable</span><span class="p">,</span> <span class="kt">Row</span> <span class="nv">$row</span><span class="p">,</span> <span class="nv">$destination_property</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$value</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="nc">PluginBase</span><span class="o">::</span><span class="no">DERIVATIVE_SEPARATOR</span><span class="p">,</span> <span class="p">(</span><span class="k">array</span><span class="p">)</span> <span class="nv">$value</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">blockPluginManager</span><span class="o">-&gt;</span><span class="nf">hasDefinition</span><span class="p">(</span><span class="nv">$value</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nc">MigrateSkipRowException</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nv">$value</span><span class="p">;</span>
<span class="p">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>]]></content><author><name>Zoltán Horváth</name></author><category term="Development" /><category term="Drupal" /><category term="Migration" /><category term="Situation report" /><summary type="html"><![CDATA[Some words about the problems I ran into while developing the module.]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://huzooka.github.io/simple.png" /><media:content medium="image" url="https://huzooka.github.io/simple.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry></feed>